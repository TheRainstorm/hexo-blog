---
title: 2023-07-23-捡垃圾-rk3399 DIY KVM
date: 2023-07-23 10:49
tags:
  - KVM
  - rk3399
  - armbian
categories:
  - homelab
  - 设备
---

由于我的台式机承载了NAS，做种，Jellyfin，博客，文件同步等功能，已然成为一台服务器，因此其可靠性非常重要。但是我还是经历过几次由于网络故障导致其无法访问的情形，此时则只能去实验室维护比较麻烦，因此需要一个IPMI的管理功能，使得网络出故障情况下也能远程访问。

而家用PC主板很少有支持IPMI功能的，支持的板子一般都要2000元以上。因此需要一个成本低廉的方案，在网上搜索一阵后发现确实有基于树莓派DIY的方案，并且有一个比较大的开源项目PI-KVM。

然而由于树莓派400-500昂贵的价格，使得DIY的成本仍然很高。直到我看到使用普通arm板子的方案。甚至可以使用40元的电视盒子。因此价格完全可以保证在200元以内，我觉的是一个可以接受的方案。

最后成本
- king3399开发板：咸鱼120
- ms2130 USB采集卡，支持1080p 60帧：淘宝 60

<!-- more -->

## 开发板

RK3399是Rockchip（瑞芯微）出的一款SoC，在此基础上，许多开发板厂商设计了自己的开发板。

### rk3399硬件资源

主要特点
- 网络：
  - 千兆以太网
  - 支持wifi+蓝牙
- 内部存储
  - BootROM(32KB)：支持从SPI、eMMC、SD/MMC接口启动
  - Internal SRAM(200KB)：Support security and non-security access
- 片外存储
  - 板载eMMC(16G)
  - 支持SD/MMC
- 两个OTG usb接口
- PCIe1.0 M.2 (Bkey)
  - Mini PCIe为LTE模块专用接口，板载SIM卡座，实现IOT应用

![](https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20230125170545.png)

### 已知的开发板及资料

#### Firefly

Firefly：中山市天启智能科技有限公司于2014年创立的开源团队，致力于人工智能、智能硬件、嵌入式开发、系统开发、应用程序开发等研发，拥有开源系列产品、开源社区与网上商城。Firefly 开源产品包括核心板、行业主板、行业整机、集群服务器、开发套件、Station等产品。

资料最全的开发板，厂家有自己的网站，提供详细教程。
[1. 介绍 — Firefly Wiki (t-firefly.com)](https://wiki.t-firefly.com/zh_CN/Firefly-RK3399/01-bootmode.html)

#### king3399

容品深圳电子科技
从咸鱼购买，卖家提供了原厂的详细文档，包含：SDK（适配的buildroot, ubuntu, debian, Android源码，以及编译方法），编译好的镜像，硬件datasheet等

[瑞芯微 King3399 扩展板 - 深圳荣品电子科技有限公司 (rpdzkj.com)](http://www.rpdzkj.com/1703937-1703937_2520299.html)

#### tn3399_v3

深圳市天诺

github上有人折腾出的资料，也支持刷许多系统了：[lanseyujie/tn3399_v3: TN3399_V3 开发板折腾记录 (github.com)](https://github.com/lanseyujie/tn3399_v3/)

#### 其它
- RK平台资料收集：[Xianlee's Log (lightembedded.com)](http://wiki.lightembedded.com/#!library/rk3399/common.md)

## 方案讨论

### 基本方案

[DIY 一个运维神器 Open IP-KVM - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/578602475)
这种方案如何呢：  
1.使用CH9329+CH340模拟鼠标键盘  
2.HDMI-USB视频采集卡获取图像  
3.ARM开发板安装Linux系统  
4.GPIO扩展板控制目标电脑的开关机引脚实现开关机  
5.采用远程光驱镜像共享技术。客户端选择安装的光盘镜像,通过IP-KVM网络发送到开发板。开发板接收到后,通过iSCSI等网络协议,将该光盘镜像挂载为目标电脑的一块虚拟光盘。目标电脑可以对该虚拟光盘进行引导和安装操作

### ARM-KVM
[b 站看到 IPKVM 的一个方案，请教下怎么实现 - V2EX](https://www.v2ex.com/t/932953)
- [「教程」廉价的运维神器 ArmKVM 安装与使用_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV19V4y1t7zU/?vd_source=b01257db06b1514b2fb50663dd339833)
- [ArmKVM 官方文档 (moeneko.xyz)](https://armkvm.moeneko.xyz/docs/#/)
- B站作者已经把它商业量产了，但是售价330起
  - CPU是全志H610，感觉什么都缩水了，除了板子是新的外，相比于自己买二手开发板DIY没有性价比。
  - 而且系统也不知道是什么，感觉可玩性比较差

### 基于Armbian的PI-KVM
- 将PI-KVM移植到了Armbian系统上
- [打造普通PC拥有服务器IPMI硬件级别的远程运维方案 PI KVM 硬件级远程控制_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1pM4y1x7ce/?spm_id_from=333.1007.top_right_bar_window_history.content.click&vd_source=b01257db06b1514b2fb50663dd339833)
  - 教程 https://github.com/toss-a/pikvm-armbian/blob/master/README-zh-CN.MD
- 作者的仓库：[srepac/kvmd-armbian: KVMD For Armbian Install Script (github.com)](https://github.com/srepac/kvmd-armbian)

只需要开发板可以刷Armbian的镜像，硬件有支持OTG的USB接口即可。非常适合自己DIY的方案

## king3399刷机

### 教程链接

[2022 年新鲜矿渣，荣品 king3399 Linux 刷机教程与性能测试 - YouTube](https://www.youtube.com/watch?v=8Z2DG-r6AzM)
[King3399/荣品3399刷机教程 - 心语博客 (vpset.com)](https://vpset.com/9.html)

### 刷原厂镜像vs第三方

开发板厂家提供的SDK包中会包含原厂镜像，像Firefly则可以从官网下载。
刷原厂镜像：
- 优点
  - 经过厂家测试，比较稳定
  - 刷机比较容易
- 缺点
  - 可能支持的内核版本比较低
  - 镜像选择性比较少。可能厂家只适配了debian,ubuntu镜像。

- 要支持Armbian，openwrt等其它操作系统需要自己移植编译，一般需要板子的dtb，可以从原厂系统中提取。通常网上有大佬移植过了
- king3399厂家提供了以下系统镜像
  - linux
    - ubuntu(18.04)
    - debian(buster 10)
  - android: 7, 8, 10

### 刷机方法

Rockchip平台刷机方法汇总：[Xianlee's Log (lightembedded.com)](http://wiki.lightembedded.com/#!library/rkcommon/flash.md)

#### 基本知识

##### **镜像文件**
- 通常包含以下几部分
  - **bootloader**（如uboot）
  - kernel（linux kernel）
  - rootfs（ubuntu, debian等不同发行版都是该部分不同）
- 并且各部分所处**地址空间**分区是SoC厂商分配好的。
  - 对于开发板这种设备，CPU启动时会从片上的一小块boot ROM启动，作为第0级引导。之后再从eMMC, SD卡等设备加载引导程序启动。因此镜像文件包含以上全部部分，只需要将镜像完整写入外部存储。计算机启动时便会从正确位置开始引导启动
  - 对于路由器刷openwrt，CPU通常从flash启动。因此刷系统时一般只会刷flash中kernel + rootfs分区。因为保留原厂bootloader可以保证之后可以通过原厂工具恢复原厂系统。同时flash中一些分区还包含网卡MAC地址等信息，因此不能修改。
- buildroot项目可以很方便的定制bootloader, kernel, rootfs这三部分，生成定制化的系统镜像

##### boot ROM
- 开发板这种设备有片上boot ROM的好处就是，不用担心变砖。
> Firefly-RK3399 有灵活的启动方式。一般情况下，除非硬件损坏，Firefly-RK3399 开发板是不会变砖的。如果在升级过程中出现意外，bootloader 损坏，导致无法重新升级，此时仍可以进入 `MaskRom` 模式来修复。

##### 刷入介质

要看SoC支持直接从哪些位置启动，一般支持SD/tf, eMMC。从其余存储介质启动可能需要先将bootloader写入板载存储，然后再将剩余镜像写入其它存储

> ROCK-5B 在主板上有一个 SPI 闪存，将引导加载程序安装到 SPI 闪存可以支持 SoC maskrom 模式不直接支持的其他启动介质（如 SATA、USB3 或 NVMe）
> https://github.com/ophub/amlogic-s9xxx-armbian/blob/main/build-armbian/documents/README.cn.md#8213-%E5%AE%89%E8%A3%85%E7%B3%BB%E7%BB%9F%E8%87%B3-nvme

将镜像写入SD卡这种外部存储比较容易
  - [Rufus - Create bootable USB drives the easy way](https://rufus.ie/en/)
  - [balenaEtcher - Flash OS images to SD cards & USB drives](https://etcher.balena.io/)

但是要将镜像写入板载的eMMC存储则需要专门的工具
- 一般这种板载存储都有官方开发工具可以直接写。比如Rochchip提供了RKDevTool，通过USB连接上位机和开发板，开发板启动时，boot ROM可以接受从USB获得loader启动，之后再从USB获得数据，最后写入eMMC
- 也可以买一个USB-eMMC的转接器，直接写
  - 刷路由器时，我就买了一个写flash的工具。

#### RKDevTool使用

几种启动模式
- Normal：Normal 模式就是正常的启动过程，各个组件依次加载，正常进入系统。
- Loader：在 Loader 模式下，bootloader 会进入升级状态，等待主机命令，用于固件升级等。
- MaskRom：MaskRom 模式用于 bootloader 损坏时的系统修复。
  - 一般情况下是不用进入 `MaskRom 模式`的，只有在 bootloader 校验失败（读取不了 IDB 块，或 bootloader 损坏） 的情况下，BootRom 代码 就会进入此模式。此时 BootRom 代码等待主机通过 USB 接口传送 bootloader 代码，加载并运行之。当板子变砖无法正常启动或升级程序时，也可以手动进入`MaskRom 模式`.

简单来说，如果eMMC上有好的bootloader，则启动后按住板子上的update按键就会进入loader模式，等待从USB获得镜像升级
没有的话，就会进入Maskrom模式，可以通过工具直接写整个eMMC。不过此时上位机要提供两个文件
- loader文件，boot rom加载后引导
- 要刷入eMMC的系统镜像

板载16G eMMC，写应该有40MB/s，所以刷机速度还是很快的。

踩坑经历
- 想直接从原厂镜像升级为armbian镜像，发现选择镜像直接就报错误。
  - 现在觉得是二者bootloader不一样，导致无法直接升级。
- 然后想通过maskrom模式，按地址0写入armbian镜像即可，结果不行。
  - 原来是需要额外一个loader文件，该文件在armbian的github仓库中有
  - 我的gihtub issue[瑞芯微开发工具加载固件失败 · Issue #1562 · ophub/amlogic-s9xxx-armbian (github.com)](https://github.com/ophub/amlogic-s9xxx-armbian/issues/1562)

### RK3399启动过程探明

- Rockchip官方文档：[Boot option - Rockchip open source Document (rock-chips.com)](https://opensource.rock-chips.com/wiki_Boot_option)

ATF：[ARM Trusted Firmware分析——启动、PSCI、OP-TEE接口 - ArnoldLu - 博客园 (cnblogs.com)](https://www.cnblogs.com/arnoldlu/p/14175126.html))
- arm处理器有这个功能，涉及ARM特权级如ELF0（普通应用）, ELF1（kernel）,ELF2(hypervisor)
- 主要涉及到BL1(bootrom) -> BL2(pre-loader) -> BL3x -> uboot -> kernel
- BL1 - AP Trusted ROM，一般为BootRom。
- BL2 - **Trusted Boot Firmware**，一般为Trusted Bootloader。
- BL31 - EL3 Runtime Firmware，一般为SML，管理SMC执行处理和中断，运行在secure monitor中。
- BL32 - Secure-EL1 Payload，一般为TEE OS Image。
- BL33 - **Non-Trusted Firmware**，一般为uboot、linux kernel。

![](https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20230822222531.png)

#### bootflow

```
+--------+----------------+----------+-------------+---------+
| Boot   | Terminology #1 | Actual   | Rockchip    | Image   |
| stage  |                | program  |  Image      | Location|
| number |                | name     |   Name      | (sector)|
+--------+----------------+----------+-------------+---------+
| 1      |  Primary       | ROM code | BootRom     |         |
|        |  Program       |          |             |         |
|        |  Loader        |          |             |         |
|        |                |          |             |         |
| 2      |  Secondary     | U-Boot   |idbloader.img| 0x40    | pre-loader
|        |  Program       | TPL/SPL  |             |         |
|        |  Loader (SPL)  |          |             |         |
|        |                |          |             |         |
| 3      |  -             | U-Boot   | u-boot.itb  | 0x4000  | including u-boot and atf
|        |                |          | uboot.img   |         | only used with miniloader
|        |                |          |             |         |
|        |                | ATF/TEE  | trust.img   | 0x6000  | only used with miniloader
|        |                |          |             |         |
| 4      |  -             | kernel   | boot.img    | 0x8000  |
|        |                |          |             |         |
| 5      |  -             | rootfs   | rootfs.img  | 0x40000 |
+--------+----------------+----------+-------------+---------+
```

Then when we talking about boot from eMMC/SD/U-Disk/net, they are in different concept:
- Stage 1 is always in boot rom, it loads stage 2 and may load stage 3(when SPL_BACK_TO_BROM option enabled).
- Boot from SPI flash means firmware for stage 2 and 3(SPL and U-Boot only) in SPI flash and stage 4/5 in other place;
- Boot from eMMC means all the firmware(including stage 2, 3, 4, 5) in eMMC;
- Boot from SD card means all the firmware(including stage 2, 3, 4, 5) in SD card;
- Boot from U-Disk means firmware for stage 4 and 5(not including SPL and U-Boot) in Disk, optionally only including stage 5;
- Boot from net/tftp means firmeware for stage 4 and 5(not including SPL and U-Boot) on the network;

Boot Flow 1 is typical Rockchip boot flow with Rockchip miniloader;  
Boot Flow 2 is used for most SoCs with U-Boot TPL for ddr init and SPL for trust(ATF/OP-TEE) load and run into next stage;

![rockchip boot](https://opensource.rock-chips.com/images/thumb/c/cd/Rockchip_bootflow20181122.jpg/1342px-Rockchip_bootflow20181122.jpg)

## Armbian

### 介绍

[armbian]([Armbian – Linux for ARM development boards](https://www.armbian.com/))是兼容debian的专门针对各种arm开发板进行优化维护的发行版。由于更新比较即时，因此甚至可能比原厂镜像更加稳定。

和Raspberry Pi OS, debian/arm对比：
- [Compared: Raspberry Pi OS vs. Armbian vs. Debian GNU/Linux (linuxhint.com)](https://linuxhint.com/raspberry-pi-os-vs-armbian-vs-debian-gnu-linux/)
- [Armbian doc faq: what-is-the-difference-between-armbian-and-debianubuntu](https://docs.armbian.com/#what-is-the-difference-between-armbian-and-debianubuntu)

### amlogic-s9xxx-armbian项目

Armbian官方并没有直接支持king3399（是支持Firefly的）

[ophub/amlogic-s9xxx-armbian: Support for Armbian in Amlogic, Rockchip and Allwinner boxes. Support a311d, s922x, s905x3, s905x2, s912, s905d, s905x, s905w, s905, s905l, rk3588, rk3568, rk3399, rk3328, h6, etc. (github.com)](https://github.com/ophub/amlogic-s9xxx-armbian)

- 适配king3399的提交：[Add support for king3399 by 13584452567 · Pull Request #1080 · ophub/amlogic-s9xxx-armbian (github.com)](https://github.com/ophub/amlogic-s9xxx-armbian/pull/1080)

armbian官方文档关于rk3399的一些注释，比如显卡只在4.4内核上正常工作[Rockchip - Armbian Documentation](https://docs.armbian.com/Hardware_Rockchip/)

### 使用

- 官方文档很全了：[Armbian Documentation](https://docs.armbian.com/)
- network：[How to switch from Network Manager to systemd-networkd on Linux (xmodulo.com)](https://www.xmodulo.com/switch-from-networkmanager-to-systemd-networkd.html)

连接wifi的简单方法
```
armbian-config   # 配置整个系统，甚至可以编辑dts

nmtui
```

## Armbian PI-KVM安装

- [打造普通PC拥有服务器IPMI硬件级别的远程运维方案 PI KVM 硬件级远程控制_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1pM4y1x7ce/?spm_id_from=333.1007.top_right_bar_window_history.content.click&vd_source=b01257db06b1514b2fb50663dd339833)
  - 教程 https://github.com/toss-a/pikvm-armbian/blob/master/README-zh-CN.MD
- 作者的仓库：[srepac/kvmd-armbian: KVMD For Armbian Install Script (github.com)](https://github.com/srepac/kvmd-armbian)

### 遇到的问题
#### KVM没有画面

发现买的ms2130在linux下，usb3.0无法工作。只能usb接口插入一半，使其成为2.0时，linux下才能正常工作。

```
/usr/bin/ustreamer --device=/dev/kvmd-video --persistent --format=mjpeg --resolution=1280x720 --desired-fps=40 --drop-same-frames=30 --last-as-blank=0 --unix=/run/kvmd/ustreamer.sock --unix-rm --unix-mode=0660 --exit-on-parent-death --process-name-prefix=kvmd/streamer --notify-parent --no-log-colors --sink=kvmd::ustreamer::jpeg --sink-mode=0660 --slowdown
```

```
Jul 23 09:18:17 king3399 kvmd[382354]: kvmd.apps.kvmd.streamer           INFO --- => -- INFO  [36009.992    stream] -- Device fd=9 opened
Jul 23 09:18:17 king3399 kvmd[382354]: kvmd.apps.kvmd.streamer           INFO --- => -- ERROR [36009.992    stream] -- Video capture is not supported by device
Jul 23 09:18:17 king3399 kvmd[382354]: kvmd.apps.kvmd.streamer           INFO --- => -- INFO  [36009.992    stream] -- Device fd=9 closed
```

dmesg
```
[Sat Jul 22 23:18:09 2023] ehci-platform fe380000.usb: EHCI Host Controller
[Sat Jul 22 23:18:09 2023] ehci-platform fe380000.usb: new USB bus registered, assigned bus number 1
[Sat Jul 22 23:18:09 2023] ehci-platform fe380000.usb: irq 70, io mem 0xfe380000
[Sat Jul 22 23:18:09 2023] ehci-platform fe3c0000.usb: EHCI Host Controller
[Sat Jul 22 23:18:09 2023] ehci-platform fe3c0000.usb: new USB bus registered, assigned bus number 2
[Sat Jul 22 23:18:09 2023] ehci-platform fe3c0000.usb: irq 71, io mem 0xfe3c0000

[Sat Jul 22 23:18:09 2023] ehci-platform fe380000.usb: USB 2.0 started, EHCI 1.00
[Sat Jul 22 23:18:09 2023] usb usb1: New USB device found, idVendor=1d6b, idProduct=0002, bcdDevice= 6.01
[Sat Jul 22 23:18:09 2023] usb usb1: New USB device strings: Mfr=3, Product=2, SerialNumber=1
[Sat Jul 22 23:18:09 2023] usb usb1: Product: EHCI Host Controller
[Sat Jul 22 23:18:09 2023] usb usb1: Manufacturer: Linux 6.1.39-ophub ehci_hcd
[Sat Jul 22 23:18:09 2023] usb usb1: SerialNumber: fe380000.usb
[Sat Jul 22 23:18:09 2023] hub 1-0:1.0: USB hub found
[Sat Jul 22 23:18:09 2023] hub 1-0:1.0: 1 port detected
[Sat Jul 22 23:18:09 2023] usb usb2: New USB device found, idVendor=1d6b, idProduct=0002, bcdDevice= 6.01
[Sat Jul 22 23:18:09 2023] usb usb2: New USB device strings: Mfr=3, Product=2, SerialNumber=1
[Sat Jul 22 23:18:09 2023] usb usb2: Product: EHCI Host Controller
[Sat Jul 22 23:18:09 2023] usb usb2: Manufacturer: Linux 6.1.39-ophub ehci_hcd
[Sat Jul 22 23:18:09 2023] usb usb2: SerialNumber: fe3c0000.usb
[Sat Jul 22 23:18:09 2023] hub 2-0:1.0: USB hub found
[Sat Jul 22 23:18:09 2023] hub 2-0:1.0: 1 port detected

[Sat Jul 22 23:18:10 2023] ohci-platform fe3a0000.usb: Generic Platform OHCI controller
[Sat Jul 22 23:18:10 2023] ohci-platform fe3e0000.usb: Generic Platform OHCI controller
[Sat Jul 22 23:18:10 2023] ohci-platform fe3a0000.usb: new USB bus registered, assigned bus number 3
[Sat Jul 22 23:18:10 2023] ohci-platform fe3a0000.usb: irq 78, io mem 0xfe3a0000
[Sat Jul 22 23:18:10 2023] ohci-platform fe3e0000.usb: new USB bus registered, assigned bus number 4
[Sat Jul 22 23:18:10 2023] ohci-platform fe3e0000.usb: irq 79, io mem 0xfe3e0000
[Sat Jul 22 23:18:10 2023] OF: graph: no port node found in /i2c@ff3d0000/fusb302@22

[Sat Jul 22 23:18:10 2023] usb usb3: New USB device found, idVendor=1d6b, idProduct=0001, bcdDevice= 6.01
[Sat Jul 22 23:18:10 2023] usb usb3: New USB device strings: Mfr=3, Product=2, SerialNumber=1
[Sat Jul 22 23:18:10 2023] usb usb3: Product: Generic Platform OHCI controller
[Sat Jul 22 23:18:10 2023] usb usb3: Manufacturer: Linux 6.1.39-ophub ohci_hcd
[Sat Jul 22 23:18:10 2023] usb usb3: SerialNumber: fe3a0000.usb
[Sat Jul 22 23:18:10 2023] hub 3-0:1.0: USB hub found
[Sat Jul 22 23:18:10 2023] hub 3-0:1.0: 1 port detected
[Sat Jul 22 23:18:10 2023] usb usb4: New USB device found, idVendor=1d6b, idProduct=0001, bcdDevice= 6.01
[Sat Jul 22 23:18:10 2023] usb usb4: New USB device strings: Mfr=3, Product=2, SerialNumber=1
[Sat Jul 22 23:18:10 2023] usb usb4: Product: Generic Platform OHCI controller
[Sat Jul 22 23:18:10 2023] usb usb4: Manufacturer: Linux 6.1.39-ophub ohci_hcd
[Sat Jul 22 23:18:10 2023] usb usb4: SerialNumber: fe3e0000.usb
[Sat Jul 22 23:18:10 2023] hub 4-0:1.0: USB hub found
[Sat Jul 22 23:18:10 2023] hub 4-0:1.0: 1 port detected
```

插在tianyi笔记本上，内核有识别到
```
# dmesg
[Sun Jul 23 01:19:21 2023] usb 1-4: new high-speed USB device number 6 using xhci_hcd
[Sun Jul 23 01:19:21 2023] usb 1-4: New USB device found, idVendor=345f, idProduct=2130, bcdDevice=21.00
[Sun Jul 23 01:19:21 2023] usb 1-4: New USB device strings: Mfr=1, Product=5, SerialNumber=7
[Sun Jul 23 01:19:21 2023] usb 1-4: Product: USB2 Video
[Sun Jul 23 01:19:21 2023] usb 1-4: Manufacturer: MACROSILICON
[Sun Jul 23 01:19:21 2023] usb 1-4: SerialNumber: 20210621
[Sun Jul 23 01:19:21 2023] usb 1-4: Found UVC 1.00 device USB2 Video (345f:2130)
[Sun Jul 23 01:19:21 2023] usbcore: registered new interface driver usbhid
[Sun Jul 23 01:19:21 2023] usbhid: USB HID core driver
[Sun Jul 23 01:19:21 2023] usbcore: registered new interface driver snd-usb-audio
[Sun Jul 23 01:19:21 2023] hid-generic 0003:345F:2130.0001: hiddev0,hidraw0: USB HID v1.10 Device [MACROSILICON USB2 Video] on usb-0000:00:14.0-4/input4

# lsusb
...
Bus 001 Device 006: ID 345f:2130 MACROSILICON USB2 Video
```


![](https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20230723093807.png)


```
[Sun Jul 23 10:17:35 2023] configfs-gadget.kvmd gadget.0: End Point Request ERROR: -108
[Sun Jul 23 10:17:35 2023] configfs-gadget.kvmd gadget.0: End Point Request ERROR: -108
[Sun Jul 23 10:17:35 2023] configfs-gadget.kvmd gadget.0: End Point Request ERROR: -108
```

```
v4l2-ctl --list-devices
v4l2-ctl --list-formats-ext
```

#### 键盘不工作

插拔时，ryzen上dmesg看到以下信息。web中键盘不工作
```
[Tue Oct  3 18:28:12 2023] usb usb3-port3: attempt power cycle
[Tue Oct  3 18:28:12 2023] usb 3-3: new full-speed USB device number 16 using xhci_hcd
[Tue Oct  3 18:28:12 2023] usb 3-3: Device not responding to setup address.
[Tue Oct  3 18:28:13 2023] usb 3-3: Device not responding to setup address.
[Tue Oct  3 18:28:13 2023] usb 3-3: device not accepting address 16, error -71
```

重启开发板后，正常
```
[Tue Oct  3 18:28:23 2023] usb 3-3: new high-speed USB device number 18 using xhci_hcd
[Tue Oct  3 18:28:23 2023] usb 3-3: New USB device found, idVendor=1d6b, idProduct=0104, bcdDevice= 1.00
[Tue Oct  3 18:28:23 2023] usb 3-3: New USB device strings: Mfr=1, Product=2, SerialNumber=3
[Tue Oct  3 18:28:23 2023] usb 3-3: Product: Composite KVM Device
[Tue Oct  3 18:28:23 2023] usb 3-3: Manufacturer: PiKVM
[Tue Oct  3 18:28:23 2023] usb 3-3: SerialNumber: CAFEBABE
[Tue Oct  3 18:28:23 2023] input: PiKVM Composite KVM Device as /devices/pci0000:00/0000:00:08.1/0000:0a:00.3/usb3/3-3/3-3:1.0/0003:1D6B:0104.0006/input/input7
[Tue Oct  3 18:28:23 2023] hid-generic 0003:1D6B:0104.0006: input,hidraw0: USB HID v1.01 Keyboard [PiKVM Composite KVM Device] on usb-0000:0a:00.3-3/input0
```
### 采集卡

#### ms2109
```
[Tue Jul 25 14:54:59 2023] usb 1-3: new high-speed USB device number 8 using xhci_hcd
[Tue Jul 25 14:55:06 2023] usb 1-3: new high-speed USB device number 9 using xhci_hcd
[Tue Jul 25 14:55:06 2023] usb 1-3: New USB device found, idVendor=1de1, idProduct=f105, bcdDevice= 4.09
[Tue Jul 25 14:55:06 2023] usb 1-3: New USB device strings: Mfr=1, Product=2, SerialNumber=3
[Tue Jul 25 14:55:06 2023] usb 1-3: Product: Display capture-UVC05
[Tue Jul 25 14:55:06 2023] usb 1-3: Manufacturer: Actions Micro
[Tue Jul 25 14:55:06 2023] usb 1-3: SerialNumber: -1877663977
[Tue Jul 25 14:55:06 2023] usb 1-3: Found UVC 1.00 device Display capture-UVC05 (1de1:f105)
[Tue Jul 25 14:55:06 2023] usb 1-3: Warning! Unlikely big volume range (=7248), cval->res is probably wrong.
[Tue Jul 25 14:55:06 2023] usb 1-3: [3] FU [Mic Capture Volume] ch = 1, val = -7264/-16/1


➜  ~ v4l2-ctl --list-formats-ext
ioctl: VIDIOC_ENUM_FMT
        Type: Video Capture

        [0]: 'MJPG' (Motion-JPEG, compressed)
                Size: Discrete 1920x1080
                        Interval: Discrete 0.017s (60.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.067s (15.000 fps)
                        Interval: Discrete 0.017s (60.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.067s (15.000 fps)
                Size: Discrete 1360x768
                        Interval: Discrete 0.017s (60.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.067s (15.000 fps)
                Size: Discrete 1280x1024
                        Interval: Discrete 0.017s (60.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.067s (15.000 fps)
                Size: Discrete 1280x960
                        Interval: Discrete 0.017s (60.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.067s (15.000 fps)
                Size: Discrete 1280x720
                        Interval: Discrete 0.017s (60.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.067s (15.000 fps)
                Size: Discrete 1024x768
                        Interval: Discrete 0.017s (60.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.067s (15.000 fps)
                Size: Discrete 800x600
                        Interval: Discrete 0.017s (60.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.067s (15.000 fps)
                Size: Discrete 720x576
                        Interval: Discrete 0.017s (60.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.067s (15.000 fps)
                Size: Discrete 720x480
                        Interval: Discrete 0.017s (60.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.067s (15.000 fps)
                Size: Discrete 640x480
                        Interval: Discrete 0.017s (60.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.067s (15.000 fps)


➜  ~ v4l2-ctl --all
Driver Info:
        Driver name      : uvcvideo
        Card type        : Display capture-UVC05: Display
        Bus info         : usb-0000:02:00.0-3
        Driver version   : 5.15.99
        Capabilities     : 0x84a00001
                Video Capture
                Metadata Capture
                Streaming
                Extended Pix Format
                Device Capabilities
        Device Caps      : 0x04200001
                Video Capture
                Streaming
                Extended Pix Format
Media Driver Info:
        Driver name      : uvcvideo
        Model            : Display capture-UVC05: Display
        Serial           : -1877663977
        Bus info         : usb-0000:02:00.0-3
        Media version    : 5.15.99
        Hardware revision: 0x00000409 (1033)
        Driver version   : 5.15.99
Interface Info:
        ID               : 0x03000002
        Type             : V4L Video
Entity Info:
        ID               : 0x00000001 (1)
        Name             : Display capture-UVC05: Display
        Function         : V4L2 I/O
        Flags            : default
        Pad 0x01000007   : 0: Sink
          Link 0x0200000d: from remote pad 0x100000a of entity 'Processing 2' (Video Pixel Formatter): Data, Enabled, Immutable
Priority: 2
Video input : 0 (Camera 1: ok)
Format Video Capture:
        Width/Height      : 1920/1080
        Pixel Format      : 'MJPG' (Motion-JPEG)
        Field             : None
        Bytes per Line    : 0
        Size Image        : 3110400
        Colorspace        : sRGB
        Transfer Function : Rec. 709
        YCbCr/HSV Encoding: ITU-R 601
        Quantization      : Default (maps to Full Range)
        Flags             :
Crop Capability Video Capture:
        Bounds      : Left 0, Top 0, Width 1920, Height 1080
        Default     : Left 0, Top 0, Width 1920, Height 1080
        Pixel Aspect: 1/1
Selection Video Capture: crop_default, Left 0, Top 0, Width 1920, Height 1080, Flags:
Selection Video Capture: crop_bounds, Left 0, Top 0, Width 1920, Height 1080, Flags:
Streaming Parameters Video Capture:
        Capabilities     : timeperframe
        Frames per second: 60.000 (60/1)
        Read buffers     : 0

Camera Controls

                  auto_exposure 0x009a0901 (menu)   : min=0 max=3 default=0 value=0 (Auto Mode)
                                0: Auto Mode
```


#### ms2130

```
➜  ~ sudo dmesg --color=always -W
[264156.578383] usb 2-3: new SuperSpeed USB device number 2 using xhci_hcd
[264156.614502] usb 2-3: LPM exit latency is zeroed, disabling LPM.
[264156.639256] usb 2-3: New USB device found, idVendor=345f, idProduct=2130, bcdDevice=31.00
[264156.641654] usb 2-3: New USB device strings: Mfr=1, Product=2, SerialNumber=3
[264156.644154] usb 2-3: Product: USB3 Video
[264156.646540] usb 2-3: Manufacturer: MACROSILICON
[264156.648972] usb 2-3: SerialNumber: 20210623
[264156.676445] usb 2-3: Found UVC 1.00 device USB3 Video (345f:2130)
[264156.735960] hid-generic 0003:345F:2130.000F: hiddev0,hidraw0: USB HID v1.10 Device [MACROSILICON USB3 Video] on usb-0000:02:00.0-3/input4

Bus 002 Device 002: ID 345f:2130 MACROSILICON USB3 Video

➜  ~ v4l2-ctl --list-formats-ext
ioctl: VIDIOC_ENUM_FMT
        Type: Video Capture

        [0]: 'YUYV' (YUYV 4:2:2)
                Size: Discrete 3840x2160
                        Interval: Discrete 0.056s (18.000 fps)
                Size: Discrete 2560x1600
                        Interval: Discrete 0.020s (50.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.050s (20.000 fps)
                        Interval: Discrete 0.100s (10.000 fps)
                Size: Discrete 2560x1440
                        Interval: Discrete 0.020s (50.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.050s (20.000 fps)
                        Interval: Discrete 0.100s (10.000 fps)
                Size: Discrete 2048x1152
                        Interval: Discrete 0.017s (60.000 fps)
                        Interval: Discrete 0.020s (50.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.050s (20.000 fps)
                        Interval: Discrete 0.100s (10.000 fps)
                Size: Discrete 2048x1080
                        Interval: Discrete 0.017s (60.000 fps)
                        Interval: Discrete 0.020s (50.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.050s (20.000 fps)
                        Interval: Discrete 0.100s (10.000 fps)
                Size: Discrete 1920x2160
                        Interval: Discrete 0.017s (60.000 fps)
                        Interval: Discrete 0.020s (50.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.050s (20.000 fps)
                        Interval: Discrete 0.100s (10.000 fps)
                Size: Discrete 1920x1200
                        Interval: Discrete 0.017s (60.000 fps)
                        Interval: Discrete 0.020s (50.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.050s (20.000 fps)
                        Interval: Discrete 0.100s (10.000 fps)
                Size: Discrete 1920x1080
                        Interval: Discrete 0.017s (60.000 fps)
                        Interval: Discrete 0.020s (50.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.050s (20.000 fps)
                        Interval: Discrete 0.100s (10.000 fps)
                Size: Discrete 1360x768
                        Interval: Discrete 0.017s (60.000 fps)
                        Interval: Discrete 0.020s (50.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.050s (20.000 fps)
                        Interval: Discrete 0.100s (10.000 fps)
                Size: Discrete 1280x1024
                        Interval: Discrete 0.017s (60.000 fps)
                        Interval: Discrete 0.020s (50.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.050s (20.000 fps)
                        Interval: Discrete 0.100s (10.000 fps)
                Size: Discrete 1280x960
                        Interval: Discrete 0.017s (60.000 fps)
                        Interval: Discrete 0.020s (50.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.050s (20.000 fps)
                        Interval: Discrete 0.100s (10.000 fps)
                Size: Discrete 1280x720
                        Interval: Discrete 0.017s (60.000 fps)
                        Interval: Discrete 0.020s (50.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.050s (20.000 fps)
                        Interval: Discrete 0.100s (10.000 fps)
                Size: Discrete 1024x768
                        Interval: Discrete 0.017s (60.000 fps)
                        Interval: Discrete 0.020s (50.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.050s (20.000 fps)
                        Interval: Discrete 0.100s (10.000 fps)
                Size: Discrete 720x480
                        Interval: Discrete 0.017s (60.000 fps)
                        Interval: Discrete 0.020s (50.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.050s (20.000 fps)
                        Interval: Discrete 0.100s (10.000 fps)
                Size: Discrete 640x480
                        Interval: Discrete 0.017s (60.000 fps)
                        Interval: Discrete 0.020s (50.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.050s (20.000 fps)
                        Interval: Discrete 0.100s (10.000 fps)
        [1]: 'MJPG' (Motion-JPEG, compressed)
                Size: Discrete 3840x2160
                        Interval: Discrete 0.056s (18.000 fps)
                Size: Discrete 2560x1600
                Size: Discrete 2560x1440
                        Interval: Discrete 0.020s (50.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.050s (20.000 fps)
                        Interval: Discrete 0.100s (10.000 fps)
                Size: Discrete 2048x1152
                        Interval: Discrete 0.017s (60.000 fps)
                        Interval: Discrete 0.020s (50.000 fps)
                        Interval: Discrete 0.033s (30.000 fps)
                        Interval: Discrete 0.050s (20.000 fps)
                        Interval: Discrete 0.100s (10.000 fps)
                Size: Discrete 2048x1080
                Size: Discrete 1920x2160
                Size: Discrete 1920x1200
                Size: Discrete 1920x1080
                Size: Discrete 1360x768
                Size: Discrete 1280x1024
                Size: Discrete 1280x960
```

出问题
```
➜  ~ sudo dmesg --color=always --ctime -W
[Tue Jul 25 16:47:39 2023] usb 1-3: new high-speed USB device number 29 using xhci_hcd
[Tue Jul 25 16:47:39 2023] usb 1-3: New USB device found, idVendor=345f, idProduct=2130, bcdDevice=21.00
[Tue Jul 25 16:47:39 2023] usb 1-3: New USB device strings: Mfr=1, Product=5, SerialNumber=7
[Tue Jul 25 16:47:39 2023] usb 1-3: Product: USB2 Video
[Tue Jul 25 16:47:39 2023] usb 1-3: Manufacturer: MACROSILICON
[Tue Jul 25 16:47:39 2023] usb 1-3: SerialNumber: 20210621
[Tue Jul 25 16:47:39 2023] usb 1-3: Found UVC 1.00 device USB2 Video (345f:2130)
[Tue Jul 25 16:47:39 2023] hid-generic 0003:345F:2130.0012: hiddev0,hidraw0: USB HID v1.10 Device [MACROSILICON USB2 Video] on usb-0000:02:00.0-3/input4
[Tue Jul 25 16:47:39 2023] usb 1-3: USB disconnect, device number 29
[Tue Jul 25 16:47:49 2023] usb usb2-port3: Cannot enable. Maybe the USB cable is bad?
[Tue Jul 25 16:47:53 2023] usb 1-3: new high-speed USB device number 31 using xhci_hcd
[Tue Jul 25 16:47:53 2023] usb usb2-port3: Cannot enable. Maybe the USB cable is bad?
[Tue Jul 25 16:47:57 2023] usb usb2-port3: Cannot enable. Maybe the USB cable is bad?
[Tue Jul 25 16:48:01 2023] usb usb2-port3: Cannot enable. Maybe the USB cable is bad?
[Tue Jul 25 16:48:05 2023] usb usb2-port3: Cannot enable. Maybe the USB cable is bad?
[Tue Jul 25 16:48:09 2023] usb usb2-port3: Cannot enable. Maybe the USB cable is bad?
[Tue Jul 25 16:48:20 2023] usb 1-3: new high-speed USB device number 32 using xhci_hcd
[Tue Jul 25 16:48:21 2023] usb 1-3: New USB device found, idVendor=345f, idProduct=2130, bcdDevice=21.00
[Tue Jul 25 16:48:21 2023] usb 1-3: New USB device strings: Mfr=1, Product=5, SerialNumber=7
[Tue Jul 25 16:48:21 2023] usb 1-3: Product: USB2 Video
[Tue Jul 25 16:48:21 2023] usb 1-3: Manufacturer: MACROSILICON
[Tue Jul 25 16:48:21 2023] usb 1-3: SerialNumber: 20210621
[Tue Jul 25 16:48:21 2023] usb 1-3: Found UVC 1.00 device USB2 Video (345f:2130)
[Tue Jul 25 16:48:21 2023] hid-generic 0003:345F:2130.0013: hiddev0,hidraw0: USB HID v1.10 Device [MACROSILICON USB2 Video] on usb-0000:02:00.0-3/input4
[Tue Jul 25 16:50:24 2023] usb 1-3: USB disconnect, device number 32
[Tue Jul 25 16:50:44 2023] usb usb2-port3: Cannot enable. Maybe the USB cable is bad?
```


- ms2109在windows下能正常工作
  - 在linux下，ustream报
```
-- INFO  [268879.670    stream] -- Device fd=8 opened
-- INFO  [268879.670    stream] -- Using input channel: 0
-- INFO  [268879.685    stream] -- Using resolution: 640x480
-- ERROR [268879.685    stream] -- Could not obtain the requested pixelformat=YUYV; driver gave us MJPEG
-- INFO  [268879.685    stream] -- Falling back to pixelformat=MJPEG
-- INFO  [268879.685    stream] -- Using pixelformat: MJPEG
-- INFO  [268879.700    stream] -- Using HW FPS: 0 -> 60 (coerced)
-- ERROR [268879.700    stream] -- Device does not support setting of HW encoding quality parameters
-- INFO  [268879.700    stream] -- Using IO method: MMAP
-- INFO  [268879.702    stream] -- Requested 5 device buffers, got 5
-- INFO  [268879.704    stream] -- Capturing started
-- INFO  [268879.704    stream] -- Switching to HW encoder: the input is (M)JPEG ...
-- INFO  [268879.704    stream] -- Using JPEG quality: encoder default
-- INFO  [268879.704    stream] -- Creating pool JPEG with 1 workers ...
-- INFO  [268879.704    stream] -- Capturing ...
-- ERROR [268880.714    stream] -- Mainloop select() error: Inappropriate ioctl for device
-- INFO  [268880.714    stream] -- Destroying workers pool JPEG ...
-- INFO  [268880.715    stream] -- Capturing stopped
-- INFO  [268880.715    stream] -- Device fd=8 closed

[Tue Jul 25 17:04:36 2023] uvcvideo 1-3:1.1: Non-zero status (-71) in video completion handler.
```

ms2130 插USB3.0没有反应，USB2.0，windows和linux都能正常工作。

开发板USB2.0无反应

#### 使用ustream测试是否能够使用

[pikvm/ustreamer: µStreamer - Lightweight and fast MJPEG-HTTP streamer (github.com)](https://github.com/pikvm/ustreamer)
```

./ustreamer --device=/dev/video0 --host=0.0.0.0 --port=8000 -r 1920x1080 --format=MJPEG
```


ms2109

```
-- INFO  [266472.324    stream] -- Device fd=8 opened
-- INFO  [266472.324    stream] -- Using input channel: 0
-- INFO  [266472.339    stream] -- Using resolution: 1920x1080
-- INFO  [266472.339    stream] -- Using pixelformat: MJPEG
-- INFO  [266472.354    stream] -- Using HW FPS: 0 -> 60 (coerced)
-- ERROR [266472.354    stream] -- Device does not support setting of HW encoding quality parameters
-- INFO  [266472.354    stream] -- Using IO method: MMAP
-- INFO  [266472.357    stream] -- Requested 5 device buffers, got 5
-- INFO  [266472.360    stream] -- Capturing started
-- INFO  [266472.360    stream] -- Switching to HW encoder: the input is (M)JPEG ...
-- INFO  [266472.360    stream] -- Using JPEG quality: encoder default
-- INFO  [266472.360    stream] -- Creating pool JPEG with 1 workers ...
-- INFO  [266472.360    stream] -- Capturing ...
-- ERROR [266473.375    stream] -- Mainloop select() error: Inappropriate ioctl for device
-- INFO  [266473.375    stream] -- Destroying workers pool JPEG ...
-- INFO  [266473.377    stream] -- Capturing stopped
-- INFO  [266473.379    stream] -- Device fd=8 closed
```

```
[Tue Jul 25 16:24:26 2023] uvcvideo 1-3:1.1: Non-zero status (-71) in video completion handler.
[Tue Jul 25 16:24:26 2023] uvcvideo 1-3:1.1: Non-zero status (-71) in video completion handler.
[Tue Jul 25 16:24:26 2023] uvcvideo 1-3:1.1: Non-zero status (-71) in video completion handler.
```


### 键盘问题

插入主板usb2.0接口，ryzen dmesg，几种错误如下
- `usbhid 1-8:1.1: can't add hid device: -110`
- `usb usb1-port8: Cannot enable. Maybe the USB cable is bad?`
- `usbhid 1-8:1.1: can't add hid device: -71`
```bash
➜  ~ sudo dmesg --color=always --ctime -W
[Tue Jul 25 22:01:09 2023] usb 1-8: new high-speed USB device number 126 using xhci_hcd
[Tue Jul 25 22:01:09 2023] usb 1-8: device descriptor read/64, error -71
[Tue Jul 25 22:01:10 2023] usb 1-8: New USB device found, idVendor=1d6b, idProduct=0104, bcdDevice= 1.00
[Tue Jul 25 22:01:10 2023] usb 1-8: New USB device strings: Mfr=1, Product=2, SerialNumber=3
[Tue Jul 25 22:01:10 2023] usb 1-8: Product: Composite KVM Device
[Tue Jul 25 22:01:10 2023] usb 1-8: Manufacturer: PiKVM
[Tue Jul 25 22:01:10 2023] usb 1-8: SerialNumber: CAFEBABE
[Tue Jul 25 22:01:10 2023] input: PiKVM Composite KVM Device as /devices/pci0000:00/0000:00:01.2/0000:02:00.0/usb1/1-8/1-8:1.0/0003:1D6B:0104.0104/input/input257
[Tue Jul 25 22:01:10 2023] hid-generic 0003:1D6B:0104.0104: input,hidraw0: USB HID v1.01 Keyboard [PiKVM Composite KVM Device] on usb-0000:02:00.0-8/input0
[Tue Jul 25 22:01:56 2023] usbhid 1-8:1.1: can't add hid device: -110
[Tue Jul 25 22:01:56 2023] usbhid: probe of 1-8:1.1 failed with error -110
[Tue Jul 25 22:02:42 2023] usbhid 1-8:1.2: can't add hid device: -110
[Tue Jul 25 22:02:42 2023] usbhid: probe of 1-8:1.2 failed with error -110
[Tue Jul 25 22:02:42 2023] usb 1-8: USB disconnect, device number 126


[Tue Jul 25 22:02:44 2023] usb 1-8: new high-speed USB device number 127 using xhci_hcd
[Tue Jul 25 22:02:44 2023] usb 1-8: device descriptor read/all, error -71
[Tue Jul 25 22:02:45 2023] usb usb1-port8: Cannot enable. Maybe the USB cable is bad?
[Tue Jul 25 22:02:45 2023] usb usb1-port8: attempt power cycle
[Tue Jul 25 22:02:46 2023] usb 1-8: new high-speed USB device number 6 using xhci_hcd
[Tue Jul 25 22:02:46 2023] usb 1-8: Device not responding to setup address.
[Tue Jul 25 22:02:46 2023] usb 1-8: Device not responding to setup address.
[Tue Jul 25 22:02:46 2023] usb 1-8: device not accepting address 6, error -71

[Tue Jul 25 22:02:47 2023] usb 1-8: new high-speed USB device number 7 using xhci_hcd
[Tue Jul 25 22:02:47 2023] usb 1-8: New USB device found, idVendor=1d6b, idProduct=0104, bcdDevice= 1.00
[Tue Jul 25 22:02:47 2023] usb 1-8: New USB device strings: Mfr=1, Product=2, SerialNumber=3
[Tue Jul 25 22:02:47 2023] usb 1-8: Product: Composite KVM Device
[Tue Jul 25 22:02:47 2023] usb 1-8: Manufacturer: PiKVM
[Tue Jul 25 22:02:47 2023] usb 1-8: SerialNumber: CAFEBABE
[Tue Jul 25 22:02:47 2023] input: PiKVM Composite KVM Device as /devices/pci0000:00/0000:00:01.2/0000:02:00.0/usb1/1-8/1-8:1.0/0003:1D6B:0104.0105/input/input258
[Tue Jul 25 22:02:47 2023] hid-generic 0003:1D6B:0104.0105: input,hidraw0: USB HID v1.01 Keyboard [PiKVM Composite KVM Device] on usb-0000:02:00.0-8/input0
[Tue Jul 25 22:02:47 2023] usbhid 1-8:1.1: can't add hid device: -71
[Tue Jul 25 22:02:47 2023] usbhid: probe of 1-8:1.1 failed with error -71
[Tue Jul 25 22:02:47 2023] usbhid f1-8:1.2: can't add hid device: -71
[Tue Jul 25 22:02:47 2023] usbhid: probe of 1-8:1.2 failed with error -71
[Tue Jul 25 22:02:47 2023] usb 1-8: USB disconnect, device number 7
```

#### usb3.0 ok
发现otg键盘接windows是没问题的，然后发现ryzen使用usb 3.0接口没问题
dmesg
```bash
[Tue Jul 25 22:04:38 2023] usb 3-3.3: reset low-speed USB device number 28 using xhci_hcd
[Tue Jul 25 22:04:39 2023] usb 3-3.1: reset full-speed USB device number 34 using xhci_hcd
[Tue Jul 25 22:20:12 2023] usb 3-4: new high-speed USB device number 35 using xhci_hcd
[Tue Jul 25 22:20:12 2023] usb 3-4: New USB device found, idVendor=1d6b, idProduct=0104, bcdDevice= 1.00
[Tue Jul 25 22:20:12 2023] usb 3-4: New USB device strings: Mfr=1, Product=2, SerialNumber=3
[Tue Jul 25 22:20:12 2023] usb 3-4: Product: Composite KVM Device
[Tue Jul 25 22:20:12 2023] usb 3-4: Manufacturer: PiKVM
[Tue Jul 25 22:20:12 2023] usb 3-4: SerialNumber: CAFEBABE
[Tue Jul 25 22:20:12 2023] input: PiKVM Composite KVM Device as /devices/pci0000:00/0000:00:08.1/0000:0a:00.3/usb3/3-4/3-4:1.0/0003:1D6B:0104.0106/input/input259
[Tue Jul 25 22:20:12 2023] hid-generic 0003:1D6B:0104.0106: input,hidraw0: USB HID v1.01 Keyboard [PiKVM Composite KVM Device] on usb-0000:0a:00.3-4/input0
[Tue Jul 25 22:20:12 2023] input: PiKVM Composite KVM Device as /devices/pci0000:00/0000:00:08.1/0000:0a:00.3/usb3/3-4/3-4:1.1/0003:1D6B:0104.0107/input/input260
[Tue Jul 25 22:20:12 2023] hid-generic 0003:1D6B:0104.0107: input,hidraw1: USB HID v1.01 Mouse [PiKVM Composite KVM Device] on usb-0000:0a:00.3-4/input1
[Tue Jul 25 22:20:12 2023] input: PiKVM Composite KVM Device as /devices/pci0000:00/0000:00:08.1/0000:0a:00.3/usb3/3-4/3-4:1.2/0003:1D6B:0104.0108/input/input261
[Tue Jul 25 22:20:12 2023] hid-generic 0003:1D6B:0104.0108: input,hidraw2: USB HID v1.01 Mouse [PiKVM Composite KVM Device] on usb-0000:0a:00.3-4/input2
```

lsusb可以看到新出的设备
```
Bus 003 Device 035: ID 1d6b:0104 Linux Foundation Multifunction Composite Gadget
```


### bios问题

发现只要重启进入bios，就会出很多问题
- 刚开始屏幕和键鼠都是好的。除了鼠标移动延迟很大，基本不可用
- 接着鼠标彻底动不了了
- 然后king3399不知为何无法访问了，网络ipv6无法ping通，有时则显示超时3000ms
- ssh session中看到htop CPU占用率并不高

dmesg中许多报错
```
[Tue Jul 25 23:17:55 2023] wireguard: WireGuard 1.0.0 loaded. See www.wireguard.com for information.
[Tue Jul 25 23:17:55 2023] wireguard: Copyright (C) 2015-2019 Jason A. Donenfeld <Jason@zx2c4.com>. All Rights Reserved.
[Tue Jul 25 23:20:48 2023] device wg0 entered promiscuous mode
[Tue Jul 25 23:21:25 2023] device wg0 left promiscuous mode
[Tue Jul 25 23:21:26 2023] device wg0 entered promiscuous mode
[Tue Jul 25 23:21:40 2023] device wg0 left promiscuous mode
[Tue Jul 25 23:38:47 2023] configfs-gadget.kvmd gadget.0: End Point Request ERROR: -108
[Tue Jul 25 23:53:30 2023] configfs-gadget.kvmd gadget.0: End Point Request ERROR: -108
[Tue Jul 25 23:53:49 2023] configfs-gadget.kvmd gadget.0: End Point Request ERROR: -108
[Tue Jul 25 23:55:13 2023] configfs-gadget.kvmd gadget.0: End Point Request ERROR: -108
p^Xp^Xn^X[Tue Jul 25 23:57:50 2023] dwc3 fe800000.usb: failed to send remote wakeup
[Tue Jul 25 23:57:53 2023] dwc3 fe800000.usb: failed to send remote wakeup
[Tue Jul 25 23:57:54 2023] dwc3 fe800000.usb: failed to send remote wakeup
l[Tue Jul 25 23:57:58 2023] dwc3 fe800000.usb: failed to send remote wakeup
[Tue Jul 25 23:58:00 2023] dwc3 fe800000.usb: failed to send remote wakeup
[Tue Jul 25 23:58:03 2023] dwc3 fe800000.usb: failed to send remote wakeup
[Tue Jul 25 23:58:04 2023] dwc3 fe800000.usb: failed to send remote wakeup
[Tue Jul 25 23:58:08 2023] configfs-gadget.kvmd gadget.0: End Point Request ERROR: -108
[Tue Jul 25 23:58:08 2023] configfs-gadget.kvmd gadget.0: End Point Request ERROR: -108
[Tue Jul 25 23:58:08 2023] configfs-gadget.kvmd gadget.0: End Point Request ERROR: -108
[Tue Jul 25 23:58:09 2023] dwc3 fe800000.usb: failed to send remote wakeup
[Tue Jul 25 23:58:22 2023] dwc3 fe800000.usb: failed to send remote wakeup
[Tue Jul 25 23:58:23 2023] dwc3 fe800000.usb: failed to send remote wakeup
[Tue Jul 25 23:58:43 2023] dwc3 fe800000.usb: failed to send remote wakeup
[Tue Jul 25 23:58:48 2023] dwc3 fe800000.usb: failed to send remote wakeup
[Tue Jul 25 23:58:50 2023] dwc3 fe800000.usb: failed to send remote wakeup
[Tue Jul 25 23:58:53 2023] dwc3 fe800000.usb: failed to send remote wakeup
[Wed Jul 26 00:01:08 2023] dwc3 fe800000.usb: failed to send remote wakeup
[Wed Jul 26 00:01:08 2023] configfs-gadget.kvmd gadget.0: End Point Request ERROR: -108
[Wed Jul 26 00:01:08 2023] configfs-gadget.kvmd gadget.0: End Point Request ERROR: -108
[Wed Jul 26 00:01:08 2023] configfs-gadget.kvmd gadget.0: End Point Request ERROR: -108
```


## PI-KVM文档

[PiKVM Project (github.com)](https://github.com/pikvm)
- ustreamer项目也是他们的
- kvmd

文档：[PiKVM Handbook](https://docs.pikvm.org/)

DIY: [pikvm/pikvm: Open and inexpensive DIY IP-KVM based on Raspberry Pi (github.com)](https://github.com/pikvm/pikvm#diy-getting-started)

### mouse

[Mouse modes - PiKVM Handbook](https://docs.pikvm.org/mouse/)
There are two modes of pointer device: absolute and relative.

By default, PiKVM uses absolute positioning mode as the most convenient for the user and software. However, this is not always supported by the BIOS/UEFI. For such cases, support is provided for the relative mode of operation, which can be enabled in the config.

[Dynamic USB configuration - PiKVM Handbook](https://docs.pikvm.org/usb_dynamic/)
由于bios貌似对absolute鼠标兼容性不够好，可以直接禁用
> In rare cases, the host BIOS/UEFI may not understand such a large number of emulated devices on single USB port, so some of them may need to be disabled.

> The `kvmd-otgconf` utility allows you to view and modify the USB configuration on the fly. It requires root permission and can be used for example from a web terminal.

```
kvmd-otgconf --disable-function mass_storage.usb0
kvmd-otgconf --enable-function mass_storage.usb0
```

### FAQ

#### Can I use PiKVM for gaming?
No, because:
- For HDMI-CSI bridge, bus bandwidth is not enough to transmit more than 1080p50.
- For HDMI-USB dongle, high latency and low video quality.
- General hardware video capture differs from software streaming and introduces additional latency.


#### Can I use PiKVM with non-Raspberry Pi boards (Orange, Nano, etc)?

Yes, but you will have to prepare the operating system yourself. For the PiKVM software, you will need to replace some config files (such as UDEV rules). If you are a developer or an experienced system administrator, you will not have any problems with this. In addition, we are open to patches. If you need help with this, please contact us via [Discord](https://discord.gg/bpmXfz5) (#unofficial_ports channel).

#### video problem

https://docs.pikvm.org/faq/#video-problems

### CSI bridge vs USB dongle
The dongle is completely supported and PiKVM works great with it. But it has some disadvantages compared with recommended [HDMI-CSI bridge](https://aliexpress.com/item/4000102166176.html): USB gives a lot of latency (200ms vs 100ms for MJPEG) and it doesn't support stream compression control (you won't be able to use PiKVM in a place with a poor internet connection). There is no H.264 support at the moment. It also cannot automatically detect screen resolution. All this is caused by the hardware limitations of the dongle itself. In addition, some users report hardware problems: the dongle may not work in the BIOS or simply stop working after a while. It's a black box, and no one knows what's inside it. If you have problems with it, it will not be possible to fix them.


## 如何实现ATX电源控制

- 需要使用atx 控制线
  - 主板-PIKVM
  - 机箱-PIKVM
- PIKVM有一个板子用于将atx控制线转成RJ45。板子可以3d打印一个pcie slot支架
[ATX control board - PiKVM Handbook](https://docs.pikvm.org/atx_board/#detailed-instructions)

Pi-KVM项目可以支持调用一半GPIO驱动，这样就可以实现第三方开发板控制GPIO了？
[GPIO (pins, relays, lamps, etc) - PiKVM Handbook](https://docs.pikvm.org/gpio/)


嵌入式的视频接口
- MIPI DSI视频输出，MIPI CSI视频输入
## 网络相关

### wg-quick无法自启动

[Wireguard - waiting for DNS before trying to start the interface · Issue #30459 · NixOS/nixpkgs (github.com)](https://github.com/NixOS/nixpkgs/issues/30459)

```
Aug 07 23:17:57 king3399 wg-quick[1167]: [#] ip link add wg0 type wireguard
Aug 07 23:17:57 king3399 wg-quick[1167]: [#] wg setconf wg0 /dev/fd/63
Aug 07 23:17:57 king3399 wg-quick[1241]: Name or service not known: `op1.my.to:51820'
Aug 07 23:17:57 king3399 wg-quick[1241]: Configuration parsing error
Aug 07 23:17:57 king3399 wg-quick[1167]: [#] ip link delete dev wg0
Aug 07 23:17:58 king3399 systemd[1]: wg-quick@wg0.service: Main process exited, code=exited, status=1/FAILURE
```

