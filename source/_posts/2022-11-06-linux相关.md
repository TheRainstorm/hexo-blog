---
title: linux相关
date: 2022-11-06 18:14:50
tags:
- tty
- sed
- awk
- wifi
- fdisk
- parted
- virtualbox
- mount
categories:
- 学习
---

linux相关
<!-- more -->

# linux科普

## tty, pts

- tty表示终端(terminal or console)的统称。tty(tele typerwriter)电传打字机为早期电脑的输入输出设备，后面被显示器和键盘取代。
  - ctrl alt + F1-F6对应6个终端
  - ctrl alt + F7对应图形化界面
- pts(pseudo terminal slave)表示伪终端。是一个程序（终端仿真器teminal emulators）
```bash
who #查看当前所有登录用户及终端
➜  ~ who
yfy      :1           2022-10-24 14:26 (:1)
yfy      pts/1        2022-10-16 15:36 (tmux(1158265).%0)
yfy      pts/2        2022-10-24 14:43 (192.168.1.180)
yfy      pts/3        2022-10-23 18:57 (tmux(1158265).%5)
yfy      pts/4        2022-10-16 15:37 (tmux(1158265).%2)
yfy      pts/6        2022-10-16 15:38 (tmux(1158265).%3)
yfy      pts/7        2022-10-16 15:38 (tmux(1158265).%4)
yfy      pts/12       2022-10-24 00:36 (tmux(1158265).%0)
who -m # 查看当前用户

echo "hello" > /dev/pty/x   #直接给对应终端发送消息
```

# 安装配置linux

时区
```
timedatectl set-timezone Asia/Shanghai
```

## 桌面环境

```
sudo apt install ubuntu-desktop
sudo apt install kde-plasma-desktop
```

```
sudo apt install lightdm
```

# 基本命令

## linux命令option通用格式

- POSIX-styled的option由一个dash和一个字符组成
- GNU-style的long option由两个dash和一个关键字(keyword)组成
  - 关键字能被缩写，只要足够区分不同关键字
  - 如果关键字需要一个参数(argument)，可以在关键字后紧跟一个等号=，然后紧跟着关键字的值。或者将关键字和值用空白字符(whitespace)分隔开。
  - 如果关键字被多次赋值，则以最后一次的为准

man wget
- 解析方法
  - GUN getopt
- 是否支持合并
- 是否支持选项放在参数后面
- `--`表示option结束。Since the options can be specified after the arguments, you may terminate them with `--`.  So the following will try to download URL -x, reporting failure to log: `wget -o log -- -x`

## vim

[Vim Cheat Sheet (rtorr.com)](https://vim.rtorr.com/)

### 基本

```
# insert mode
i, o, O

# 光标移动
i, j, k, l
gg, G
w, W, b, B # move word

# 复制粘贴
yy, p
dw # 剪切单词

/pattern   # 查找
n
```

#### 添加tab

- ctrl-v进入visual block模式（如果使用windows terminal，ctrl-v被设置为粘贴会导致无法进入），或者shift-v进入visual line模式。
- "shift + dot"，被选中的行便会tab一次，重复"dot"可以tab任意次
    - 或者`:`进入命令模式，`>`往右tab，`<`往左tab

也可以直接使用命令模式，以下命令将1-5行向右tab 2次
```
:1,5>>
```

### 高级

光标移动
```
H, M, L #  top, middle, bottom of screen

fx # jump to next occurrence of character x
} # jump to next paragraph (or function/block, when editing code)
{

zz # center cursor on screen

Ctrl + b - move back one full screen
Ctrl + f - move forward one full screen
Ctrl + d - move forward 1/2 a screen
Ctrl + u - move back 1/2 a screen
```

查找替换
- %表示整个文件range（否则只会替换第一次匹配）
```
:%s/xxx/yyy/g
```

#### 执行shell命令

```
:!{cmd}

:!ls -alh # 查看当前目录下文件

:w !{cmd}   # buffer | cmd

:%!{cmd}   # buffer | cmd | buffer
:%!grep xxx  # 过滤文件内容，保留匹配的部分
```
#### 忘记sudo

write with sudo[How does the vim "write with sudo" trick work? - Stack Overflow](https://stackoverflow.com/questions/2600783/how-does-the-vim-write-with-sudo-trick-work)

```
:w !sudo tee %
```
- w命令完整格式：`:[range]w[rite] [++opt] !{cmd}`
  - 表示执行cmd，并将当前编辑缓冲区内容作为cmd输入
  - 例子`:w !grep xxx`，grep文件内容
- `%`：这里表示文件名
- **因此上述命令将buffer内容pipe给sudo执行的tee命令，tee命令将stdin输出到当前文件和stdout，从而实现对文件的写入。**

为上述命令设置别名w!!
```
" Allow saving of files as sudo when I forgot to start vim using sudo.
cmap w!! w !sudo tee > /dev/null %
```
#### 编辑二进制文件

[binary file - How can I use Vim as a hex editor? - Vi and Vim Stack Exchange](https://vi.stackexchange.com/questions/2232/how-can-i-use-vim-as-a-hex-editor)

`:%!xxd`
- `:%!{cmd}`有点像loopback，把当前缓冲区pipe给cmd然后再将其输出写回到缓冲区。
- xxd输入二进制输出hex文本

`:%!xxd -r`
- xxd -r输入hex文本输出二进制

`:wq`
写回文件

### 配置文件

```
map <C-c> "+y<CR>
map <C-v> "+p<CR>

command! Vb normal! <C-v>

cmap w!! w !sudo tee > /dev/null %
```

自定义命令：[key bindings - Is there a command to enter Visual Block mode? - Vi and Vim Stack Exchange](https://vi.stackexchange.com/questions/3699/is-there-a-command-to-enter-visual-block-mode)

## cp注意点

- cp file1 file2 ... dir
- cp -r dir1 dir2
	- 如果dir2存在，则将dir1复制到dir2内，即dir2/dir1
	- 如果dir2不存在，则将dir1复制为dir2
- cp dir1/* dir2
  - 将dir1下所有文件复制到dir2内，如果dir1存在目录，则应添加-r选项

## sed, awk, grep

这些命令要深入研究的话，内容都很多。比如awk可以算是一种用于处理文本的解释型编程语言。因此，比较好的方法是从需求出发，看看在linux下一般有哪些文字处理的需求，再看使用哪种工具比较方便简单。

#### 命令格式

```
grep [option] pattern file

sed [options] 'command' file(s)
sed [options] -f scriptfile file(s)

awk [options] 'pattern {action}' [file]
```

#### 正则表达式

>  基本正则表达式（Basic Regular Expressions）和扩展正则表达式（Extended Regular Expressions）是两种 POSIX 正则表达式风格。
>
> BRE 可能是如今最老的正则风格了，对于部分特殊字符（如 `+`, `?`, `|`, `{`）需要加上转义符 `\` 才能表达其特殊含义。
>
> ERE 与如今的现代正则风格较为一致，相比 BRE，上述特殊字符默认发挥特殊作用，加上 `\` 之后表达普通含义。

#### 常见需求

- 修改文件中某部分内容。一般可以使用正则表达式，匹配到对应位置，然后进行修改。

  ```bash
  //将文件中所有的key=xxx，修改为key=${val}
  //-i表示在原文件上修改，去掉后会将结果输出到命令行
  // 这里还用到了字符串拼接语法，将连个字符串写到一起就会拼接。单引号内不能进行转义，因此为了使用变量val需要使用双引号。
  sed -i 's/key=[0-9]+/'"key=${val}/g"
  ```

  sed其它命令:
  - s 替换
  - d 删除
  - c 选定行改成新文本
  - a 当前行下插入文本
  - i 当前行上插入文本
  ```bash
  //找到某一行，然后整行替换
  sed -i "/config_pio_local_num_iotasks/ c\config_pio_local_num_iotasks = 3"
  ```

多行命令
```bash
sed -i -e '/^port/c #port: 7890' -e '/^socks-port/c #socks-port: 7891' -e 's/^allow-lan.*/allow-lan: true/' -e '/^allow-lan/i mixed-port: 11223' glados.yaml
```

awk
```
awk -F'TXT' '{print $NF}' |xargs  # TXT为分隔符，$NF为最后一列，xargs去除空格(strip
```

## 其它

### head, tail

```
tail         # 输出最后10行
tail -n k    # 输出最后k行
tail -n +k   # 输出从第k行（1开始）的所有行

head         # 输出前10行
head -n k    # 输出前k行
head -n -k   # 输出除结尾k行后的所有行
```

### xargs

```
xargs [options] [command [initial-arguments]]
```

从标准输入读取items（使用blank或者newline分隔），然后执行command（默认/bin/echo）。使用-n决定每次传递多少iterm
```
➜  ~ echo 1 2 3 4 5 6 7 8 9 | xargs -n 3
1 2 3
4 5 6
7 8 9
```

```
-n max-args, --max-args=max-args
              Use at most max-args arguments per command line.  Fewer than max-args arguments will be used if the size (see the -s option) is exceeded, unless the -x option is given, in which case xargs will exit.
              
-r, --no-run-if-empty
    If the standard input does not contain any nonblanks, do not run the command.  Normally, the command is run once even if there is no input.  This option is a GNU extension.
```
### tar

[archive - How do I tar a directory of files and folders without including the directory itself? - Stack Overflow](https://stackoverflow.com/questions/939982/how-do-i-tar-a-directory-of-files-and-folders-without-including-the-directory-it)

```
tar czf xxx.tar.gz -C <dir> .
```
- -C : change the current directory
- `.`: add the entire current directory
### cut

```bash
for IPV6_SUBNET in $NET_IPV6_SUBNETS; do
SRC=$(echo $IPV6_SUBNET | cut -d "/" -f 1)"/128"
...
done
```

# 基本操作

## sudoer设置

```
vim /etc/sudoers
```

将用户添加到admin或sudo用户组即可

免密码：
```
%sudo   ALL=(ALL:ALL) NOPASSWD: ALL
```

sudoers每项含义（待续）

## linux sshd设置

允许ssh登录root

先改为yes，然后ssh-copy-id后，改为禁用密码
```
PermitRootLogin prohibit-password
#PermitRootLogin yes
```

禁用密码登录

```
PasswordAuthentication no
```

其它选项
```
PermitRootLogin prohibit-password
PubkeyAuthentication yes    # 允许公钥登录
PubkeyAcceptedKeyTypes=+ssh-rsa
PasswordAuthentication no   # 禁用密码登录
ChallengeResponseAuthentication no
```

```
Accepted password for yfy from 192.168.36.215 port 50342 ssh2

Accepted publickey for yfy from 192.168.36.180 port 26464 ssh2: RSA SHA256:z9yheNzateaIikTVkTXN1lmMPRIsp+H0ssbhU4Q8Kfg
pam_unix(sshd:session): session opened for user yfy(uid=1000) by (uid=0)
```
## move running process to tmux

[Move a running process into a tmux session | ./xai.sh](https://xai.sh/2020/10/16/Move-running-process-into-tmux-session.html)

## 测试磁盘速度

### dd

使用dd简单测试速度。可以区分usb 2.0和3.0；可以见识PCIe 4.0 ssd的速度。

注意需要开启direct，否则需要从userspace复制到kernel buffer，严重影响速度。block size对速度影响很大。 [Why is dd with the 'direct' (O_DIRECT) flag so dramatically faster?](https://stackoverflow.com/questions/33485108/why-is-dd-with-the-direct-o-direct-flag-so-dramatically-faster)

```
➜  speed_disk sudo dd if=/dev/zero of=/mnt/VM-Pool/ssd.test.file bs=4k count=300000 oflag=direct
300000+0 records in
300000+0 records out
1228800000 bytes (1.2 GB, 1.1 GiB) copied, 3.18978 s, 385 MB/s

➜  speed_disk sudo dd if=/dev/zero of=/mnt/VM-Pool/ssd.test.file bs=4M count=2000 oflag=direct
2000+0 records in
2000+0 records out
8388608000 bytes (8.4 GB, 7.8 GiB) copied, 1.94441 s, 4.3 GB/s
```

### fio

- I/O type
  - direct, buffered, atomic. : O_DIRECT, O_ATOMIC
  - readwrite=str, rw=str
    - read: Sequential reads.
    - write: Sequential writes.
    - randread: Random reads.
    - randwrite: Random writes.
    - rw,readwrite: Sequential mixed reads and writes
    - randrw: Random mixed reads and writes.
    - trim, randtrim, trimwrite
- Block size
  - bs: The block size in bytes used for I/O units
- Buffer and Memory
  - sync=str
    - sync: Use synchronous file IO. O_SYNC
    - dsync: Use synchronous data IO. For the majority of I/O engines, this means using O_DSYNC.
- I/O size
  - size: The total size of file I/O for each thread of this job. Fio will run until this many bytes has been transferred, unless runtime is limited by  other  options  (such  as  runtime, for instance, or increased/decreased by io_size).
- I/O engine
  - ioengine=str
    - psync: Basic pread(2) or pwrite(2) I/O. Default on all supported operating systems except for Windows
    - libaio:  Linux native asynchronous I/O. Note that Linux may only support queued behavior with non-buffered  I/O  (set  direct=1 or buffer=0).  This engine defines engine specific options.
- I/O depth
  - iodepth=int
    - Number of I/O units to keep in flight against the file. Note that increasing iodepth beyond 1 will not affect synchronous  ioengines  (except  for  small  degrees  when verify_async is in use). Even async engines may impose OS restrictions causing the desired depth not to be achieved. This may happen on Linux when using libaio and not setting `direct=1`', since buffered I/O is not async on that OS. Keep  an  eyeon the I/O depth distribution in the fio output to verify that the achieved depth is as expected. Default: 1.

stonewall
wait_for_previous  Wait for preceding jobs in the job file to exit, before starting this one. Can be used to insert serialization points in the job  file.  A stone  wall  also  implies  starting  a  new  reporting  group,  see  group_reporting.  Optionally you can use `stonewall=0` to disable or `stonewall=1` to enable it.

#### 配置文件

- global公共部分，影响后面每一个job
- stonewall等待前面一个完成
- filename指定共同使用一个文件（否则会根据job名自动生成）
```
sudo fio --directory=/root/ --filename=test.bin ssd-win-likely.fio

vim ssd-win-likely.fio #模仿windows下diskmark，测顺序读写和4k随机
[global]
ioengine=libaio
size=10g
direct=1
runtime=60

[seq-read-4m]
bs=4M
iodepth=32
rw=read
stonewall

[seq-write-4m]
bs=4M
iodepth=32
rw=write
stonewall

[rand-read-4k]
bs=4k
iodepth=4
rw=randread
stonewall

[rand-write-4k]
bs=4k
iodepth=4
rw=randwrite
stonewall
```

#### 例子

aigo P7000Z 2TB pcie 4.0 (标称读7350, 写6750 MB/s)
- *使用上述配置文件测得只有3231, 330, 5999, 509MB/s，怀疑是连续测试导致过热降速。*
- 单独测试测得：顺序读7319MB/s，顺序写6620MB/s（4M, direct, QD=32, libaio）

```
sudo fio --filename=fio.img --bs=4M --direct=1 --iodepth=32 --size=10g --runtime=60 --rw=read --name=seq-read --ioengine=libaio
```

输出
```
seq-read: (g=0): rw=read, bs=(R) 4096KiB-4096KiB, (W) 4096KiB-4096KiB, (T) 4096KiB-4096KiB, ioengine=libaio, iodepth=32
fio-3.28
Starting 1 process
Jobs: 1 (f=1)
seq-read: (groupid=0, jobs=1): err= 0: pid=207476: Sun Apr  2 22:26:36 2023
  read: IOPS=1745, BW=6980MiB/s (7319MB/s)(10.0GiB/1467msec)
    slat (usec): min=66, max=988, avg=118.46, stdev=69.15
    clat (usec): min=4051, max=35006, avg=18079.05, stdev=1613.53
     lat (usec): min=4574, max=35099, avg=18197.64, stdev=1588.77
    clat percentiles (usec):
     |  1.00th=[11076],  5.00th=[17957], 10.00th=[17957], 20.00th=[17957],
     | 30.00th=[17957], 40.00th=[17957], 50.00th=[18220], 60.00th=[18220],
     | 70.00th=[18220], 80.00th=[18220], 90.00th=[18220], 95.00th=[18482],
     | 99.00th=[20579], 99.50th=[28181], 99.90th=[33817], 99.95th=[34341],
     | 99.99th=[34866]
   bw (  MiB/s): min= 6912, max= 7024, per=99.82%, avg=6968.00, stdev=79.20, samples=2
   iops        : min= 1728, max= 1756, avg=1742.00, stdev=19.80, samples=2
  lat (msec)   : 10=0.90%, 20=98.01%, 50=1.09%
  cpu          : usr=0.00%, sys=22.10%, ctx=2530, majf=0, minf=32782
  IO depths    : 1=0.1%, 2=0.1%, 4=0.2%, 8=0.3%, 16=0.6%, 32=98.8%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.1%, 64=0.0%, >=64=0.0%
     issued rwts: total=2560,0,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=32
```


#### 结果

- 西数紫盘 2TB： 
  - read: IOPS=47, BW=192MiB/s (201MB/s)(4096MiB/21381msec)
  - write: IOPS=47, BW=188MiB/s (197MB/s)(4096MiB/21768msec); 0 zone resets
- 希捷酷鱼 4TB：
  - read: IOPS=35, BW=142MiB/s (149MB/s)(4096MiB/28785msec)
  - write: IOPS=34, BW=138MiB/s (144MB/s)(4096MiB/29777msec); 0 zone resets
- btrfs混合(西数紫盘 2TB+希捷酷鱼 2/4TB)
  - read: IOPS=45, BW=182MiB/s (190MB/s)(4096MiB/22564msec)
  - write: IOPS=39, BW=160MiB/s (167MB/s)(4096MiB/25644msec); 0 zone resets

- aigo 4.0
  - read: IOPS=83.7k, BW=327MiB/s (343MB/s)(10.0GiB/31321msec) 4k rand q=4
  - write: IOPS=125k, BW=487MiB/s (511MB/s)(10.0GiB/21008msec);
- btrfs混合（4.0 + 3.0）
  - read: IOPS=540, BW=2163MiB/s (2268MB/s)(10.0GiB/4734msec) 4M seq q=32
  - read: IOPS=76.5k, BW=299MiB/s (313MB/s)(10.0GiB/34280msec) 4k rand q=4
  - write: IOPS=77.4k, BW=302MiB/s (317MB/s)(10.0GiB/33876msec) 4k rand q=4

## 生活相关

### 禁止休眠

[How to Disable Suspend and Hibernation Modes In Linux (tecmint.com)](https://www.tecmint.com/disable-suspend-and-hibernation-in-linux/)
```
sudo systemctl status sleep.target suspend.target hibernate.target hybrid-sleep.target
```


### 禁止关闭笔记本盖子休眠

```
vim /etc/systemd/logind.conf

HandleLidSwitch=lock   # 从suspend改为lock
```

man logind.conf
> Controls how logind shall handle the system power, reboot and sleep keys and the lid switch to trigger actions such as system power-off, reboot or suspend. Can be one of "ignore", "poweroff", "reboot", "halt", "kexec", "suspend", "hibernate", "hybrid-sleep", "suspend-then-hibernate", "lock", and "factory-reset". 
> 
> If "ignore", systemd-logind will never handle these keys. If "lock", all running sessions will be screen-locked; otherwise, the specified action will be taken in the respective event. Only input devices with the "power-switch" udev tag will be watched for key/lid switch events. 
> 
> HandlePowerKey= defaults to "poweroff", HandleRebootKey= defaults to "reboot", HandleSuspendKey= defaults to "suspend", HandleHibernateKey= defaults to "hibernate", HandlePowerKeyLongPress= defaults to "ignore", HandleRebootKeyLongPress= defaults to "poweroff", HandleSuspendKeyLongPress= defaults to "hibernate", HandleHibernateKeyLongPress= defaults to "ignore".  HandleLidSwitch= defaults to "suspend".  HandleLidSwitchExternalPower= is completely ignored by default (for backwards compatibility) — an explicit value must be set before it will be used to determine behaviour.  HandleLidSwitchDocked= defaults to "ignore". If the system is inserted in a docking station, or if more than one display is connected, the action specified by HandleLidSwitchDocked= occurs; if the system is on external power the action (if any) specified by HandleLidSwitchExternalPower= occurs; otherwise the HandleLidSwitch= action occurs.
### 连接wifi

#### iw,iwconfig等底层工具

- iw
- iwlist
- wpa_supplicant: 用于连接WPA加密的wifi

不使用networkmanger等工具，需要
- iw连接wifi
  - ifup interface
- 开启dhcpclient获得ip

[Network configuration/Wireless - ArchWiki (archlinux.org)](https://wiki.archlinux.org/title/Network_configuration/Wireless)

```
█▓▒░root@king3399█▓▒░ Mon Aug 07 03:07:46pm
~/ iw dev wlan0 station dump
Station 3c:cd:57:f5:da:85 (on wlan0)
        inactive time:  0 ms
        rx bytes:       26025
        rx packets:     153
        tx bytes:       22842
        tx packets:     121
        tx failed:      0
        signal:         -63 dBm
        tx bitrate:     234.0 MBit/s
        rx bitrate:     390.0 MBit/s
        authorized:     yes
        authenticated:  yes
        associated:     yes
        WMM/WME:        yes
        TDLS peer:      no
        DTIM period:    1
        beacon interval:100
        short slot time:yes
        connected time: 60 seconds
        current time:   1691392108815 ms
█▓▒░root@king3399█▓▒░ Mon Aug 07 03:08:28pm
~/ iw dev wlan0 link
Connected to 3c:cd:57:f5:da:85 (on wlan0)
        SSID: ACSA-706-5G
        freq: 5240
        RX: 29153 bytes (171 packets)
        TX: 24932 bytes (142 packets)
        signal: -60 dBm
        rx bitrate: 390.0 MBit/s
        tx bitrate: 234.0 MBit/s

        bss flags:      short-slot-time
        dtim period:    1
        beacon int:     100
```

扫描wifi
```
iwlist wlan0 scan |grep ESSID    # 列出wifi
```


#### NetworkManger

GUI：基于GTK的**nm-connection-editor**
CLI：
- nmtui：使用起来很简单，可以编辑有线无线配置，激活连接等。
- nmcli：更加底层的命令行，功能还是很强大的

##### nmcli基本使用

```
nmcli conn
nmcli conn edit xxx
```

##### WPA2 Enterprise连接配置（eduroam）

WPA2 Enterprise导致的wifi无法连接问题[(7) Cannot Connect to College WIFI using NetworkManager : archlinux (reddit.com)](https://www.reddit.com/r/archlinux/comments/pb3r0f/cannot_connect_to_college_wifi_using/)
```
Failed to determine AP security information
```

[12.10 - Connect to a WPA2-Enterprise Connection via CLI (no desktop) - Ask Ubuntu](https://askubuntu.com/questions/262491/connect-to-a-wpa2-enterprise-connection-via-cli-no-desktop)

```bash
nmcli con add type wifi ifname wlan0 con-name eduroam ssid eduroam 

You may edit the following settings: connection, 802-11-wireless (wifi), 802-11-wireless-security (wifi-sec), 802-1x, ethtool, match, ipv4, ipv6, hostname, tc, proxy
nmcli> set 802-1x.eap peap
nmcli> set 802-1x.phase2-auth mschapv2
nmcli> set 802-1x.identity xxxxx
nmcli> set 802-1x.password xxxxx
nmcli> set wifi-sec.key-mgmt wpa-eap
nmcli> save
Connection 'eduroam' (ae79dc6c-b660-469d-9ecb-3a29504de969) successfully updated.
nmcli> activate
```

#### netplan连接wifi配置

[How to configure wifi in Ubuntu (linuxhint.com)](https://linuxhint.com/configure-wifi-ubuntu/)
```
# netplan yaml
network:
  version: 2
  renderer: networkd
  wifis:
      wlan0:
        optional: true
        dhcp4: true
        dhcp6: true
        access-points:
          "ustcnet": {}   # 没有密码
          "ssid2":
            password: "aaa"
```

通过iwconfig查看是否连接成功，出现ESSID则为成功
```
➜  ~ iwconfig wlan0
wlan0     IEEE 802.11  ESSID:"P2W_5G"
          Mode:Managed  Frequency:5.745 GHz  Access Point: 1C:40:E8:11:89:CF
          Bit Rate=234 Mb/s   Tx-Power=22 dBm
          Retry short limit:7   RTS thr:off   Fragment thr:off
          Power Management:on
          Link Quality=70/70  Signal level=-35 dBm
          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:7   Missed beacon:0
```


### 音乐

[USB Bluetooth passthrough KVM : VFIO (reddit.com)](https://www.reddit.com/r/VFIO/comments/q0oq9e/usb_bluetooth_passthrough_kvm/)
[The 5 Best Command Line Music Players for Linux (tecmint.com)](https://www.tecmint.com/command-line-music-players-for-linux/)
```
sudo apt install cmus
cmus

5 # 浏览当前文件夹
```

使用vlc
```
cvlc file.mp3
```

### 蓝牙

[Bluetooth - ArchWiki (archlinux.org)](https://wiki.archlinux.org/title/bluetooth)

命令行工具` bluetoothctl`

1.  (optional) Select a default controller with `select _MAC_address_`.
2.  (optional) Enter `power on` to turn the power to the controller on if the device is set to off. It is on by default; see [#Default adapter power state](https://wiki.archlinux.org/title/bluetooth#Default_adapter_power_state).
3.  Enter `devices` to get the MAC address of the device with which to pair.
4.  Enter device discovery mode with `scan on` command if device is not yet on the list.
5.  Turn the agent on with `agent on` or choose a specific agent: if you press tab twice after `agent` you should see a list of available agents. A bluetooth agent is what manages the Bluetooth 'pairing code'. It can either respond to a 'pairing code' coming in, or can send one out. The `default-agent` should be appropriate in most cases.[[1]](https://askubuntu.com/questions/763939/bluetoothctl-what-is-a-bluetooth-agent)
6.  Enter `pair _MAC_address_` to do the pairing (tab completion works).
7.  If using a device without a PIN, one may need to manually trust the device before it can reconnect successfully. Enter `trust _MAC_address_` to do so.
8.  Enter `connect _MAC_address_` to establish a connection.

# 网络
## network相关

### 网络配置方法
[NetworkConfiguration - Debian Wiki](https://wiki.debian.org/NetworkConfiguration)
- ifupdown
  - debian默认的方法
  - 配置文件为：`/etc/network/interfaces`
  - ifupdown2是新版，支持更加灵活的配置
- [NetworkManger](https://wiki.debian.org/NetworkManager)
  - 目标是尽可能保证连接到网络。使用自动的规则配置网络，比如检测到有线设备就会连接
  - 常用于桌面发行版
- systemd
  - 相关的服务：systemd-networkd, systemd-resolved
  - 配置文件位于`/etc/system/network`，使用类似于ini格式
- netplan
  - 常见于ubuntu，底层可以基于systemd-networkd或NetworkManager （服务器版和桌面版）
  - 是另一层抽象，使用自己的配置文件`/etc/netplan/`，使用yaml格式。

[networking - How exactly are NetworkManager, networkd, netplan, ifupdown2, and iproute2 interacting? - Unix & Linux Stack Exchange](https://unix.stackexchange.com/questions/475146/how-exactly-are-networkmanager-networkd-netplan-ifupdown2-and-iproute2-inter)

### 网络工具

[Chapter 5. Network setup (debian.org)](https://www.debian.org/doc/manuals/debian-reference/ch05.en.html)
- iproute2
- iptables
- ethtool
- mtr
- nmap
- tcpdump
- dnsutils: nslookup, dig

## dhcp

测试dhcp是否工作
- netplan（或者重启容器） + tcpdump  + wireshark

- -d: debug模式，前台运行
- -n: 不设置接口
- -s: 指定dhcp server（否则是广播）
```
 dhclient -d -n -w -s 192.168.35.1
```
## dns

### dig

```
dig [@server] [-p port] [-t type] [-4] [-6] [+trace] name
```
- @ 指定 DNS 查询使用的服务器名称或 IP ，IP 地址可以是用点分隔的 IPv4 地址也可以是冒号分隔的 IPv6 地址。当参数指定的值是服务器的主机名时，dig 命令会在查询该域名服务器前先解析该主机名；
- -p 指定 DNS 查询使用的端口号，默认情况下 DNS 查询使用标准的53端口，若使用非端口则需要通过 -p 参数指定，可使用此选项来测试已配置为侦听非标准端口号上的 DNS 服务器；
- -t 指定 DNS 查询的记录类型，常用的类型包括：A/AAAA/NS/MX/CNAME 等，缺省查询类型是 A ；
- -4 指定 dig 命令仅使用 IPv4 查询传输；
- -6 指定 dig 命令仅使用 IPv6 查询传输；
- **+trace** 跟踪从根名称服务器开始的迭代查询过程，缺省情况不使用跟踪。启用跟踪时，dig 命令会执行迭代查询以解析要查询的名称，显示来自用于解析查询的每个服务器的应答。

指定解析类型
- NS 记录：用来指定域名由哪个 DNS 服务器进行解析；
- CNAME 记录：用来定义域名的别名，方便实现将多个域名解析到同一个 IP 地址；
- A 记录：用来指定主机名对应的 IPv4 地址；
- AAAA 记录：用来指定主机名对应的 IPv6 地址；
- MX 记录：用来指定收件人域名的邮件服务器，SMTP 协议会根据 MX 记录的值来决定邮件的路由过程；
- PTR 记录：常用于反向地址解析，将 IP 地址解析到对应的名称；
- SOA 记录：称为起始授权机构记录，不同于 NS 记录用于标识多台域名解析服务器，SOA 记录用于在多台 NS 记录中哪一台是主 DNS 服务器。

USTC lug加群链接
```
dig jointele.ustclug.org TXT

;; ANSWER SECTION:
jointele.ustclug.org.   600     IN      TXT     "(base64) aHR0cHM6Ly90Lm1lLytYOXg1V09qTVpVbGlZVGRs"
```


### 查看上游dns

有多种dns设置方式：
- 直接编辑/etc/resolve设置上游dns
- systemd-resolve服务（自动设置dns）

```
systemd-resolve --status
```
从ubuntu22.04开始
```
resolvectl status
```

[systemd-resolve command not found in Ubuntu 22.04 desktop - Ask Ubuntu](https://askubuntu.com/questions/1409726/systemd-resolve-command-not-found-in-ubuntu-22-04-desktop)

## iptables

持久化
```
iptables-save > /etc/iptables/rules.v4  # 
ip6tables-save > /etc/iptables/rules.v6 
iptables-restore < /etc/iptables/rules.v4
```
安装iptabels-persistent

## 遇到的问题

### bridge iptable不生效

```
bridge-nf-call-iptables - BOOLEAN
	1 : pass bridged IPv4 traffic to iptables' chains.
	0 : disable this.
	Default: 1
```

# 系统维护

## ldap

[LDAP - ACSA Docs (acsalab.com)](https://docs.acsalab.com/ldap/)

```

```

## systemd

```shell
sudo systemctl list-units --type=service --state=running
```

## ssh证书

[SSH Certificate Authority - LUG @ USTC (ustclug.org)](https://docs.ustclug.org/infrastructure/sshca/)
[Managing servers with OpenSSH Certificate Authority - iBug](https://ibug.io/blog/2019/12/manage-servers-with-ssh-ca/)

- client验证server身份，需要将server公钥添加到known_hosts中。
  - 当有多个服务器时，client需要同意多次（ssh时的yes）
  - 当server公钥变更时，还得修改known_hosts
- server验证client身份，同样需要将client public key添加到known_hosts中。
  - 多个服务端和客户端，需要将每个client公钥复制到每个server。
  - 修改一个client需要修改所有server

SSH CA(Certificate Authority)是一对受信任的密钥，用于签发证书。
> An SSH Certificate Authority (CA) is a trusted key pair that issues certificates.

签发的证书可以用来授权client或者server。（通过信任host CA，client可以信任所有server，只要它们有host CA签名的证书。同样，通过信任user CA，server可以信任所有的client，只要它们有user CA签名的证书。）
> Certificates can be used for authentication on both the server side and the client side

SSH CA和X.509证书系统不同的是，证书无法签发新的证书（即无法嵌套）

**host CA和user CA可以是不同的，也可以是相同的。**

### SSH CA

#### 创建CA
和创建一个通常的密钥对一样。
```
 sudo ssh-keygen -f yfy_ca -t ed25519 -C "yfy CA"
```
- -t dsa | ecdsa | ecdsa-sk | ed25519 | ed25519-sk | rsa
- -C comment：添加到公钥结尾

#### 签发证书
```bash
ssh-keygen -s /path/to/ssh_ca \
           -I certificate_identity \
           -n principals \
          [-O options] \
          [-V validity_interval] \
           public_key_file
```

### 使用host CA授权server端

给server的公钥ssh_host_rsa_key.pub签名
```
ssh-keygen -s /path/to/ssh_ca \
           -I blog \
           -h \
           -n blog.s.ustclug.org,blog.p.ustclug.org,10.254.0.15,202.141.176.98,202.141.160.98 \
           ssh_host_rsa_key.pub
```
- -h 表示签发的是host证书（server端）
- -n 用于限制该证书只在提供的域名或者ip上有效。这样即使该证书被偷了，偷窃者也无法伪造我们的服务器。

添加到sshd配置中，这样client连接时会尝试提供该证书
```
# /etc/ssh/sshd_config
HostCertificate /etc/ssh/ssh_host_rsa_key-cert.pub
```

客户端信任CA机构
- 将CA公钥保存在my_ca.pub中
```
printf "@cert-authority * " | cat - my_ca.pub >> ~/.ssh/known_hosts
```
- 保存在dns中
  - 利用{command1 && command2 }将两条命令合并，将其输出重定向
```
{printf "@cert-authority * " && dig ca.yfycloud.top TXT +noall +answer | awk -F'TXT' '{print $NF}' |xargs} >> ~/.ssh/known_hosts
```
使用nslookup(windows bash下测试)
```
(printf "@cert-authority * " && nslookup -q=txt ca.yfycloud.top |grep CA | xargs) >> ~/.ssh/known_hosts
```

### 使用user CA授权client端

服务端信任user CA
```
TrustedUserCAKeys /etc/ssh/ssh_user_ca
```

给指定用户签发证书
```
ssh-keygen -s my_ca -I <user name> -n root,ubuntu id_rsa.pub
```
- 将生成的id_rsa-cert.pub放至id_rsa.pub同一目录，ssh连接服务端时会自动读取。
- -n用于限制允许登录的用户

## 包管理器apt

```
apt show pkg -a #查看包的所有仓库  # APT-Sources:
```

```
--no-install-recommends
```

### 查询文件

[linux - List of files installed from apt package - Server Fault](https://serverfault.com/questions/96964/list-of-files-installed-from-apt-package)
```
apt install apt-file
apt-file update
```

列出包的内容
- 已安裝包：`dpkg -L deb`
- 未安裝包：`apt-file list $package`
- 有deb文件：`dpkg --contents $package.deb`

查询文件位于哪个包中
```
dpkg -S /usr/bin/nvidia-xconfig
apt-file search /usr/bin/nvidia-xconfig
```

### 源优先级

按照nvidia官网下载了本地版本的cuda deb，安装后在`/var/cuda-repo-ubuntu2004-12-1-local`可以看到deb包。但是apt install时仍然采用了nvidia仓库的。
解决方法：
- 直接注释掉`/etc/apt/source.list`中的nvidia仓库，然后apt update
  - 也有可能source.list中没有developer.download.nvidia.com，那么禁用`/etc/apt/source.list.d/`下的在线cuda仓库。如
    `mv cuda-ubuntu2004-x86_64.list cuda-ubuntu2004-x86_64.list.bak`。

```
vim /etc/apt/preference.d/cuda-repository-pin-600

# Priority 越小优先级越高
Package: nsight-compute
Pin: origin *ubuntu.com*
Pin-Priority: -1

Package: nsight-systems
Pin: origin *ubuntu.com*
Pin-Priority: -1

Package: *
Pin: release l=NVIDIA CUDA
Pin-Priority: 600
```

```
➜  ~ apt-cache policy gnome-shell-extension-ubuntu-dock
gnome-shell-extension-ubuntu-dock:
  Installed: (none)
  Candidate: 72~ubuntu5.22.04.2.1
  Version table:
     72~ubuntu5.22.04.2.1 500
        500 http://mirrors.ustc.edu.cn/ubuntu jammy-updates/main amd64 Packages
     72~ubuntu5 500
        500 http://mirrors.ustc.edu.cn/ubuntu jammy/main amd64 Packages
```

## 用户管理

- adduser：交互式添加用户
  - useradd为更底层的命令
- usermod -aG sudo user：将用户添加到sudo组
- gpasswd -d user group: 将用户从组中删除

## linux分区

**使用fdisk给磁盘分区并挂载**

列出磁盘信息

```
sudo fdisk -l [device]
```

进入交互模式

```
sudo fdisk [device]

m	#帮助
p	#打印当前分区表
g	#创建gpt分区表
n	#创建分区
```

fdisk创建分区后

- 通过`mkfs.ext4 /dev/sdb1`创建文件ext4系统（*p.s. 注意：不要使用sdb，而是sdb1指定分区*）
```
mkfs.bfs     mkfs.cramfs  mkfs.ext2    mkfs.ext3    mkfs.ext4    mkfs.fat     mkfs.minix   mkfs.msdos   mkfs.ntfs    mkfs.vfat
```
- 通过`lsblk -f`显示UUID
  - `-f`表示打印文件系统
- 在`/etc/fstab`中添加挂载条目，然后`mount -a`表示挂载fstab中的所有条目
  示例
  ```
  UUID=b7ee63d0-6cea-4615-b7ec-63449c8fa566 /mnt/Disk1    ext4    defaults 0 0
  ```
- 修改挂载点目录权限，默认只有root用户可以访问

### swap

```
sudo dd if=/dev/zero of=/swapfile bs=1G count=16
sudo mkswap swapfile
sudo swapon swapfile

#fstab 
/swapfile none swap sw 0 0
```

### mount

[Fstab - Community Help Wiki (ubuntu.com)](https://help.ubuntu.com/community/Fstab)

mount只能由root用户操作，导致mount的目录所有者为root，普通用户无法访问

ext4 mount选项中也没有指定uid的方式挂载。[ext4(5) - Linux manual page (man7.org)](https://man7.org/linux/man-pages/man5/ext4.5.html#Mount_options_for_ext4)

解决办法是：mount之后使用chown命令将挂载的目录改为普通用户。**由于用户信息是写入文件系统的**，所以之后挂载时文件权限仍然是普通用户。

### 问题

#### 使用fdisk扩展分区

~~貌似就是fdisk先删除，再创建，保证起始位置一样。~~

尝试发现并不行，fdisk时确实会提示已经有ext4信息了，fdisk后也不用重新创建文件系统，但是mount时会报错。重新创建文件系统后文件便没了。

```
➜  /mnt sudo mount -a
mount: /mnt/Disk2: wrong fs type, bad option, bad superblock on /dev/sdb1, missing codepage or helper program, or other error.
```

#### Virtualbox将fix磁盘转换成动态磁盘

- Virtualbox命令行支持转换
- 转换后，更改磁盘大小后，发现未分配空间在磁盘中间。原因是，分区表是dos格式，产生了扩展分区。直接使用gparted工具进行扩展即可

  ```
  编号  起始点  结束点  大小    类型      文件系统  标志
   1    1049kB  538MB   537MB   primary   fat32     启动
   2    539MB   53.7GB  53.1GB  extended
   5    539MB   53.7GB  53.1GB  logical   ext4
  ```

## 日志/journalctl

[How To Use Journalctl to View and Manipulate Systemd Logs | DigitalOcean](https://www.digitalocean.com/community/tutorials/how-to-use-journalctl-to-view-and-manipulate-systemd-logs)

```
journalctl --list-boots
journalctl -b # 自上次reboot开始log
journalctl -b -1 # 上一次reboot

journalctl --since "2015-01-10" --until "2015-01-11 03:00"  # YYYY-MM-DD HH:MM:SS
journalctl --since yesterday

journalctl -k # 内核
```

### 日志文件

- `/run/log/journal/MACHINE-ID/`：存储在内存中，重启消失
- `/var/log/journal/MACHINE-ID`：存储在磁盘中

查看大小：
```
journalctl --disk-usage  # 日志大小，包含归档日志
```
![](https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20230326220602.png)

清除：
- vacuum：删除归档的日志（不会删除active的）
- rotate：将active归档。可以合并到上条命令
```
journalctl --rotate

journalctl --vacuum-time=1months  # 一个月以前的旧日志。格式：1m, 2h, 2weeks, 4months
journalctl --vacuum-size=100M     # 只保留新的100M大小的日志
```

设置最大日志大小：
```
/etc/systemd/journald.conf
SystemMaxUse=100M
```

SystemMaxUse=, RuntimeMaxUse=
> Enforce size limits on the journal files stored. The options prefixed with "System" apply to the journal files when stored on a persistent file system, more specifically /var/log/journal. The options prefixed with "Runtime" apply to the journal files when stored on a volatile in-memory file system, more specifically /run/log/journal.

MaxFileSec=
> The maximum time to store entries in a single journal file before rotating to the next one.

### 查看重启原因

https://unix.stackexchange.com/a/278166

```
last -x |tac |less  # last显示最后logged用户，tac将文本逆序
```

- 正常顺序：
  - reboot没有对应的shutdown表示非正常关机
```
shutdown system down  ... <-- first the system shuts down   
reboot   system boot  ... <-- afterwards the system boots
runlevel (to lvl 3)  # runlevel3表示无图形界面，开机桌面环境可能是runlevel 5
```
![](https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20230424194325.png)

### 查看crontab日志

```
grep CRON /var/log/syslog

jou -u cron
```

## 更换内核

### 编译

[8.10. Compiling a Kernel (debian-handbook.info)](https://debian-handbook.info/browse/stable/sect.kernel-compilation.html)

####  disabling the debug information

```
$ make deb-pkg LOCALVERSION=-falcot KDEB_PKGVERSION=$(make kernelversion)-1
[...]
$ ls ../*.deb
../linux-headers-5.10.46-falcot_5.10.46-1_amd64.deb
../linux-image-5.10.46-falcot_5.10.46-1_amd64.deb
../linux-image-5.10.46-falcot-dbg_5.10.46-1_amd64.deb
../linux-libc-dev_5.10.46-1_amd64.deb
```
> The whole process requires around 20 GB of free space, at least 8 GB of RAM, and several hours of compilation (utilizing one core) for a standard amd64 Debian kernel. These requirements can be drastically reduced by disabling the debug information using `CONFIG_DEBUG_INFO=n`, but this will make it impossible to trace kernel errors (“oops”) using `gdb` and also stop the creation of the linux-image-_version_-dbg package.

```
# 获得当前官方kernel编译配置，如/boot/config-5.19.0-35-generic
kernel_config=$(ls /boot/config-* | grep generic | sort -Vr | head -n 1) 
cp "${kernel_config}" .config

# 基于当前.confg，只询问新内核中新功能的配置
make oldconfig 

# 编译
make -j "$(nproc)" bindeb-pkg LOCALVERSION="${kernel_localversion}" || exit

# 安装
sudo dpkg -i ../linux-image-${kernel_version}${kernel_localversion}*.deb ../linux-headers-${kernel_version}${kernel_localversion}*.deb

# 更新grub，通过GRUB_DEFAULT选择编译的内核
vim /etc/default/grub
grub_line="GRUB_DEFAULT=\"Advanced options for Ubuntu>Ubuntu, with Linux ${kernel_version}${kernel_localversion}\""
sudo sed -i -e "s/^#GRUB_DEFAULT=.*/\0\n${grub_line}/" "${grub_config}"

sudo update-grub
```

#### missing certificate

> Building a custom kernel based on these settings will fail if `debian/certs/debian-uefi-certs.pem` does not exist. This file can either be obtained from the kernel team's Git repository and placed into the source tree, or it can be replaced by your own certificate(s), or you'll have to disable the setting via `CONFIG_SYSTEM_TRUSTED_KEYS=""`.

```
sed -i -e '/^CONFIG_SYSTEM_TRUSTED_KEYS=/ c\CONFIG_SYSTEM_TRUSTED_KEYS=\"\"' .config
sed -i -e '/^CONFIG_SYSTEM_REVOCATION_KEYS=/ c\CONFIG_SYSTEM_REVOCATION_KEY=\"\"' .config
```

### dkms

使用patched kernel后，没有了zfs，无法启动lxc。
[Ubuntu 20.04, building patched kernel results in no ZFS support - Ask Ubuntu](https://askubuntu.com/questions/1268519/ubuntu-20-04-building-patched-kernel-results-in-no-zfs-support)

https://debian-handbook.info/browse/stable/sect.kernel-compilation.html#sect.modules-build
- 一些模块不能打包到linux内核中
- 使用dkms自动化编译这些模块。需要安装了对应的`linux-headers-*`
> Compiling External Modules
> Some modules are maintained outside of the official Linux kernel. To use them, they must be compiled alongside the matching kernel.
> While we could manually extract the tarball and build the module, in practice we prefer to automate all this using the DKMS framework (Dynamic Kernel Module Support). Most modules offer the required DKMS integration in a package ending with a `-dkms` suffix.  In our case, installing dahdi-dkms is all that is needed to compile the kernel module for the current kernel provided that we have the linux-headers-* package matching the installed kernel. For instance, if you use linux-image-amd64, you would also install linux-headers-amd64.

```bash
sudo apt install zfs-dkms

dkms status
# zfs/2.1.5, 5.19.17, x86_64: installed

dkms build

dkms install
dkms uninstall  zfs/2.1.5

dkms add
dkms remove zenpower/$(VERSION)   --all
```

例子：[Ta180m/zenpower3: Migrated to Gitea (github.com)](https://github.com/Ta180m/zenpower3)
- 安装header
  - pve使用自己的内核，因此也是安装自己的header
```
apt install linux-headers-$(uname -r)

#pve
apt install proxmox-headers-$(uname -r)
```


```
dkms-install:
        dkms --version >> /dev/null
        mkdir -p $(DKMS_ROOT_PATH)
        cp $(CURDIR)/dkms.conf $(DKMS_ROOT_PATH)
        cp $(CURDIR)/Makefile $(DKMS_ROOT_PATH)
        cp $(CURDIR)/zenpower.c $(DKMS_ROOT_PATH)

        sed -e "s/@CFLGS@/${MCFLAGS}/" \
            -e "s/@VERSION@/$(VERSION)/" \
            -i $(DKMS_ROOT_PATH)/dkms.conf

        dkms add zenpower/$(VERSION)
        dkms build zenpower/$(VERSION)
        dkms install zenpower/$(VERSION)

dkms-uninstall:
        dkms remove zenpower/$(VERSION) --all
        rm -rf $(DKMS_ROOT_PATH)
```
### 删除内核

```
dpkg --get-selections | grep 5.19.17

apt remove xxx
```

或者手动删除
```
cd /boot/
rm -rf *3.19.8*

update-grub
```

## 内核模块

```
find /lib/modules/$(uname -r) -type f -name '*.ko'

modprobe xxx
modprobe -r xxx # 删除


lsmod |grep xxx
rmmod xxx
```

1. `depmod`: 用于更新内核模块依赖信息。`depmod` 命令会扫描系统中的内核模块，并为它们生成一个依赖关系文件，通常在 `/lib/modules/` 目录下。这个文件通常被命名为 `modules.dep`，它列出了每个模块及其依赖的其他模块，以确保内核模块正确加载和卸载。
    
2. `lsmod`: 用于列出当前加载到内核中的模块。`lsmod` 命令会显示已加载模块的列表，以及它们的大小、使用次数和依赖关系。
    
3. `modprobe`: 用于动态加载和卸载内核模块。`modprobe` 命令可以根据模块名称自动加载模块，并处理其依赖关系。它还可以用于卸载模块，或者通过参数指定模块选项。
    
4. `insmod`: 用于手动加载一个内核模块。`insmod` 命令可以直接加载指定的模块文件，但不会处理模块的依赖关系。因此，通常建议使用 `modprobe` 来加载模块，以确保正确处理依赖关系。
    
5. `rmmod`: 用于从内核中卸载一个已加载的模块。`rmmod` 命令接受模块名称作为参数，并会尝试卸载该模块，前提是它没有被其他模块所使用。
    
6. `modinfo`: 用于获取有关内核模块的信息。`modinfo` 命令可以列出有关模块的信息，如作者、描述、参数等。
    
7. `ls /lib/modules/`: 这个命令用于查看系统中可用的内核模块。在 `/lib/modules/` 目录下，你可以找到与已安装内核版本相关的模块文件和依赖信息。

# 硬件相关

## 关闭beep/bell

[Turn off beep / bell on linux terminal - Linux Tutorials - Learn Linux Configuration](https://linuxconfig.org/turn-off-beep-bell-on-linux-terminal)

## 查看CPU,cache

查看cache大小
- vim /proc/cpuinfo
  - cache_size不知道具体含义，L2/per core？
  - cache_alignment为L1 cache line大小?
```
cache size      : 512 KB
clflush size    : 64
cache_alignment : 64
address sizes   : 48 bits physical, 48 bits virtual
```

- lscpu
  - 很详细，可以看到cpu flag, numa, cache
```
Caches (sum of all):
  L1d:                   256 KiB (8 instances)
  L1i:                   256 KiB (8 instances)
  L2:                    4 MiB (8 instances)
  L3:                    32 MiB (1 instance)
NUMA:
  NUMA node(s):          1
  NUMA node0 CPU(s):     0-15
```

- getconf -a | grep CACHE
  - 可以看到cache line大小
```
LEVEL1_ICACHE_SIZE                 32768
LEVEL1_ICACHE_ASSOC
LEVEL1_ICACHE_LINESIZE             64
LEVEL1_DCACHE_SIZE                 32768
LEVEL1_DCACHE_ASSOC                8
LEVEL1_DCACHE_LINESIZE             64
LEVEL2_CACHE_SIZE                  524288
LEVEL2_CACHE_ASSOC                 8
LEVEL2_CACHE_LINESIZE              64
LEVEL3_CACHE_SIZE                  33554432
LEVEL3_CACHE_ASSOC                 0
LEVEL3_CACHE_LINESIZE              64
LEVEL4_CACHE_SIZE
LEVEL4_CACHE_ASSOC
LEVEL4_CACHE_LINESIZE
```

## lspci

```
apt install pciutils
```

### 常用选项
```
lspci -k  #查看内核驱动

lspci -nn #查看设备id

lspci -vv # 查看pcie链路速度：LnkCap, LnkSta
- 2.5 GT/s = PCI-e gen 1
- 5 GT/s = PCI-e gen 2
- 8 GT/s = PCI-e gen 3
```

### 指定设备

```
-s [[[[<domain>]:]<bus>]:][<device>][.[<func>]]
```
- domain: 0 to ffff
- bus: 0-ff
- device: 0-ff
- function: 0-7
- 可以省去或者设置为`*`表示任意值
```
-d [vendor]:[device][:class[:prog-if]]
```
- vendor: e.g. 10de
- device: : e.g. 1c02

### 查看树状结构
```
lspci -tv
```

- 03.1：是 slot and function number of the PCIe root hub
- [08]表示在其后面的设备的bus为08
- 00.0为device和function编号
```
+-03.1-[08]--+-00.0  NVIDIA Corporation GP106 [GeForce GTX 1060 3GB]
           |            \-00.1  NVIDIA Corporation GP106 High Definition Audio Controller
```

##  监控(温度、功耗)

### SSD温度

[Linux find NVMe SSD temperature using command line - nixCraft (cyberciti.biz)](https://www.cyberciti.biz/faq/linux-find-nvme-ssd-temperature-using-command-line/)

```
apt install nvme-cli

sudo nvme smart-log /dev/nvme0
```

### CPU频率、功耗

```
lscpu -e
CPU NODE SOCKET CORE L1d:L1i:L2:L3 ONLINE    MAXMHZ    MINMHZ      MHZ
  0    0      0    0 0:0:0:0           是 4850.1948 2200.0000 3023.077
  1    0      0    1 1:1:1:0           是 4850.1948 2200.0000 3167.647
  2    0      0    2 2:2:2:0           是 4850.1948 2200.0000 2529.517
  3    0      0    3 3:3:3:0           是 4850.1948 2200.0000 2895.147
  4    0      0    4 4:4:4:0           是 4850.1948 2200.0000 3068.640
  5    0      0    5 5:5:5:0           是 4850.1948 2200.0000 2814.150
  6    0      0    6 6:6:6:0           是 4850.1948 2200.0000 3097.454
  7    0      0    7 7:7:7:0           是 4850.1948 2200.0000 3148.684
  8    0      0    0 0:0:0:0           是 4850.1948 2200.0000 2938.599
  9    0      0    1 1:1:1:0           是 4850.1948 2200.0000 3376.774
 10    0      0    2 2:2:2:0           是 4850.1948 2200.0000 4420.665
 11    0      0    3 3:3:3:0           是 4850.1948 2200.0000 2996.655
 12    0      0    4 4:4:4:0           是 4850.1948 2200.0000 3100.166
 13    0      0    5 5:5:5:0           是 4850.1948 2200.0000 2894.990
 14    0      0    6 6:6:6:0           是 4850.1948 2200.0000 3244.797
 15    0      0    7 7:7:7:0           是 4850.1948 2200.0000 2897.287
```

[CPU frequency scaling - ArchWiki (archlinux.org)](https://wiki.archlinux.org/title/CPU_frequency_scaling)

查看功耗
```
sudo turbostat
```

## 音频

### ALSA

```
yfy@TianYi310 ➜  /dev aplay -l
**** PLAYBACK 硬體裝置清單 ****
card 0: PCH [HDA Intel PCH], device 0: CX20751/2 Analog [CX20751/2 Analog]
  子设备: 1/1
  子设备 #0: subdevice #0
card 0: PCH [HDA Intel PCH], device 3: HDMI 0 [HDMI 0]
  子设备: 1/1
  子设备 #0: subdevice #0
card 0: PCH [HDA Intel PCH], device 7: HDMI 1 [HDMI 1]
  子设备: 1/1
  子设备 #0: subdevice #0
card 0: PCH [HDA Intel PCH], device 8: HDMI 2 [HDMI 2]
  子设备: 1/1
  子设备 #0: subdevice #0
card 0: PCH [HDA Intel PCH], device 9: HDMI 3 [HDMI 3]
  子设备: 1/1
  子设备 #0: subdevice #0
card 0: PCH [HDA Intel PCH], device 10: HDMI 4 [HDMI 4]
  子设备: 1/1
  子设备 #0: subdevice #0
```

```
root@p2w \u@\h:\w\$ cat /proc/asound/modules
 0 snd_usb_audio
 
root@p2w \u@\h:\w\$ arecord -l
**** List of CAPTURE Hardware Devices ****
card 0: Lanseyaoji [Lanseyaoji], device 0: USB Audio [USB Audio]
  Subdevices: 1/1
  Subdevice #0: subdevice #0
```

#### arecord, aplay

arecord, aplay - command-line sound recorder and player for ALSA soundcard driver

`arecord -d 10 -f cd -t wav -D copy foobar.wav` will record foobar.wav as a 10-second, CD-quality wave file

aplay播放貌似只支持WAVE格式，mp3播放是噪音
```
yfy@TianYi310 ➜  Downloads aplay 'Laco - NEXUS.mp3'
正在播放 原始資料 'Laco - NEXUS.mp3' : Signed 16 bit Little Endian, 频率8000Hz， Mono
^C被信号 中断...退出
yfy@TianYi310 ➜  Downloads aplay filename.wav
正在播放 WAVE 'filename.wav' : Signed 16 bit Little Endian, 频率44100Hz， Stereo
```

##### aplay -l 没有设备

但是root用户有。这也导致pulseaudio list sinks时只有伪设备。

[alsa - How do I get sound with an HDA card? - Ask Ubuntu](https://askubuntu.com/questions/706602/how-do-i-get-sound-with-an-hda-card)
[audio - ALSA does not find sound devices as user but can as root after kernel upgrade - Super User](https://superuser.com/questions/469036/alsa-does-not-find-sound-devices-as-user-but-can-as-root-after-kernel-upgrade)

没有尝试参考1，而是直接修改了/dev/snd的权限777（添加用户到audio组没有作用），问题解决。

### PulseAudio

#### system-wide模式和per-user模式

推荐使用per-user模式，system-wide模式不安全。[Running PulseAudio as System-Wide Daemon – PulseAudio (www.freedesktop.org)](https://www.freedesktop.org/wiki/Software/PulseAudio/Documentation/User/SystemWide/)

per-user模式，每个用户需要使用时启动pulseaudio。system模式适合没有普通用户的嵌入式设备

#### 运行server

[Running (www.freedesktop.org)](https://www.freedesktop.org/wiki/Software/PulseAudio/Documentation/User/Running/)

有桌面环境情况下一般情况下会自动启动。也可以手动启动

```
pulseaudio --kill # 关闭pulseaudio server

pulseaudio # 运行在前台，ctrl-C结束。便于实时查看日志
pulseaudio --daemonize # daemon模式，运行在后台
pulseaudio -vv --log-time # 显示更多log
```

`~/.config/pulse/`优先级高于`/etc/pulse/`

- default.pa : **The default PulseAudio Startup Script** Commands in this file run when the daemon is started or restarted. Run `man default.pa` for documentation.
- daemon.conf: **The PulseAudio daemon configuration file** Run `man pulse-daemon.conf` for documentation.
- system.pa：仅用于system-wide模式

#### 控制命令pactl

[CLI (www.freedesktop.org)](https://www.freedesktop.org/wiki/Software/PulseAudio/Documentation/User/CLI/)

通过`pactl`命令和pulseaudio daemon进行交互

```
pactl list sources # 查看输入设备
pactl list sinks # 查看输出设备

# 调节音量
pactl set-sink-mute <device> toggle/true/false  # device tab自动补全
pactl set-sink-volume <device> 30%
```

#### 让麦克风输出到扬声器

[sound - How to hear my voice in speakers with a mic? - Ask Ubuntu](https://askubuntu.com/questions/123798/how-to-hear-my-voice-in-speakers-with-a-mic)

```
pactl load-module module-loopback latency_msec=1

# stop
pactl unload-module module-loopback
```

另一个办法直接使用alsa命令。
```
arecord -f cd - | aplay - # 延迟很高
arecord -f cd - | tee output.wav | aplay - #  play while saving

arecord --buffer-time=1 - | aplay --buffer-time=1 - # 改善延迟
```

##### 将指定source输出到指定sink

[Modules – PulseAudio (www.freedesktop.org)](https://www.freedesktop.org/wiki/Software/PulseAudio/Documentation/User/Modules/#module-loopback)

```
pactl load-module module-loopback latency_msec=1 source=2 sink=0  # 数字为index
```

#### 录指定应用声音

*p.s 关键点*
- 直接对输出到扬声器的声音录制，自己就听不到声音了。使用combined，对输出到headphone的声音复制一份，然后对其进行录制

参考：[Linux audio recording guide (ro-che.info)](https://ro-che.info/articles/2017-07-21-record-audio-linux)

1.  Create a “null” sink that you will be recording. Let’s call it `recording`.
2.  **Create a combined sink that will send its input to both headphones and the `recording` sink.** Otherwise, you will be able to record a stream but not hear it yourself. So, let’s call this sink `combined`.
3.  Direct the sound from the specific applications you want to record into the combined sink.
4.  Record the monitor of the `recording` sink to a file.

添加combined设备
```
pacmd load-module module-null-sink sink_name=recording sink_properties=device.description=recording
pacmd load-module module-combine-sink sink_name=combined sink_properties=device.description=combined \
  slaves=recording,alsa_output.pci-0000_00_1f.3.analog-stereo
```

将combined设置为默认输出，然后开始录制
```
parecord --channels=1 -d recording.monitor filename.wav
```

- parecord录制没有压缩，只能使用parecord录制吗？


### 音频网络串流

#### 参考

- linux 到安卓设备：[How to stream my GNU/Linux audio output to Android devices over WI-FI? - Super User](https://superuser.com/questions/605445/how-to-stream-my-gnu-linux-audio-output-to-android-devices-over-wi-fi)
- windows到linux：[Streaming audio from Windows to Linux using PulseAudio - Super User](https://superuser.com/questions/323329/streaming-audio-from-windows-to-linux-using-pulseaudio)
  - windows上安装音频驱动，linux上安装scream receiver：[duncanthrax/scream: Virtual network sound card for Microsoft Windows (github.com)](https://github.com/duncanthrax/scream)
- windows到android

- 手机到laptop, 通过pulseaudio：[How to stream audio from your phone to your laptop with PulseAudio | Hacker News (ycombinator.com)](https://news.ycombinator.com/item?id=24441112)

#### pulseaudio

[Network Setup – PulseAudio (www.freedesktop.org)](https://www.freedesktop.org/wiki/Software/PulseAudio/Documentation/User/Network/#index2h3)

##### direct模式

最简单的方式
- 在需要实际播放声音的设备上（server端），开启`module-native-protocol-tcp`允许网络连接。
- 然后在客户端上，设置PULSE_SERVER。这样客户端的声音就会交给服务端输出
  - 可以通过环境变量`PULSE_SERVER`
  - Alternatively you can modify `~/.pulse/client.conf` or `/etc/pulse/client.conf` and set `default-server`.
  ```
  export PULSE_SERVER=tcp:<server_ip>:4713
  ```

android上有pulse server软件：[XServer XSDL - Google Play 上的应用](https://play.google.com/store/apps/details?id=x.org.server)
- 延迟挺低的

##### tunnel模式

通过tunnel，可以创建一个新的sink，将所有音频通过网络发送到另一个server上（source也一样）。好处是可以无缝切换使用本地还是远程设备。

[Modules – PulseAudio (www.freedesktop.org)](https://www.freedesktop.org/wiki/Software/PulseAudio/Documentation/User/Modules/#module-tunnel-sinksource)

假设A，B两个机器，A有麦克风，B有扬声器。可以通过以下配置，让A获得B的扬声器，B获得A的麦克风。
```
# A
load-module module-native-protocol-tcp auth-anonymous=1
load-module module-tunnel-sink server=192.168.36.215

# B
load-module module-native-protocol-tcp auth-anonymous=1
load-module module-tunnel-source server=192.168.36.230
```

##### RTP

> RTP is the _Realtime Transfer Protocol_. It is a well-known protocol for transferring audio and video data over IP. Two related protocols are SDP and SAP. SDP is the _Session Description Protocol_ and can be used to describe RTP sessions. SAP is the _Session Announcement Protocol_ and can be used to announce RTP sessions that are described with SDP. (Modern SIP based VoIP phones use RTP/SDP for their sessions, too) All three protocols are defined in IETF RFCs (RFC3550, RFC3551, RFC2327, RFC2327). They can be used in both multicast and unicast fashions. PulseAudio exclusively uses multicast RTP/SDP/SAP containing audio data.

- 可以用于1对多，多对多等场景。
- RTP基于IP层的协议延迟可能更低？

- pulseaudio目前只支持LAN内。没法在跨LAN的两台设备中实现。
> **The current implementation is designed to be used exclusively in local area networks,** though Internet use is theoretically supported. Only uncompressed audio is supported, hence you won't be able to transmit more than a few streams at the same time over a standard LAN.

##### Rygel

> Your best bet is probably to setup a proper media server (like Rygel, which works well with Pulseaudio) to transcode the raw audio to something like MP3 and stream that instead.

##### 其它module

module-simple-protocol-tcp

An implementation of a simple protocol which allows playback by using simple tools like netcat. Just connect to the listening socket of this module and write the audio data to it, or read it from it for playback, resp. recording.

#### vlc进行http串流

- 优点：客户端不用安装软件，只需要打开浏览器
- 缺点：延迟有3-4s，不适用于播放视频场景

*关键点：source中默认有一个monitor的源，该源就可以获得输出到扬声器的声音*

```
cvlc -vvv pulse://XXXX --sout '#transcode{acodec=mp3,ab=128,channels=2}:standard{access=http,dst=0.0.0.0:8888/pc.mp3}'
```
设备上

```
http://your.local.ip.address:8888/pc.mp3
```

#### 各种串流

##### windows to linux

##### linux to anything

![](https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20230322144833.png)

## 视频

### v4l2

列出所有设备
```
root@tianyi ➜  ~ v4l2-ctl --list-devices
USB2 Video: USB2 Video (usb-0000:00:14.0-4):
        /dev/video2
        /dev/video3
        /dev/media1

EasyCamera: EasyCamera (usb-0000:00:14.0-5):
        /dev/video0
        /dev/video1
        /dev/media0
```

笔记本自带摄像头
```
root@tianyi ➜  ~ v4l2-ctl -d /dev/video0 --all
Driver Info:
        Driver name      : uvcvideo
        Card type        : EasyCamera: EasyCamera
        Bus info         : usb-0000:00:14.0-5
        Driver version   : 6.2.16
        Capabilities     : 0x84a00001
                Video Capture
                Metadata Capture
                Streaming
                Extended Pix Format
                Device Capabilities
        Device Caps      : 0x04200001
                Video Capture
                Streaming
                Extended Pix Format

Priority: 2
Video input : 0 (Input 1: ok)
Format Video Capture:
        Width/Height      : 640/480
        Pixel Format      : 'YUYV' (YUYV 4:2:2)
        Field             : None
        Bytes per Line    : 1280
        Size Image        : 614400
        Colorspace        : sRGB
        Transfer Function : Rec. 709
        YCbCr/HSV Encoding: ITU-R 601
        Quantization      : Default (maps to Limited Range)
        Flags             :
Crop Capability Video Capture:
        Bounds      : Left 0, Top 0, Width 640, Height 480
        Default     : Left 0, Top 0, Width 640, Height 480
        Pixel Aspect: 1/1
Selection Video Capture: crop_default, Left 0, Top 0, Width 640, Height 480, Flags:
Selection Video Capture: crop_bounds, Left 0, Top 0, Width 640, Height 480, Flags:
Streaming Parameters Video Capture:
        Capabilities     : timeperframe
        Frames per second: 30.000 (30/1)
        Read buffers     : 0

```

采集卡
```
root@tianyi ➜  ~ v4l2-ctl -d /dev/video2 --all
Driver Info:
        Driver name      : uvcvideo
        Card type        : USB2 Video: USB2 Video
        Bus info         : usb-0000:00:14.0-4
        Driver version   : 6.2.16
        Capabilities     : 0x84a00001
                Video Capture
                Metadata Capture
                Streaming
                Extended Pix Format
                Device Capabilities
        Device Caps      : 0x04200001
                Video Capture
                Streaming
                Extended Pix Format
Priority: 2
Video input : 0 (Input 1: ok)
Format Video Capture:
        Width/Height      : 2560/1600
        Pixel Format      : 'MJPG' (Motion-JPEG)
        Field             : None
        Bytes per Line    : 0
        Size Image        : 8192000
        Colorspace        : sRGB
        Transfer Function : Rec. 709
        YCbCr/HSV Encoding: ITU-R 601
        Quantization      : Default (maps to Full Range)
        Flags             :
Crop Capability Video Capture:
        Bounds      : Left 0, Top 0, Width 2560, Height 1600
        Default     : Left 0, Top 0, Width 2560, Height 1600
        Pixel Aspect: 1/1
Selection Video Capture: crop_default, Left 0, Top 0, Width 2560, Height 1600, Flags:
Selection Video Capture: crop_bounds, Left 0, Top 0, Width 2560, Height 1600, Flags:
Streaming Parameters Video Capture:
        Capabilities     : timeperframe
        Frames per second: 30.000 (30/1)
        Read buffers     : 0
```


# 其它软件

## zerotier

```
curl -s https://install.zerotier.com | sudo bash
```

join network
```
% zerotier-cli info
200 info 8af72edda7 1.10.2 ONLINE

% zerotier-cli join d5e04297a16fa690
200 join OK
```


### 非snap安装chromium
[Chromium - web browser (Xenial & newer) : Rob Savoury (launchpad.net)](https://launchpad.net/~savoury1/+archive/ubuntu/chromium)
