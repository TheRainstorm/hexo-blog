---
title: 2023-09-15-PVE
date: 2023-09-15 20:31
tags:
  - pve
categories:
  - homelab
  - è™šæ‹ŸåŒ–
---
PVEç”¨æ³•ã€é…ç½®ä¸ªäººè®°å½•

<!-- more -->

## å®‰è£…

å®‰è£…æ³¨æ„äº‹é¡¹
- ä¹‹åä¿®æ”¹hostnameå¾ˆéº»çƒ¦ï¼Œå› æ­¤ä¸€å¼€å§‹å°±ç¡®å®šå¥½
- zfsæ˜¯æˆ‘æ¯”è¾ƒæ¨èçš„ç³»ç»Ÿç›˜æ ¼å¼ï¼Œåé¢åˆ›å»ºè™šæ‹Ÿæœºï¼Œlxcå®¹å™¨ï¼Œç£ç›˜é•œåƒéƒ½ä¼šç›´æ¥ä½¿ç”¨zfsçš„zvolåŠŸèƒ½ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨zfsè‡ªå·±ç®¡ç†è¿™äº›ç£ç›˜é•œåƒï¼Œéå¸¸æ–¹ä¾¿ã€‚

æ¢æºï¼š[Proxmox æºä½¿ç”¨å¸®åŠ© â€” USTC Mirror Help æ–‡æ¡£](http://mirrors.ustc.edu.cn/help/proxmox.html)

å¸¸ç”¨å‘½ä»¤å·¥å…·ï¼š[Command Line Tools - Proxmox VE](https://pve.proxmox.com/wiki/Command_Line_Tools)

## PVEé…ç½®
### ç½‘ç»œé…ç½®

ç½‘ç»œé‡‡ç”¨ifupdown
```
/etc/network/interfaces

ifreload -a  # åº”ç”¨æ›´æ”¹
```

- åˆ›å»ºä¸¤ä¸ªbrï¼Œå±…ç„¶ä¸æ”¯æŒè®¾ç½®ä¸¤ä¸ªdefault routeã€‚è§£å†³åŠæ³•æ˜¯åœ¨interfaceé…ç½®æ–‡ä»¶ä¸­é€šè¿‡post-upè‡ªå·±æ·»åŠ 
```
auto vmbr0
iface vmbr0 inet static
        address 210.45.76.204/24
        bridge-ports enp7s0
        bridge-stp off
        bridge-fd 0
        post-up ip ru add from 210.45.76.204 lookup vmbr0 prior 3
        post-up ip ro add table vmbr0 default via 210.45.76.254 dev vmbr0
        post-up ip ro add default via 210.45.76.254 dev vmbr0 metric 200

auto vmbr1
iface vmbr1 inet static
        address 192.168.35.254/24
        bridge-ports enxf8e43b0a274a
        bridge-stp off
        bridge-fd 0
        post-up ip ro add default via 192.168.35.1 dev vmbr1 metric 100
        pre-down ip ro del default dev vmbr1
```

### å­˜å‚¨é…ç½®

[Proxmox VE Storage](https://pve.proxmox.com/pve-docs/chapter-pvesm.html)
#### åŸºç¡€æ¦‚å¿µ

storageï¼ˆæ± ï¼‰ç±»å‹
- file levelï¼šå¯ä»¥å­˜å‚¨ä»»ä½•ç±»å‹å†…å®¹
- blockï¼šå­˜å‚¨å¤§çš„raw images
> 1: Disk images for VMs are stored in ZFS volume (zvol) datasets, which provide block device functionality.
> 2: On file based storages, snapshots are possible with theÂ _qcow2_Â format.

å­˜å‚¨çš„æ•°æ®ç±»å‹

A storage can support several content types, for example virtual disk images, cdrom iso images, container templates or container root directories. Not all storage types support all content types. One can set this property to select what this storage is used for.
- images: QEMU/KVM VM images.
- rootdir: Allow to store container data.
- vztmpl: Container templates.
- backup: Backup files (vzdump).
- iso: ISO images
- snippets: Snippet files, for example guest hook scripts

#### é…ç½®æ–‡ä»¶

/etc/pve/storage.cfg
```
dir: local
        path /var/lib/vz
        content iso,vztmpl,backup
        
# default image store on ZFS based installation
zfspool: local-zfs
        pool rpool/data
        sparse
        content images,rootdir
```

**localæ›´åƒæ˜¯å­˜å‚¨åªè¯»çš„æ•°æ®**
**local-zfsåˆ™å­˜æ”¾è¯»å†™çš„æ•°æ®**
- è™šæ‹Ÿæœºçš„diskä¸ºzvol
- lxcå®¹å™¨çš„rootdirä¸ºdataset

Volume idæ ¼å¼ï¼ˆè®¸å¤šå‘½ä»¤éƒ½éœ€è¦è¯¥æ ¼å¼å‚æ•°ï¼‰
```
local:230/example-image.raw

local:iso/debian-501-amd64-netinst.iso

local:vztmpl/debian-5.0-joomla_1.5.9-1_i386.tar.gz

iscsi-storage:0.0.2.scsi-14f504e46494c4500494b5042546d2d646744372d31616d61
```
#### å‘½ä»¤è¡Œå·¥å…·

```
pvesm add <TYPE> <STORAGE_ID> <OPTIONS>
pvesm add dir <STORAGE_ID> --path <PATH>
pvesm add nfs <STORAGE_ID> --path <PATH> --server <SERVER> --export <EXPORT>
pvesm add lvm <STORAGE_ID> --vgname <VGNAME>
pvesm add iscsi <STORAGE_ID> --portal <HOST[:PORT]> --target <TARGET>

pvesm set <STORAGE_ID> <OPTIONS>
pvesm set <STORAGE_ID> --shared 1
pvesm set local --format qcow2
pvesm set <STORAGE_ID> --content iso

pvesm alloc <STORAGE_ID> <VMID> <name> <size> [--format <raw|qcow2>]
pvesm alloc local <VMID> '' 4G  # nameä¸ºç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆ

pvesm free <VOLUME_ID>

pvesm status
pvesm list <STORAGE_ID> [--vmid <VMID>]

pvesm path <VOLUME_ID> #æŸ¥çœ‹å®é™…è·¯å¾„
```

#### ä¸åŒbackend

##### dir

å¯ä»¥å­˜å‚¨ä»»ä½•ç±»å‹æ•°æ®ï¼ˆvirtual disk images, containers, templates, ISO images or backup files.ï¼‰


> You can mount additional storages via standard linuxÂ /etc/fstab, and then define a directory storage for that mount point. This way you can use any file system supported by Linux.

é»˜è®¤layout

|Content type|Subdir|
|---|---|
|VM images|`images/<VMID>/`|
|ISO images|template/iso/|
|Container templates|template/cache/|
|Backup files|dump/|
|Snippets|snippets/|

ä¾‹å­
```
dir: backup
        path /mnt/backup
        content backup
        prune-backups keep-last=7
        max-protected-backups 3
        content-dirs backup=custom/backup/dir
```
##### zfs

##### lvm
[Proxmox VE Storage](https://pve.proxmox.com/pve-docs/chapter-pvesm.html#storage_lvm)
[Proxmox Storage Guide | Programster's Blog](https://blog.programster.org/proxmox-storage-guide)

|Content types|Image formats|Shared|Snapshots|Clones|
|---|---|---|---|---|
|images rootdir|raw|possible|no|no|

##### lvm-thin

æ”¯æŒthin provisioningï¼ˆç¨€ç–åˆ†é…ï¼‰

LVM normally allocates blocks when you create a volume. LVM thin pools instead allocates blocks when they are written. This behaviour is called thin-provisioning
## è™šæ‹Ÿæœº

### å‘½ä»¤è¡Œ

[qm(1) (proxmox.com)](https://pve.proxmox.com/pve-docs/qm.1.html)

ä¸å¿…å¡«æ‰€æœ‰å‚æ•°ï¼Œåˆ›å»ºååœ¨webä¸­å†æ·»åŠ 
```
qm create 120 --cores 2 --cpu host --memory 1024 --name u22-test --scsihw virtio-scsi-single --scsi0 local-zfs:vm-120-disk-root 
```
### ç›´é€šç£ç›˜

[Passthrough Physical Disk to Virtual Machine (VM) - Proxmox VE](https://pve.proxmox.com/wiki/Passthrough_Physical_Disk_to_Virtual_Machine_(VM))

å¾ˆç®€å•ï¼Œä¸éœ€è¦pciç›´é€šä¹‹ç±»çš„ã€‚æœ¬è´¨ä¸Šå’Œkvmæ·»åŠ ä¸€ä¸ªç£ç›˜æ˜¯ä¸€æ ·çš„
- ç£ç›˜åªçœ‹åšä¸€ä¸ªå—æ–‡ä»¶ï¼Œå†…éƒ¨ä¼šé‡æ–°åˆ›å»ºåˆ†åŒºè¡¨ï¼Ÿ

- Hot-Plug/Add physical device as new virtual SCSI disk
```
qm set 592 -scsi2 /dev/disk/by-id/ata-ST3000DM001-1CH166_Z1F41BLC
```

- Hot-Unplug/Remove virtual disk
```
qm unlink 592 --idlist scsi2
```
#### ç›´é€šåˆ†åŒº

åªéœ€è¦æŠŠä¸Šé¢by-idè·¯å¾„æŒ‡å®šå…·ä½“åˆ†åŒºå³å¯

[Is it possible to passthrough a partition of a drive to a VM? and not the entire disk? | Proxmox Support Forum](https://forum.proxmox.com/threads/is-it-possible-to-passthrough-a-partition-of-a-drive-to-a-vm-and-not-the-entire-disk.109974/)

> I think "qm set" disk passthrough should work with partitions too:  
[https://pve.proxmox.com/wiki/Passthrough_Physical_Disk_to_Virtual_Machine_(VM)](https://pve.proxmox.com/wiki/Passthrough_Physical_Disk_to_Virtual_Machine_(VM))  
Then its just for exampleÂ `qm set 592 -scsi2 /dev/disk/by-id/ata-ST3000DM001-1CH166_Z1F41BLC-part3`Â instead ofÂ `qm set 592 -scsi2 /dev/disk/by-id/ata-ST3000DM001-1CH166_Z1F41BLC`


### æ˜¾ç¤ºè®¾å¤‡

#### ä»‹ç»

[VGA and other display devices in qemu | ğŸ‡ºğŸ‡¦ kraxelâ€™s news](https://www.kraxel.org/blog/2019/09/display-devices-in-qemu/)

qxl
- æ”¯æŒ2dåŠ é€Ÿï¼Œä½†æ˜¯è¯¥åŠŸèƒ½ç°åœ¨å·²ç»å˜å¾—ä¸å†æœ‰ç”¨äº†ã€‚è½¯ä»¶é€šå¸¸ä½¿ç”¨OpenGLæˆ–Vulkanï¼Œ3dæ¸²æŸ“ã€‚
> This device has support for 2D acceleration. This becomes more and more useless though as modern display devices don't have dedicated 2D acceleration support any more and use the 3D engine for everything. The same happens on the software side, modern desktops are rendering with opengl or vulkan instead of using 2D acceleration.

virtio vga
- æ”¯æŒç¡¬ä»¶è¾…ç»„çš„openglåŠ é€Ÿ
- ç›®å‰åªæœ‰linuxä¸‹æœ‰é©±åŠ¨ï¼Œå› æ­¤åªåœ¨linuxå·¥ä½œ
> This device has (optional) hardware-assisted opengl acceleration support. This can be enabled using theÂ `virgl=on`Â property, which in turn needs opengl support enabled (`gl=on`) in the qemu display.

#### virgl

[(7) VirGL vs GPU passthrough vs VirtIO or QXL : VFIO (reddit.com)](https://www.reddit.com/r/VFIO/comments/ufseh1/virgl_vs_gpu_passthrough_vs_virtio_or_qxl/)

> ä¸ºäº†æ˜¾ç¤º 3D å›¾å½¢ï¼Œæ¸¸æˆéœ€è¦ä¸º GPU æ‰“å¼€ä¸€ä¸ªâ€œä¸Šä¸‹æ–‡â€ã€‚ï¼ˆæ— è®ºæ˜¯Direct3Dï¼ŒOpenGLï¼ŒVulkanç­‰ï¼‰ã€‚æ‰“å¼€æ­¤ä¸Šä¸‹æ–‡åï¼Œä»–ä»¬å¯ä»¥å‘ GPU å‘é€å‘½ä»¤ä»¥ä¸Šä¼ çº¹ç†ã€è¿è¡Œç€è‰²å™¨ã€æ¸²æŸ“å†…å®¹ç­‰ã€‚
> VirGLå…è®¸è®¿å®¢åœ¨ä¸»æœºçš„GPUä¸Šæ‰“å¼€è¿™äº›ä¸Šä¸‹æ–‡ã€‚ä¸ºæ­¤ï¼Œå®ƒéœ€è¦åœ¨ VM ä¸­æ‹¥æœ‰è‡ªå·±çš„ç‰¹æ®Šé©±åŠ¨ç¨‹åºï¼Œè¿™äº›é©±åŠ¨ç¨‹åºç‹¬ç«‹äºåº•å±‚ GPU ç±»å‹ã€‚
> æœªæ¥å¾ˆå¯èƒ½æ˜¯Â GPU-P (or GPU partitioning).ã€‚æ­¤åŠŸèƒ½å…è®¸ç‰©ç† GPU æä¾›å¤šä¸ªè™šæ‹Ÿåˆ†åŒºï¼Œå…è®¸ä¸»æœºå’Œæ¥å®¾ä½¿ç”¨ç›¸åŒçš„ç‰©ç† GPUã€‚æœ‰å‡ ç§æ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼Œä½†ç›®å‰å®ƒä¸å—å®˜æ–¹æ”¯æŒï¼ˆåœ¨æ¶ˆè´¹è€…å¡ä¸­ï¼‰ã€‚


é€‚åˆè½»é‡çš„3dåŠ é€Ÿï¼ˆæ¡Œé¢compositorï¼‰
> if you need 3D accel (eg even for desktop compositor effects, no heavy gaming) this is what you want. Otherwise you go with Intel GVT-g or full GPU passthrough.

ç›®å‰è¿˜ä¸æ”¯æŒHW Videoç¼–è§£ç åŠ é€Ÿ
> One feature I would like is being able to use HW video decode too, but presently that requires passing in full GPU or vGPU.

è®¾ç½®åï¼Œåœ¨win10ä¸­æ ·å­
![image.png](https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20231002160224.png)

![image.png](https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20231002161058.png)

å¯ä»¥ç©ç®€å•OpenGLæ¸¸æˆï¼šæµ‹è¯•äº†ä¸œæ–¹
ä¸èƒ½ç©yuzuæ¨¡æ‹Ÿå™¨ï¼Œé€‰æ‹©OpenGLæ—¶ï¼Œå¯ä»¥é€‰æ‹©GLSLï¼Œä½†æ˜¯ä¸èƒ½è¿è¡Œæ¸¸æˆã€‚é€‰vulkanæ²¡æœ‰è®¾å¤‡ã€‚
### éšè—KVM

è‘—åäºŒå­—æ¸¸æˆæ— æ³•åœ¨è™šæ‹Ÿæœºä¸­è¿è¡Œ
![åŸç¥æ— æ³•è™šæ‹Ÿæœºå¯åŠ¨.jpg](https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/%E5%8E%9F%E7%A5%9E%E6%97%A0%E6%B3%95%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%90%AF%E5%8A%A8.jpg)


https://forum.proxmox.com/threads/hide-vm-from-guest.34905/post-176978
```
args: -cpu 'host,-hypervisor,+kvm_pv_unhalt,+kvm_pv_eoi,hv_spinlocks=0x1fff,hv_vapic,hv_time,hv_reset,hv_vpindex,hv_runtime,hv_relaxed,kvm=off,hv_vendor_id=intel'
```
> Guest operating systems can test bit 31 of ECX of CPUID leaf 0x1, soÂ **-hypervisor**Â flag prevent this.  
I can't add linksÂ ![:(](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 "Frown    :("). You can read more about virtual machine detection mechanism in vmware knowledge base. Article is called "Mechanisms to determine if software is running in a VMware virtual machine"

æ›´æ–°ä¸€ç‚¹çš„2022
[Can't hide 'VM' status in Windows guest | Proxmox Support Forum](https://forum.proxmox.com/threads/cant-hide-vm-status-in-windows-guest.96779/)
> In VM config:  
args: -cpu host,hv_vapic,hv_stimer,+invtsc,[more-flags],-hypervisor

ç»å°è¯•ä¸Šé¢çš„å‘½ä»¤å¯åŠ¨æ—¶ä¼šæŠ¥é”™ï¼Œéœ€è¦æ·»åŠ æ›´å¤šflag
```
root@ryzen-pve âœ  ~ qm start 200
kvm: Hyper-V synthetic timers (hv-stimer) requires Hyper-V clocksources (hv-time)
start failed: QEMU exited with code 1
root@ryzen-pve âœ  ~ vim /etc/pve/qemu-server/200.conf
root@ryzen-pve âœ  ~ qm start 200
kvm: Hyper-V synthetic timers (hv-stimer) requires Hyper-V synthetic interrupt controller (hv-synic)
start failed: QEMU exited with code 1
root@ryzen-pve âœ  ~ vim /etc/pve/qemu-server/200.conf
root@ryzen-pve âœ  ~ qm start 200
kvm: Hyper-V synthetic interrupt controller (hv-synic) requires Hyper-V VP_INDEX MSR (hv-vpindex)
start failed: QEMU exited with code 1
```

æœ€åéœ€è¦è¡¥å……å®Œæ•´åˆ°
```
args: -cpu host,hv_vapic,hv_stimer,hv_time,hv_synic,hv_vpindex,+invtsc,-hypervisor
```
æ³¨æ„ï¼Œä¸è¦å†åŠ cpu: x86-64-v3è¿™æ ·çš„å‚æ•°äº†ã€‚æˆ‘åˆšå¼€å§‹åŠ äº†ï¼Œå¯¼è‡´è¿›å…¥vmï¼ŒNå¡é©±åŠ¨æŠ¥43é”™è¯¯

å…¶å®ƒ
- virt-mangerä¸­ç±»ä¼¼æ–¹æ³•ï¼š[æ±‚åŠ©ï¼win11 wm æ‰“å¼€åŸç¥ æ˜¾ç¤ºè™šæ‹Ÿæœºä¸‹æ— æ³•è¿è¡Œ - Chinese / ç®€ä½“ä¸­æ–‡ - Unraid](https://forums.unraid.net/topic/126098-%E6%B1%82%E5%8A%A9%EF%BC%81win11-wm-%E6%89%93%E5%BC%80%E5%8E%9F%E7%A5%9E-%E6%98%BE%E7%A4%BA%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%8B%E6%97%A0%E6%B3%95%E8%BF%90%E8%A1%8C/)
- [Proxmox VE(PVE)è™šæ‹Ÿæœºç»•è¿‡è½¯ä»¶çš„è™šæ‹Ÿæœºæ£€æŸ¥æ¥ç©åŸç¥ - æŸå’¸é±¼çš„ç¬”è®° (wunote.cn)](https://www.wunote.cn/article/4801/)
## LXCå®¹å™¨

https://pve.proxmox.com/wiki/Linux_Container

### å®¹å™¨é•œåƒ

```
 pveam update
 pveam available
pveam available --section system

pveam download local debian-10.0-standard_10.0-1_amd64.tar.gz
```

å¯¼å…¥å®¹å™¨é•œåƒ
åªèƒ½é€šè¿‡webui upload?

### PCTå‘½ä»¤è¡Œ

[Linux Container - Proxmox VE](https://pve.proxmox.com/wiki/Linux_Container#_managing_containers_with_tt_span_class_monospaced_pct_span_tt)

```
pct list
pct console <vmid> [OPTIONS]
pct enter <vmid>

pct start

pct destroy 100 --purge # --purge_, if you want to additionally remove the container from replication jobs, backup jobs and HA resource configurations.
```

```
# pct set 100 -net0 name=eth0,bridge=vmbr0,ip=192.168.15.147/24,gw=192.168.15.1
```

[pct(1) (proxmox.com)](https://pve.proxmox.com/pve-docs/pct.1.html)
TASK ERROR: unable to create CT 100 - unable to detect OS distribution
```
pct create 100 /mnt/ryzen-pve-storage/template/cache/openwrt-23.05.0-x86-64-rootfs.tar.gz \
--storage local-lvm \
--ostype unmanaged \
--unprivileged 1 \
--hostname op1 \
--rootfs local-lvm:8 \
--cores 4 \
--memory 1024 \
--swap 1024 \
--features keyctl=1,nesting=1

--password xxxx

```

```
pct create 700 local:vztmpl/openwrt-23.05.0-x86-64-generic-rootfs.tar.gz \
--storage local-zfs \
--ostype unmanaged \
--unprivileged 1 \
--hostname op1 \
--rootfs local-zfs:1 \
--cores 4 \
--memory 1024 \
--swap 0 \
--features keyctl=1,nesting=1
```

_unmanaged_Â can be used to skip and OS specific setup
### é…ç½®æ–‡ä»¶

```
/etc/pve/lxc/<CTID>.conf
```

Currently there are three types of mount points: storage backed mount points, bind mounts, and device mounts.
- Storage Backed Mount Points
    - Image based
    - ZFS subvolumes
    - Directories
```
pct set 100 -mp0 thin1:10,mp=/path/in/container
```

- Bind Mount Pointsï¼šBind mounts allow you to access arbitrary directories from your Proxmox VE host inside a container
```
pct set 100 -mp0 /mnt/bindmounts/shared,mp=/shared
```

### ç‰¹æƒå®¹å™¨

#### ç‰¹æƒå®¹å™¨è½¬éç‰¹æƒå®¹å™¨

[Convert privileged to unprivileged container | Proxmox Support Forum](https://forum.proxmox.com/threads/convert-privileged-to-unprivileged-container.31066/)
```
pct restore 1234 var/lib/vz/dump/vzdump-lxc-1234-2016_03_02-02_31_03.tar.gz -ignore-unpack-errors 1 -unprivileged
```

è½¬ä¸ªç‰¹æƒçº§ç»“æœè¿™ä¹ˆéº»çƒ¦ã€‚[community](https://forum.proxmox.com/threads/convert-privileged-to-unprivileged-container.31066/post-261883)æœ‰é€šè¿‡æŒ‚è½½é•œåƒï¼Œç„¶åä¿®æ”¹å…¶å†…å®¹çš„æ–¹æ³•ï¼Œä½†æ˜¯çœ‹ä¸Šå»è²Œä¼¼æœ‰ç‚¹é‡ï¼Œå› æ­¤è¿˜æ˜¯ä¸ä½¿ç”¨äº†ã€‚

å°è¯•äº†
- ç¼–è¾‘é…ç½®æ–‡ä»¶ç›´æ¥æ·»åŠ unprivileged: yesã€‚ä½†æ˜¯æ‰“å¼€å®¹å™¨åï¼Œæ‰€æœ‰æ–‡ä»¶éƒ½å˜æˆäº†nobodyã€‚ï¼ˆä¹Ÿè®¸æ‰‹åŠ¨chownä»¥ä¸‹å°±å¯ä»¥äº†ï¼Ÿï¼‰
- å°è¯•æŒ‰ç…§å®˜æ–¹é€šè¿‡backupæ¢å¤ã€‚
  - ä½†æ˜¯æ¢å¤åï¼Œjellyfin dockerå¯åŠ¨ä¸èµ·æ¥ï¼Œè²Œä¼¼æ˜¯æƒé™çš„é—®é¢˜ã€‚jellyfiné…ç½®æ–‡ä»¶ä¸çŸ¥ä¸ºä½•å°±æ˜¯æ— æ³•chownï¼Œrootç”¨æˆ·chownç»“æœæŠ¥æ²¡æœ‰æƒé™ã€‚
```
pct restore 111 /var/lib/vz/dump/vzdump-lxc-110-2023_09_29-23_05_38.tar.zst -ignore-unpack-errors 1 -unprivileged --features keyctl=1,nesting=1  --storage local-zfs
```

ç®—äº†ï¼Œè¿˜æ˜¯ç”¨åŸæ¥ç‰¹æƒå®¹å™¨ã€‚
### è·¯å¾„æ˜ å°„ï¼ˆæŒ‚è½½ï¼‰

å‚è€ƒ
  - [Proxmox: bind mountpoint from host to unprivileged LXC container :: It's Embedded! (itsembedded.com)](https://itsembedded.com/sysadmin/proxmox_bind_unprivileged_lxc/)
  - [Unprivileged LXC containers - Proxmox VE](https://pve.proxmox.com/wiki/Unprivileged_LXC_containers)

Bind mountingï¼šç±»ä¼¼äºç›®å½•çš„ç¡¬é“¾æ¥ï¼ˆlinuxç›®å½•ä¸èƒ½ç¡¬é“¾æ¥ï¼‰

ç›´æ¥æ˜ å°„ï¼ˆåŸºæœ¬ä¸Šåªè¯»ï¼‰
- éœ€è¦é‡å¯å®¹å™¨ç”Ÿæ•ˆ
- hoståˆ›å»ºçš„æ–‡ä»¶åœ¨guestä¸­ä¸ºnobodyï¼ˆåªè¦æ–‡ä»¶æƒé™ä¸ä¸¥æ ¼ï¼Œåº”è¯¥æ˜¯å¯è¯»çš„ï¼‰
- gueståˆ›å»ºçš„æ–‡ä»¶åœ¨hostä¸Šä¸ºhigh-mapped(100000+)  uid
```
# pctå‘½ä»¤
pct set 300 -mp0 /mnt/Disk2/BT/downloads/links,mp=/media

# é…ç½®æ–‡ä»¶
mp0: /mnt/bindmounts/shared,mp=/shared
```
#### ç”¨æˆ·æ˜ å°„

ç¼–è¾‘å®¹å™¨é…ç½®æ–‡ä»¶
- 0 100000 1005è¡¨ç¤º0å¼€å§‹çš„1005é•¿åº¦æ®µæ˜ å°„åˆ°host 10000å¼€å§‹1005é•¿åº¦æ®µ
- ä»¥ä¸‹é…ç½®å°†1005å•ç‹¬æ˜ å°„åˆ°host 1005
```
# uid map: from uid 0 map 1005 uids (in the ct) to the range starting 100000 (on the host), so 0..1004 (ct) â†’ 100000..101004 (host)
lxc.idmap = u 0 100000 1005
lxc.idmap = g 0 100000 1005
# we map 1 uid starting from uid 1005 onto 1005, so 1005 â†’ 1005
lxc.idmap = u 1005 1005 1
lxc.idmap = g 1005 1005 1
# we map the rest of 65535 from 1006 upto 101006, so 1006..65535 â†’ 101006..165535
lxc.idmap = u 1006 101006 64530
lxc.idmap = g 1006 101006 64530
```

```
lxc.idmap = u 0 100000 1000
lxc.idmap = g 0 100000 1000
lxc.idmap = u 1000 1000 1
lxc.idmap = g 1000 1000 1
lxc.idmap = u 1001 101001 64534
lxc.idmap = g 1001 101001 64534
```

ç¼–è¾‘/etc/suuid(subgid)ï¼Œä½¿å¾—rootç”¨æˆ·å…è®¸ä½¿ç”¨1000çš„uid
```
root:100000:65536
root:1000:1
```
å¦åˆ™ä¼šæŠ¥å¦‚ä¸‹é”™è¯¯
```
lxc_map_ids: 3701 newuidmap failed to write mapping "newuidmap: uid range [1000-1001) -> [1000-1001) not allowed": newuidmap 793824 0 100000 1000 1000 1000 1 1001 101001 64534  
lxc_spawn: 1788 Failed to set up id mapping.  
__lxc_start: 2107  
TASK ERROR: startup for container '110' failed
```
### æ·»åŠ gpu

å®¹å™¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ 
```
lxc.cgroup2.devices.allow: c 226:0 rwm
lxc.cgroup2.devices.allow: c 226:128 rwm
lxc.cgroup2.devices.allow: c 29:0 rwm
lxc.mount.entry: /dev/dri dev/dri none bind,optional,create=dir
lxc.mount.entry: /dev/fb0 dev/fb0 none bind,optional,create=file
lxc.apparmor.profile: unconfined
```

lxc.cgroup2.devices.allowè®¾ç½®å…è®¸åœ¨LXCå®¹å™¨ä¸­ä½¿ç”¨çš„è®¾å¤‡è§„åˆ™
- `c` è¡¨ç¤ºå­—ç¬¦è®¾å¤‡ã€‚
- `195:*` æ˜¯ä¸€ä¸ªè®¾å¤‡è§„åˆ™ï¼Œå®ƒæŒ‡å®šäº†ä¸€ç»„å…è®¸çš„å­—ç¬¦è®¾å¤‡ã€‚åœ¨è¿™é‡Œï¼Œ`195` æ˜¯ä¸»è®¾å¤‡å·ï¼ˆmajor numberï¼‰ï¼Œè€Œ `*` è¡¨ç¤ºå…è®¸ä»»ä½•æ¬¡è®¾å¤‡å·ï¼ˆminor numberï¼‰ï¼Œè¿™æ„å‘³ç€å…è®¸ä½¿ç”¨ä¸»è®¾å¤‡å·ä¸º 195 çš„æ‰€æœ‰å­—ç¬¦è®¾å¤‡ã€‚
- `rwm` è¡¨ç¤ºæƒé™è®¾ç½®ï¼Œ`r` è¡¨ç¤ºå…è®¸è¯»å–ï¼Œ`w` è¡¨ç¤ºå…è®¸å†™å…¥ï¼Œ`m` è¡¨ç¤ºå…è®¸åˆ›å»ºè®¾å¤‡æ–‡ä»¶ã€‚

`lxc.mount.entry: /dev/dri dev/dri none bind,optional,create=dir`
- è¿™ä¸ªé…ç½®æ¡ç›®å°†ä¸»æœºä¸Šçš„ `/dev/dri` ç›®å½•æŒ‚è½½åˆ° LXC å®¹å™¨å†…çš„ `dev/dri` ç›®å½•ã€‚
- `none` è¡¨ç¤ºæ²¡æœ‰ç‰¹å®šçš„æ–‡ä»¶ç³»ç»Ÿç±»å‹ã€‚
- `bind` è¡¨ç¤ºä½¿ç”¨ç»‘å®šæŒ‚è½½ï¼ˆbind mountï¼‰ï¼Œè¿™æ„å‘³ç€å®¹å™¨å†…çš„ `dev/dri` ç›®å½•ä¼šæ˜ å°„åˆ°ä¸»æœºä¸Šçš„ `/dev/dri` ç›®å½•ï¼Œå®¹å™¨å†…çš„æ“ä½œå°†å½±å“åˆ°ä¸»æœºä¸Šçš„è®¾å¤‡ã€‚
- `optional` è¡¨ç¤ºè¿™ä¸ªæŒ‚è½½æ˜¯å¯é€‰çš„ï¼Œå¦‚æœ `/dev/dri` åœ¨ä¸»æœºä¸Šä¸å­˜åœ¨ï¼Œå®¹å™¨ä»ç„¶ä¼šå¯åŠ¨ã€‚
- `create=dir` è¡¨ç¤ºå¦‚æœå®¹å™¨å†…çš„ç›®å½•ä¸å­˜åœ¨ï¼Œå®ƒå°†åœ¨å®¹å™¨å†…åˆ›å»ºä¸€ä¸ªç›®å½•ã€‚
- `create=file` è¡¨ç¤ºå¦‚æœå®¹å™¨å†…çš„æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå®ƒå°†åœ¨å®¹å™¨å†…åˆ›å»ºä¸€ä¸ªæ–‡ä»¶

AppArmor æ˜¯ä¸€ä¸ª Linux å†…æ ¸å®‰å…¨æ¨¡å—ï¼Œç”¨äºé™åˆ¶ç¨‹åºçš„èƒ½åŠ›ï¼ŒåŒ…æ‹¬å®¹å™¨ï¼Œä»¥å¢å¼ºå®‰å…¨æ€§ã€‚
`lxc.apparmor.profile` è¢«è®¾ç½®ä¸º "unconfined"ï¼Œè¿™æ„å‘³ç€å®¹å™¨ä¸å— AppArmor ä¸ªäººèµ„æ–™çš„é™åˆ¶ã€‚å®ƒæœ‰æ›´å¤šè‡ªç”±ï¼Œä½†ä¹Ÿæœ‰è¾ƒå°‘çš„å®‰å…¨é™åˆ¶ã€‚

## å¤‡ä»½å’Œæ¢å¤

[Backup and Restore - Proxmox VE](https://pve.proxmox.com/wiki/Backup_and_Restore)

LXC
```
 pct restore 100 vzdump-lxc-100-2023_10_03-15_38_23.tar.zst --storage local-zfs
```

qm
```

```

## PVEæ˜¾å¡ç›´é€š

[PCI(e) Passthrough - Proxmox VE](https://pve.proxmox.com/wiki/PCI(e)_Passthrough)
[PCI Passthrough - Proxmox VE](https://pve.proxmox.com/wiki/PCI_Passthrough)
[(7) The Ultimate Beginner's Guide to GPU Passthrough (Proxmox, Windows 10) : homelab (reddit.com)](https://www.reddit.com/r/homelab/comments/b5xpua/the_ultimate_beginners_guide_to_gpu_passthrough/)
### égrubä¿®æ”¹å†…æ ¸å‚æ•°æ–¹æ³•

æˆ‘ä½¿ç”¨zfsï¼Œpve8.0 rootåˆ†åŒºä¹Ÿä½äºzfsï¼Œä½¿ç”¨systemd-bootå¼•å¯¼ã€‚å› æ­¤å†…æ ¸å‚æ•°éœ€è¦åœ¨`/etc/kernel/cmdline`ä¿®æ”¹ã€‚

- Grubï¼šThe kernel commandline needs to be placed in the variableÂ GRUB_CMDLINE_LINUX_DEFAULTÂ in the fileÂ `/etc/default/grub`. RunningÂ `update-grub`Â appends its content to allÂ linuxÂ entries inÂ /boot/grub/grub.cfg.
- Systemd-boot
  - The kernel commandline needs to be placed as one line inÂ `/etc/kernel/cmdline`. To apply your changes, runÂ `proxmox-boot-tool refresh`, which sets it as theÂ optionÂ line for all config files inÂ `loader/entries/proxmox-*.conf`.

### æ­¥éª¤

#### ä¿®æ”¹å†…æ ¸å‚æ•°

*p.s grubå’Œsystemd-bootä¿®æ”¹æ–¹æ³•ä¸ä¸€æ ·ï¼Œè¿™é‡Œä»¥systemd-bootä¸ºè¯´æ˜*

- `intel_iommu=on | amd_iommu=on`ï¼šFor Intel CPUs, you may also need to enable the IOMMU on theÂ [kernel command line](https://pve.proxmox.com/wiki/Host_Bootloader#sysboot_edit_kernel_cmdline)Â for older (pre-5.15) kernels. For AMD CPUs it should be enabled automatically.
- `iommu=pt`ï¼šIf your hardware supports IOMMU passthrough mode, enabling this mode might increase performance.

- (optional)å¯ç”¨acs override

æœ€åçš„å†…æ ¸å‚æ•°
```
/etc/kernel/cmdline
root=ZFS=rpool/ROOT/pve-1 boot=zfs amd_iommu=on iommu=pt pcie_acs_override=downstream,multifunction
```

æ›´æ–°å¼•å¯¼å‚æ•°
`proxmox-boot-tool refresh`
#### kernel module

##### è®¾ç½®å°½æ—©åŠ è½½
ä¿è¯ä»¥ä¸‹moduleå°½æ—©åŠ è½½ï¼Œå°†å…¶æ·»åŠ åˆ°`/etc/modules`
```
vfio
vfio_iommu_type1
vfio_pci
vfio_virqfd
```
##### è®¾ç½®æ¨¡å—å‚æ•°
ä¿®æ”¹ä¸€äº›å†…æ ¸æ¨¡å—çš„å‚æ•°ï¼Œä½äº`/etc/modprobe.d`

vifo.conf
- disable_vgaåï¼Œpveå¯åŠ¨æ—¶æ˜¾ç¤ºå™¨ä¼šæ— æ³•ä½¿ç”¨ï¼ˆvifoæ¥ç®¡æ˜¾å¡åï¼Œå±å¹•ä¾¿ä¼šå¡ä½ä¸å˜äº†ï¼‰
```
options vfio-pci ids=10de:1b81,10de:10f0,10de:1c02,10de:10f1 disable_vga=1
```

kvm.conf
```
options kvm ignore_msrs=1 report_ignored_msrs=0
```

blacklist.conf
```
blacklist nouveau
blacklist nvidia*
```
##### æ›´æ–°initramfs

æ¯å½“ä¿®æ”¹å†…æ ¸æ¨¡å—åï¼Œéœ€è¦é‡æ–°ç”Ÿæˆinitramfsã€‚
`update-initramfs -u`
- u: update
- k: æŒ‡å®šä¸€ä¸ªå†…æ ¸ç‰ˆæœ¬æˆ–è€…allæŒ‡å®šæ‰€æœ‰
### ACS override

[VFIO tips and tricks: VFIO+VGA FAQ](http://vfio.blogspot.com/2014/08/vfiovga-faq.html)
> pcie_acs_override =
> Â  Â  Â  Â  [PCIE] Override missing PCIe ACS support for:
> Â  Â  downstream
> Â  Â  Â  Â  All downstream ports - full ACS capabilties
> Â  Â  multifunction
> Â  Â  Â  Â  All multifunction devices - multifunction ACS subset
> Â  Â  id:nnnn:nnnn
> Â  Â  Â  Â  Specfic device - full ACS capabilities
> Â  Â  Â  Â  Specified as vid:did (vendor/device ID) in hex
### é‡åˆ°çš„é—®é¢˜

#### ç¬¬ä¸€å¼ gpuç›´é€šé—®é¢˜

960ï¼ˆç¬¬ä¸€ä¸ªæ§½ï¼‰ï¼Œéœ€è¦å…³é—­æ˜¾ç¤ºå™¨é‡å¯pveï¼Œæ‰èƒ½æ­£ç¡®å·¥ä½œã€‚æ·»åŠ å†…æ ¸å‚æ•°video=efifb:offåï¼Œè¿æ¥æ˜¾ç¤ºå™¨é‡å¯æ²¡é—®é¢˜ï¼Ÿ

> `video=efifb:off`Â and related kernel parameters don't work on Proxmox anymore. UseÂ [this work-around](https://forum.proxmox.com/posts/478351/)Â when doingÂ [passthrough](https://pve.proxmox.com/pve-docs/pve-admin-guide.html#qm_pci_passthrough)Â of the boot (or only) GPU.  
Also,Â `amd_iommu=on`Â really does nothing andÂ `iommu=pt`Â does mostly nothing. AndÂ [not all](https://pve.proxmox.com/pve-docs/pve-admin-guide.html#sysboot_determine_bootloader_used)Â Proxmox installations use GRUB.

> What a nice post! I've been looking for a solution to this BAR 3 issues all night. Big Thanks!  
By the way, I also found better solution on a reddit post. It is adding "`initcall_blacklist=sysfb_init`" to kernel parameter. No need "`video=efifb:off`" or "`video=simplefb:off`" in kernel parameter. I also tested, it does solve the problem!  
Reference:  
[https://www.reddit.com/r/VFIO/comme...let_simplefb_stay_away_from_the_gpu/?sort=old](https://www.reddit.com/r/VFIO/comments/uud5sx/possible_to_let_simplefb_stay_away_from_the_gpu/?sort=old)  
[https://www.reddit.com/r/Proxmox/comments/vc9hw3/latest_proxmox_7_the_kernel_breaks_my_gpu/?sort=old](https://www.reddit.com/r/Proxmox/comments/vc9hw3/latest_proxmox_7_the_kernel_breaks_my_gpu/?sort=old)
#### amd 6500xt 43é”™è¯¯

ç»™czwç›´é€š6500xtï¼Œç»“æœå³ä½¿å®‰è£…å®Œamdé©±åŠ¨åä»ç„¶æŠ¥43é”™è¯¯ã€‚æœ€åå‘ç°æ˜¯AMD GPUçš„é—®é¢˜ï¼Œéœ€è¦å…³é—­Resizable BAR/Smart Access MemoryÂ [https://pve.proxmox.com/wiki/PCI_Passthrough#BIOS_options](https://pve.proxmox.com/wiki/PCI_Passthrough#BIOS_options)  
> "Resizable BAR'/'Smart Access Memory': Some AMD GPUs (Vega and up) experience 'Code 43' in Windows guests if this is enabled on the host. It's not supported in VMs either way (yet), so the recommended setting is 'off'."

https://forum.proxmox.com/threads/gpu-passthrough-radeon-6800xt-and-beyond.86932/post-561971

æ€»ç»“
- æœ‰ç”¨
  - å…³é—­bios csmå’Œsmart access memory
  - æ·»åŠ å†…æ ¸å‚æ•°`initcall_blacklist=sysfb_init`ï¼ˆ`video=efifb:off`ä»ç„¶ä¿ç•™ï¼‰ï¼Œé‡å¯pve
- æ— ç”¨
  - æˆ‘è‡ªå·±è¯„è®ºçš„ï¼šI firstly tryed another method, since driver 43 error is a common problem when using libvirt to create VM. seeÂ [ovmf arch wiki 43](https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF#Video_card_driver_virtualisation_detection).Â  So I did similar thing: edit guest qemu config file(/etc/pve/qemu-sever/ VM id.conf), modify cpu property to "cpu: host,hidden=1,hv-vender-id=123456789".

#### windowséšæœºè“å±BOSD

VIDEO_DXGKRNL
- 10æ¥åˆ†é’Ÿå°±è“å±ï¼Œæ²¡æœ‰è§¦å‘æ¡ä»¶
- gfeå®‰è£…æœ€æ–°é©±åŠ¨ï¼Œå®‰è£…å®Œæˆæ—¶é»‘å±ï¼Œåªèƒ½åœ¨pve consoleé‡Œæ“ä½œã€‚
    - å¯ä»¥å†æ¬¡ç‚¹å‡»å¿«é€Ÿå®‰è£…å®‰è£…é©±åŠ¨
    - å¯ä»¥çœ‹åˆ°è®¾å¤‡ç®¡ç†å™¨ä¸­æ˜¾å¡æŠ¥13é”™è¯¯
    - é‡å¯åæ˜¾ç¤ºå®‰è£…ä¸Šäº†ï¼Œä½†æ˜¯å¦‚æœé‡æ–°å®‰è£…åˆæ˜¯ä»¥ä¸Šæ­¥éª¤

å°è¯•
- å…³é—­vnc, parsec, å°é£æœºç­‰å¯èƒ½ä¿®æ”¹æ˜¾å¡çš„è½¯ä»¶
- å‹¾ä¸Šprimay gpu
- ä½¿ç”¨ç½‘ä¸Šä¸‹è½½çš„msi å…¬ç‰ˆvbiosï¼Œè®¾ç½®romfileå‚æ•°[VGA Bios Collection: MSI GTX 1070 8 GB | TechPowerUp](https://www.techpowerup.com/vgabios/183948/msi-gtx1070-8192-160520)
- å®‰è£…studioé©±åŠ¨ï¼ˆä»ç„¶ä¼šæœ‰ä¸Šé¢é—®é¢˜ï¼‰


[Urgent Help, Windows 10 Crash!!! BSOD VIDEO_DXGKRNL_FATAL_ERROR | Proxmox Support Forum](https://forum.proxmox.com/threads/urgent-help-windows-10-crash-bsod-video_dxgkrnl_fatal_error.131828/)

æŠŠä¸‹é¢å¥å­ç¿»è¯‘æˆè‹±æ–‡ï¼š
æˆ‘é‡åˆ°äº†å®Œå…¨ä¸€æ ·çš„é—®é¢˜ï¼Œæˆ‘çš„win10è™šæ‹Ÿæœºæœ€è¿‘å¼€å§‹éšæœºè“å±ã€‚å®ƒè¿‡å»3ä¸ªæ˜ŸæœŸæ˜¯å¾ˆæ­£å¸¸çš„ã€‚æˆ‘å°è¯•äº†å¾ˆå¤šæ–¹æ³•ï¼ˆreinstall win10, try win11, pass vbios rom fileï¼‰ï¼Œé—®é¢˜ä»æ²¡è§£å†³ã€‚ç›´åˆ°æˆ‘çœ‹åˆ°äº†ä½ çš„å¸–å­ï¼Œæˆ‘ä¹Ÿå°è¯•æŠŠCPUä»hostæ”¹ä¸ºkvm64ï¼Œé—®é¢˜å±…ç„¶ç¥å¥‡çš„è§£å†³äº†ã€‚

ç»è¿‡æˆ‘ä¹‹å‰éå¸¸å¤šçš„å°è¯•ï¼Œæˆ‘å‘ç°äº†ä¸€ä¸ªèƒ½å¤Ÿç¨³å®šè§¦å‘BOSDçš„æ–¹æ³•ï¼Œé‚£å°±æ˜¯ä½¿ç”¨GPU-Zè½¯ä»¶å¯¼å‡ºGPUçš„vbiosï¼Œæ¯æ¬¡ç¡®è®¤å¯¼å‡ºæ—¶ï¼Œwin10ç³»ç»Ÿå°±ä¼šè“å±ã€‚

å¹¶ä¸”æˆ‘ä¹Ÿå‘ç°äº†ä¸€ä¸ªä¸å¤ªæ­£å¸¸çš„ç°è±¡ã€‚GPU-Zåªæœ‰åœ¨ç¬¬ä¸€æ¬¡æ‰“å¼€æ—¶UEFIçŠ¶æ€æ˜¯å‹¾ä¸Šçš„ï¼Œå…³é—­GPU-Zè½¯ä»¶ç„¶åå†æ‰“å¼€ï¼ŒUEFIå°±ä¼šå˜ä¸ºæœªå‹¾é€‰çŠ¶æ€ã€‚å¹¶æ‰“å¼€GPU-Zè½¯ä»¶å‡ ç§’åï¼Œbus interfaceä¹Ÿä¼šä»PCIex16 3.0@x16 3.0å˜ä¸º PCIã€‚

åœ¨å°†CPUä»hostæ¢æˆKVM64åï¼Œä¸Šé¢çš„é—®é¢˜å°±è¢«è§£å†³äº†ã€‚GPU-Z UEFIå’Œbus interfaceæ˜¾ç¤ºçš„éƒ½æ˜¯æ­£ç¡®çš„ã€‚


[VIDEO_DXGKRNL_FATAL_ERROR in a Windows VM - workarounds? | Proxmox Support Forum](https://forum.proxmox.com/threads/video_dxgkrnl_fatal_error-in-a-windows-vm-workarounds.94890/)
- è¿™ä¸ªå¸–å­è®¤ä¸ºæ˜¯MSIè¿™ç§è½¯ä»¶è¯»å–äº†åº•å±‚çš„ä¸å­˜åœ¨çš„å¯„å­˜å™¨å¯¼è‡´ç³»ç»Ÿå´©æºƒ


#### 43é”™è¯¯

1. æ˜¾å¡é©±åŠ¨æ£€æµ‹è™šæ‹Ÿæœº
æœ€æ—©ä½¿ç”¨KVMåˆ›å»ºè™šæ‹Ÿæœºï¼Œé‡åˆ°çš„ä¾¿æ˜¯è¿™ä¸ªã€‚å®‰è£…è‹±ä¼Ÿè¾¾æœ€æ–°é©±åŠ¨å³å¯
> Video card drivers by AMD incorporate very basic virtual machine detection targeting Hyper-V extensions. Should this detection mechanism trigger, the drivers will refuse to run, resulting in a black screen.
> Nvidia guest drivers prior to version 465 exhibited a similar behaviour which resulted in a generic error 43 in the card's device manager status. Systems using these older drivers therefore also need the above modification. In addition, they also require hiding the KVM CPU leaf

2. [Resizable Bar is turned on in the bios](https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF#Code_43_while_Resizable_Bar_is_turned_on_in_the_bios)

If you own a GPU that supports Resizable BAR / SAM and have the corresponding BIOS option enabled, you might get code 43 because this feature is disabled in QEMUÂ [[11]](https://github.com/qemu/qemu/commit/3412d8ec9810b819f8b79e8e0c6b87217c876e32). Linux Kernel release 6.1 added option to manipulate PCIe Resizable BARs throughÂ [sysfs](https://en.wikipedia.org/wiki/sysfs "wikipedia:sysfs"), so you can try permanently resizing it using aÂ [udev](https://wiki.archlinux.org/title/Udev "Udev")Â rule:
```
/etc/udev/rules.d/01-amd.rules

ACTION=="add", SUBSYSTEM=="pci", ATTR{vendor}=="0x1002", ATTR{device}=="0x73bf", ATTR{resource0_resize}="14"
ACTION=="add", SUBSYSTEM=="pci", ATTR{vendor}=="0x1002", ATTR{device}=="0x73bf", ATTR{resource2_resize}="8"
```

Alternatively, to temporarily resize the PCIe BAR, you can write the new size toÂ `/sys/bus/pci/devices/_device_address_/resource_number__resize`, whereÂ _device_address_Â is the address of your GPU, such asÂ `0000:03:00.0`Â (note that for changing this parameter, no driver can be loaded for the device).

You can confirm values usingÂ `lspci -vvvxxxx`.

#### AMD reset bug

[Working around the AMD GPU Reset bug on Proxmox using vendor-reset â€“ Nicholas Sherlock (nicksherlock.com)](https://www.nicksherlock.com/2020/11/working-around-the-amd-gpu-reset-bug-on-proxmox/)
> This is especially a problem if you only have one GPU in your system, because it will be your primary GPU and so be initialised by the host UEFI during boot, rendering it unusable for passthrough even a single time.

#### 6500xtæ€§èƒ½å¾ˆå·®

å·«å¸ˆä¸‰1080påªæœ‰å‡ åfpsï¼Œå¹¶ä¸”æœ‰æ—¶å€™è·‘benchmarkæ—¶ï¼Œvmä¼šè‡ªåŠ¨å…³æœºã€‚

å‘ç°ä¸èƒ½å®‰è£…amdæœ€æ–°é©±åŠ¨ï¼Œç±»ä¼¼äºèŠ¯ç‰‡ç»„ä¸è¯†åˆ«

- can't install amd adrenalin software
- [Unable to install AMD GPU Drivers in Windows guest VM - VM Engine (KVM) - Unraid](https://forums.unraid.net/topic/99447-unable-to-install-amd-gpu-drivers-in-windows-guest-vm/)

- BOSDé—®é¢˜
  - reset bugï¼šSymptoms included the display going black and the GPU fans kicking on higher for no reason.[(7) Radeon Adrenaline Software installation kills the VM : VFIO (reddit.com)](https://www.reddit.com/r/VFIO/comments/jicm4c/radeon_adrenaline_software_installation_kills_the/)

ä»”ç»†ç ”ç©¶åå‘ç°ï¼Œamd reset bugæ˜¯æŒ‡é‡å¯è™šæ‹Ÿæœºåä¼šé»‘å±ï¼Œä¸æ˜¯æ‰€æœ‰å¡éƒ½ä¼šé‡åˆ°è¯¥é—®é¢˜ã€‚
å¹¶ä¸”amd vendor reset githubä»“åº“å¹¶ä¸æ”¯æŒ6500xtã€‚å› æ­¤è²Œä¼¼å’Œè¿™é‡Œçš„é—®é¢˜æ— å…³ã€‚
### unbind gpu

æœªæµ‹è¯•
[(2) Recover GPU from VM after it shuts down | Proxmox Support Forum](https://forum.proxmox.com/threads/recover-gpu-from-vm-after-it-shuts-down.126457/)
```
echo "0000:01:00.0" > "/sys/bus/pci/devices/0000:01:00.0/driver/unbind" && echo "0000:01:00.0" > "/sys/bus/pci/drivers/amdgpu/bind"
echo "0000:01:00.1" > "/sys/bus/pci/devices/0000:01:00.1/driver/unbind" && echo "0000:01:00.1" > "/sys/bus/pci/drivers/snd_hda_intel/bind"
```
### èµ„æ–™æ”¶é›†

[AppendixÂ G.Â Configuring a Host for PCI Passthrough Red Hat Virtualization 4.1 | Red Hat Customer Portal --- é™„å½• G. ä¸º PCI ç›´é€šé…ç½®ä¸»æœº çº¢å¸½è™šæ‹ŸåŒ– 4.1 |çº¢å¸½å®¢æˆ·é—¨æˆ·](https://access.redhat.com/documentation/en-us/red_hat_virtualization/4.1/html/installation_guide/appe-configuring_a_hypervisor_host_for_pci_passthrough)

iommu=ptèƒ½å¤Ÿæé«˜æ€§èƒ½
IfÂ `intel_iommu=on`Â orÂ `amd_iommu=on`Â works, you can try replacing them withÂ `iommu=pt`Â orÂ `amd_iommu=pt`. TheÂ `pt`Â option **only enables IOMMU for devices used in passthrough and will provide better host performance.** However, the option may not be supported on all hardware. Revert to previous option if theÂ `pt`Â option doesn't work for your host.

allow_unsafe_interruptsé€‰é¡¹
If the passthrough fails because the hardware does not support interrupt remapping, you can consider enabling theÂ `allow_unsafe_interrupts`Â option if the virtual machines are trusted. TheÂ `allow_unsafe_interrupts`Â is not enabled by default because enabling it potentially exposes the host to MSI attacks from virtual machines. To enable the option:

#### redhat

[Product Documentation for Red Hat Virtualization 4.4 | Red Hat Customer Portal](https://access.redhat.com/documentation/en-us/red_hat_virtualization/4.4)
[Red Hat Virtualization 4.4 Setting up an NVIDIA GPU for a virtual machine in Red Hat Virtualization](https://access.redhat.com/documentation/en-us/red_hat_virtualization/4.4/pdf/setting_up_an_nvidia_gpu_for_a_virtual_machine_in_red_hat_virtualization/red_hat_virtualization-4.4-setting_up_an_nvidia_gpu_for_a_virtual_machine_in_red_hat_virtualization-en-us.pdf)

## å…¶å®ƒé—®é¢˜

### ç›´é€šAX200æ²¡æœ‰è“ç‰™ï¼ˆè§£å†³ï¼‰

[[æ±‚åŠ©] VMç›´é€šAX210è“ç‰™é‡åˆ°é—®é¢˜ - Chinese / ç®€ä½“ä¸­æ–‡ - Unraid](https://forums.unraid.net/topic/120168-%E6%B1%82%E5%8A%A9-vm%E7%9B%B4%E9%80%9Aax210%E8%93%9D%E7%89%99%E9%81%87%E5%88%B0%E9%97%AE%E9%A2%98/)
- çœ‹åˆ°åˆ«äººéƒ½æ˜¯lsusbèƒ½çœ‹åˆ°é›†æˆçš„è“ç‰™ï¼Œä½†æ˜¯æˆ‘çš„æ²¡æœ‰ã€‚

[[SOLVED] No bluetooth adaptater on AX200 / Kernel & Hardware / Arch Linux Forums](https://bbs.archlinux.org/viewtopic.php?id=272643)
æˆ‘çš„è¾“å‡ºæ²¡æœ‰ä»»ä½•firware loadçš„ä¿¡æ¯

```
root@ryzen-pve âœ  ~ dmesg | grep firm
[    0.512405] Spectre V2 : Enabling Restricted Speculation for firmware calls
[    7.689816] platform regulatory.0: Direct firmware load for regulatory.db failed with error -2

root@ryzen-pve âœ  ~ ls /lib/firmware |grep a0
iwlwifi-cc-a0-66.ucode.xz
iwlwifi-cc-a0-72.ucode.xz
```

æˆ‘è¿™é‡Œæ²¡æœ‰AX200 Bluetoothï¼Œè¿™æ˜¯åˆ«äººçš„è¾“å‡º
```
[(16:36:45)xeph:~]lsusb
Bus 004 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus 003 Device 003: ID 8087:0029 Intel Corp. AX200 Bluetooth
Bus 003 Device 002: ID 046d:c52b Logitech, Inc. Unifying Receiver
Bus 003 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 002 Device 002: ID 05e3:0620 Genesys Logic, Inc. GL3523 Hub
Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus 001 Device 004: ID 048d:c101 Integrated Technology Express, Inc. ITE Device(8910)
Bus 001 Device 003: ID 13d3:56ff IMC Networks Integrated Camera
Bus 001 Device 002: ID 05e3:0610 Genesys Logic, Inc. Hub
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
```

æ„Ÿè§‰å¯èƒ½æ˜¯å› ä¸ºç»‘å®šäº†vifo-pciå¯¼è‡´çš„ï¼Ÿ
[Does anyone know how to pass through the Wi Fi 6 ax200 network card to a virtual machine with Kali Linux OS? - VM Engine (KVM) - Unraid --- æœ‰è°çŸ¥é“å¦‚ä½•é€šè¿‡Wi Fi 6 ax200ç½‘å¡ä¼ é€’åˆ°å¸¦æœ‰Kali Linuxæ“ä½œç³»ç»Ÿçš„è™šæ‹Ÿæœºï¼Ÿ- è™šæ‹Ÿæœºå¼•æ“ ï¼ˆKVMï¼‰ - å–æ¶ˆçªè¢­](https://forums.unraid.net/topic/119920-does-anyone-know-how-to-pass-through-the-wi-fi-6-ax200-network-card-to-a-virtual-machine-with-kali-linux-os/)
[[6.10.0-RC1] Onboard Bluetooth no longer able to passthrough to VM - Prereleases - Unraid --- [6.10.0-RC1]æ¿è½½è“ç‰™æ— æ³•å†ç›´é€šåˆ° VM - å”®å‰èµ› - å–æ¶ˆçªè¢­](https://forums.unraid.net/bug-reports/prereleases/6100-rc1-onboard-bluetooth-no-longer-able-to-passthrough-to-vm-r1524/)

å¥½åƒå’Œæˆ‘ä¸€æ ·ï¼Œè“ç‰™ä»usbä¸­æ¶ˆå¤±
[PVE 7.4 + Home Assistant: Intel AX200 Bluetooth issues | Proxmox Support Forum --- PVE 7.4 + å®¶åº­åŠ©ç†ï¼š è‹±ç‰¹å°” AX200 è“ç‰™é—®é¢˜ |Proxmox æ”¯æŒè®ºå›](https://forum.proxmox.com/threads/pve-7-4-home-assistant-intel-ax200-bluetooth-issues.126014/)

æ—§ç¬”è®°æœ¬ä¸Šçš„ax200 lsusbç¡®å®èƒ½çœ‹åˆ°è®¾å¤‡



updateï¼šå¯èƒ½åŸå› ç¡®å®æ˜¯ç»‘å®šäº†vifo-pciï¼Œå¯¼è‡´æ²¡æœ‰çœ‹åˆ°bluetoothã€‚åé¢ä¸çŸ¥é“æ€ä¹ˆèƒ½çœ‹åˆ°usbè“ç‰™äº†ã€‚
ä½†åœ¨win10è™šæ‹Ÿæœºä¸­ï¼Œæ— æ³•è¯†åˆ«è®¾å¤‡
è§£å†³æ–¹æ³•ä¸ºï¼ˆå¦‚æœæ— æ³•ç§»é™¤ï¼Œæ˜¾ç¤ºin useï¼Œé‚£ä¹ˆå°±æ·»åŠ åˆ°blacklistä¸­ï¼Œç„¶åé‡å¯hostï¼‰
```
modprobe -r btusb
modprobe -r bluetooth
```
### ä¿®æ”¹hostnameå¯„

[Fix Proxmox Error after hostname/ip change (web-wilke.de)](https://web-wilke.de/fix-proxmox-error-after-hostname-ip-change/)
ä¿®æ”¹äº†hostnameåï¼Œå®¹å™¨è™šæ‹Ÿæœºéƒ½çœ‹ä¸è§äº†ã€‚å°è¯•ä¿®æ”¹/etc/hostsä½†æ˜¯ä¸å¤Ÿï¼Œæœ€åæ²¡å¼„å¥½ï¼Œè¿˜æ˜¯æ”¹å›åŸæ¥çš„hostnameäº†ã€‚

### å¤‡ä»½å•ä¸ªdisk

zfsè‡ªå·±å¤‡ä»½å¯ä»¥å—ï¼Ÿ
æˆ‘åˆ›å»ºçš„VMä¸çŸ¥ä¸ºä½•ä¸æ”¯æŒå¿«ç…§ã€‚

[backup single disk in VM | Proxmox Support Forum](https://forum.proxmox.com/threads/backup-single-disk-in-vm.94543/)

### zerotieræ— æ³•å¯åŠ¨

[OpenVPN in LXC - Proxmox VE](https://pve.proxmox.com/wiki/OpenVPN_in_LXC)

ç‰¹æƒå®¹å™¨æˆ–æ·»åŠ æƒé™

```
vim /etc/pve/lxc/100.conf

...
onboot: 1
ostype: unmanaged
parent: basic
rootfs: local-zfs:subvol-100-disk-0,size=100G
swap: 0
unprivileged: 1
lxc.cgroup2.devices.allow: c 10:200 rwm
lxc.mount.entry: /dev/net dev/net none bind,create=dir

[basic]
#%E5%9F%BA%E6%9C%AC%E9%98%B2%E7%81%AB%E5%A2%99%EF%BC%8Cddns%EF%BC%8Cwg_s2s%E5%8F%AF%E4%BB%A5%E8%BF%9E%E6%8E%A5op1,op3
arch: amd64
cores: 2
hostname: op2
```

```
chown 100000:100000 /dev/net/tun
```

### ç£ç›˜æµ‹é€Ÿ

ryzenè™šæ‹Ÿæœº
#### pcie4.0 çˆ±å›½è€…2T
```
âœ  fio sudo fio --filename=test.bin ssd-win-likely.fio
seq-read-4m: (g=0): rw=read, bs=(R) 4096KiB-4096KiB, (W) 4096KiB-4096KiB, (T) 4096KiB-4096KiB, ioengine=libaio, iodepth=32
seq-write-4m: (g=1): rw=write, bs=(R) 4096KiB-4096KiB, (W) 4096KiB-4096KiB, (T) 4096KiB-4096KiB, ioengine=libaio, iodepth=32
rand-read-4k: (g=2): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=4
rand-write-4k: (g=3): rw=randwrite, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=4
fio-3.28
Starting 4 processes
seq-read-4m: Laying out IO file (1 file / 10240MiB)
Jobs: 1 (f=1): [_(3),w(1)][68.5%][w=80.5MiB/s][w=20.6k IOPS][eta 01m:10s]
seq-read-4m: (groupid=0, jobs=1): err= 0: pid=778450: Fri Sep 29 23:47:57 2023
  read: IOPS=556, BW=2226MiB/s (2334MB/s)(10.0GiB/4600msec)
    slat (usec): min=47, max=7932, avg=478.16, stdev=665.62
    clat (msec): min=8, max=162, avg=56.62, stdev=22.04
     lat (msec): min=8, max=162, avg=57.10, stdev=21.94
    clat percentiles (msec):
     |  1.00th=[   15],  5.00th=[   23], 10.00th=[   28], 20.00th=[   36],
     | 30.00th=[   44], 40.00th=[   51], 50.00th=[   59], 60.00th=[   64],
     | 70.00th=[   69], 80.00th=[   74], 90.00th=[   82], 95.00th=[   91],
     | 99.00th=[  131], 99.50th=[  142], 99.90th=[  159], 99.95th=[  161],
     | 99.99th=[  163]
   bw (  MiB/s): min= 1993, max= 2336, per=99.89%, avg=2223.66, stdev=118.21, samples=8
   iops        : min=  498, max=  584, avg=555.63, stdev=29.56, samples=8
  lat (msec)   : 10=0.08%, 20=3.01%, 50=36.45%, 100=58.32%, 250=2.15%
  cpu          : usr=0.89%, sys=25.74%, ctx=2221, majf=1, minf=32780
  IO depths    : 1=0.1%, 2=0.1%, 4=0.2%, 8=0.3%, 16=0.6%, 32=98.8%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.1%, 64=0.0%, >=64=0.0%
     issued rwts: total=2560,0,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=32
seq-write-4m: (groupid=1, jobs=1): err= 0: pid=778524: Fri Sep 29 23:47:57 2023
  write: IOPS=82, BW=330MiB/s (346MB/s)(10.0GiB/31034msec); 0 zone resets
    slat (usec): min=76, max=221964, avg=1061.67, stdev=5512.31
    clat (msec): min=4, max=7483, avg=385.10, stdev=1126.37
     lat (msec): min=5, max=7484, avg=386.16, stdev=1126.51
    clat percentiles (msec):
     |  1.00th=[   12],  5.00th=[   22], 10.00th=[   27], 20.00th=[   34],
     | 30.00th=[   43], 40.00th=[   52], 50.00th=[   64], 60.00th=[   74],
     | 70.00th=[   96], 80.00th=[  142], 90.00th=[  502], 95.00th=[ 2970],
     | 99.00th=[ 5604], 99.50th=[ 5604], 99.90th=[ 7483], 99.95th=[ 7483],
     | 99.99th=[ 7483]
   bw (  KiB/s): min=65667, max=2682078, per=100.00%, avg=823187.87, stdev=652362.03, samples=24
   iops        : min=   16, max=  654, avg=200.58, stdev=159.18, samples=24
  lat (msec)   : 10=0.82%, 20=2.77%, 50=34.80%, 100=32.73%, 250=15.51%
  lat (msec)   : 500=3.20%, 750=1.64%, 1000=0.55%, 2000=1.41%, >=2000=6.56%
  cpu          : usr=3.45%, sys=5.12%, ctx=1899, majf=0, minf=15
  IO depths    : 1=0.1%, 2=0.1%, 4=0.2%, 8=0.3%, 16=0.6%, 32=98.8%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.1%, 64=0.0%, >=64=0.0%
     issued rwts: total=0,2560,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=32
rand-read-4k: (groupid=2, jobs=1): err= 0: pid=778956: Fri Sep 29 23:47:57 2023
  read: IOPS=50.4k, BW=197MiB/s (207MB/s)(10.0GiB/51982msec)
    slat (nsec): min=1170, max=3868.5k, avg=4517.95, stdev=7664.76
    clat (nsec): min=220, max=1695.1M, avg=74038.40, stdev=2120026.59
     lat (usec): min=12, max=1695.1k, avg=78.64, stdev=2120.05
    clat percentiles (usec):
     |  1.00th=[   18],  5.00th=[   21], 10.00th=[   23], 20.00th=[   26],
     | 30.00th=[   33], 40.00th=[   76], 50.00th=[   81], 60.00th=[   84],
     | 70.00th=[   88], 80.00th=[   93], 90.00th=[  105], 95.00th=[  123],
     | 99.00th=[  210], 99.50th=[  293], 99.90th=[  627], 99.95th=[ 1074],
     | 99.99th=[ 1975]
   bw (  KiB/s): min= 5643, max=270960, per=100.00%, avg=205429.51, stdev=34312.15, samples=101
   iops        : min= 1410, max=67740, avg=51357.30, stdev=8578.07, samples=101
  lat (nsec)   : 250=0.01%, 500=0.01%, 750=0.01%, 1000=0.01%
  lat (usec)   : 2=0.01%, 10=0.01%, 20=4.52%, 50=32.03%, 100=50.56%
  lat (usec)   : 250=12.11%, 500=0.62%, 750=0.08%, 1000=0.02%
  lat (msec)   : 2=0.05%, 4=0.01%, 10=0.01%, 20=0.01%, 50=0.01%
  lat (msec)   : 500=0.01%, 2000=0.01%
  cpu          : usr=7.47%, sys=29.84%, ctx=1440214, majf=0, minf=21
  IO depths    : 1=0.1%, 2=0.1%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     issued rwts: total=2621440,0,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=4
rand-write-4k: (groupid=3, jobs=1): err= 0: pid=779798: Fri Sep 29 23:47:57 2023
  write: IOPS=20.3k, BW=79.1MiB/s (83.0MB/s)(4748MiB/60005msec); 0 zone resets
    slat (nsec): min=1270, max=418621k, avg=6166.83, stdev=381021.38
    clat (nsec): min=290, max=1815.5M, avg=190356.30, stdev=6618668.74
     lat (usec): min=16, max=1815.5k, avg=196.62, stdev=6629.88
    clat percentiles (usec):
     |  1.00th=[   21],  5.00th=[   26], 10.00th=[   30], 20.00th=[   52],
     | 30.00th=[   83], 40.00th=[   87], 50.00th=[   91], 60.00th=[   95],
     | 70.00th=[  102], 80.00th=[  120], 90.00th=[  188], 95.00th=[  318],
     | 99.00th=[ 1844], 99.50th=[ 2008], 99.90th=[ 4424], 99.95th=[ 7635],
     | 99.99th=[20579]
   bw (  KiB/s): min= 1920, max=185240, per=100.00%, avg=88600.73, stdev=62711.61, samples=108
   iops        : min=  480, max=46310, avg=22150.14, stdev=15677.91, samples=108
  lat (nsec)   : 500=0.01%, 750=0.01%, 1000=0.01%
  lat (usec)   : 2=0.01%, 4=0.01%, 10=0.01%, 20=0.63%, 50=19.19%
  lat (usec)   : 100=47.74%, 250=25.71%, 500=3.06%, 750=0.44%, 1000=0.25%
  lat (msec)   : 2=2.46%, 4=0.39%, 10=0.08%, 20=0.02%, 50=0.01%
  lat (msec)   : 100=0.01%, 500=0.01%, 750=0.01%, 1000=0.01%, 2000=0.01%
  cpu          : usr=2.85%, sys=12.76%, ctx=889109, majf=0, minf=17
  IO depths    : 1=0.1%, 2=0.1%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     issued rwts: total=0,1215500,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=4

Run status group 0 (all jobs):
   READ: bw=2226MiB/s (2334MB/s), 2226MiB/s-2226MiB/s (2334MB/s-2334MB/s), io=10.0GiB (10.7GB), run=4600-4600msec

Run status group 1 (all jobs):
  WRITE: bw=330MiB/s (346MB/s), 330MiB/s-330MiB/s (346MB/s-346MB/s), io=10.0GiB (10.7GB), run=31034-31034msec

Run status group 2 (all jobs):
   READ: bw=197MiB/s (207MB/s), 197MiB/s-197MiB/s (207MB/s-207MB/s), io=10.0GiB (10.7GB), run=51982-51982msec

Run status group 3 (all jobs):
  WRITE: bw=79.1MiB/s (83.0MB/s), 79.1MiB/s-79.1MiB/s (83.0MB/s-83.0MB/s), io=4748MiB (4979MB), run=60005-60005msec

Disk stats (read/write):
  sdb: ios=2641793/1235910, merge=38/87, ticks=1077282/5674545, in_queue=6778554, util=94.90%
```

#### ä¸‰æ˜Ÿ981at
```
âœ  fio sudo fio --directory=/root/ --filename=test.bin ssd-win-likely.fio
seq-read-4m: (g=0): rw=read, bs=(R) 4096KiB-4096KiB, (W) 4096KiB-4096KiB, (T) 4096KiB-4096KiB, ioengine=libaio, iodepth=32
seq-write-4m: (g=1): rw=write, bs=(R) 4096KiB-4096KiB, (W) 4096KiB-4096KiB, (T) 4096KiB-4096KiB, ioengine=libaio, iodepth=32
rand-read-4k: (g=2): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=4
rand-write-4k: (g=3): rw=randwrite, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=4
fio-3.28
Starting 4 processes
seq-read-4m: Laying out IO file (1 file / 10240MiB)
Jobs: 1 (f=0): [_(3),f(1)][100.0%][w=69.1MiB/s][w=17.7k IOPS][eta 00m:00s]
seq-read-4m: (groupid=0, jobs=1): err= 0: pid=787066: Fri Sep 29 23:56:40 2023
  read: IOPS=460, BW=1841MiB/s (1930MB/s)(10.0GiB/5563msec)
    slat (usec): min=53, max=9744, avg=478.53, stdev=703.84
    clat (msec): min=9, max=889, avg=68.36, stdev=87.28
     lat (msec): min=10, max=889, avg=68.84, stdev=87.24
    clat percentiles (msec):
     |  1.00th=[   16],  5.00th=[   23], 10.00th=[   28], 20.00th=[   36],
     | 30.00th=[   43], 40.00th=[   51], 50.00th=[   59], 60.00th=[   67],
     | 70.00th=[   74], 80.00th=[   82], 90.00th=[   91], 95.00th=[  106],
     | 99.00th=[  743], 99.50th=[  885], 99.90th=[  885], 99.95th=[  885],
     | 99.99th=[  894]
   bw (  MiB/s): min=  945, max= 2324, per=100.00%, avg=1988.74, stdev=387.84, samples=10
   iops        : min=  236, max=  581, avg=496.70, stdev=96.92, samples=10
  lat (msec)   : 10=0.04%, 20=2.54%, 50=36.60%, 100=54.69%, 250=4.92%
  lat (msec)   : 750=0.39%, 1000=0.82%
  cpu          : usr=0.58%, sys=21.22%, ctx=2383, majf=0, minf=32780
  IO depths    : 1=0.1%, 2=0.1%, 4=0.2%, 8=0.3%, 16=0.6%, 32=98.8%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.1%, 64=0.0%, >=64=0.0%
     issued rwts: total=2560,0,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=32
seq-write-4m: (groupid=1, jobs=1): err= 0: pid=787186: Fri Sep 29 23:56:40 2023
  write: IOPS=235, BW=940MiB/s (986MB/s)(10.0GiB/10890msec); 0 zone resets
    slat (usec): min=69, max=73786, avg=783.64, stdev=3051.53
    clat (msec): min=2, max=2041, avg=135.28, stdev=287.50
     lat (msec): min=2, max=2042, avg=136.06, stdev=287.42
    clat percentiles (msec):
     |  1.00th=[   14],  5.00th=[   21], 10.00th=[   27], 20.00th=[   36],
     | 30.00th=[   46], 40.00th=[   57], 50.00th=[   68], 60.00th=[   83],
     | 70.00th=[  102], 80.00th=[  126], 90.00th=[  182], 95.00th=[  326],
     | 99.00th=[ 2022], 99.50th=[ 2022], 99.90th=[ 2039], 99.95th=[ 2039],
     | 99.99th=[ 2039]
   bw (  MiB/s): min=  370, max= 2341, per=100.00%, avg=1198.88, stdev=516.41, samples=16
   iops        : min=   92, max=  585, avg=299.31, stdev=129.04, samples=16
  lat (msec)   : 4=0.20%, 10=0.55%, 20=4.14%, 50=29.77%, 100=34.84%
  lat (msec)   : 250=24.14%, 500=2.30%, 750=1.05%, 2000=1.76%, >=2000=1.25%
  cpu          : usr=7.14%, sys=12.19%, ctx=1959, majf=0, minf=14
  IO depths    : 1=0.1%, 2=0.1%, 4=0.2%, 8=0.3%, 16=0.6%, 32=98.8%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.1%, 64=0.0%, >=64=0.0%
     issued rwts: total=0,2560,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=32
rand-read-4k: (groupid=2, jobs=1): err= 0: pid=787189: Fri Sep 29 23:56:40 2023
  read: IOPS=42.8k, BW=167MiB/s (175MB/s)(9.79GiB/60001msec)
    slat (nsec): min=1180, max=378282k, avg=4607.87, stdev=236197.07
    clat (nsec): min=240, max=1725.2M, avg=87451.41, stdev=4192102.00
     lat (usec): min=12, max=1725.2k, avg=92.80, stdev=4327.60
    clat percentiles (usec):
     |  1.00th=[   18],  5.00th=[   21], 10.00th=[   22], 20.00th=[   26],
     | 30.00th=[   30], 40.00th=[   47], 50.00th=[   92], 60.00th=[   96],
     | 70.00th=[   99], 80.00th=[  104], 90.00th=[  115], 95.00th=[  129],
     | 99.00th=[  212], 99.50th=[  306], 99.90th=[  578], 99.95th=[  742],
     | 99.99th=[ 1893]
   bw (  KiB/s): min=13755, max=264232, per=100.00%, avg=183324.63, stdev=52285.27, samples=111
   iops        : min= 3438, max=66058, avg=45831.09, stdev=13071.34, samples=111
  lat (nsec)   : 250=0.01%, 500=0.01%, 750=0.01%, 1000=0.01%
  lat (usec)   : 2=0.01%, 4=0.01%, 10=0.01%, 20=4.54%, 50=35.97%
  lat (usec)   : 100=31.58%, 250=27.11%, 500=0.66%, 750=0.10%, 1000=0.03%
  lat (msec)   : 2=0.01%, 4=0.01%, 10=0.01%, 20=0.01%, 50=0.01%
  lat (msec)   : 500=0.01%, 750=0.01%, 1000=0.01%, 2000=0.01%
  cpu          : usr=7.24%, sys=27.70%, ctx=1476701, majf=0, minf=20
  IO depths    : 1=0.1%, 2=0.1%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     issued rwts: total=2567447,0,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=4
rand-write-4k: (groupid=3, jobs=1): err= 0: pid=788193: Fri Sep 29 23:56:40 2023
  write: IOPS=30.2k, BW=118MiB/s (124MB/s)(7081MiB/60001msec); 0 zone resets
    slat (nsec): min=1260, max=40475k, avg=6308.96, stdev=55626.04
    clat (nsec): min=300, max=1630.1M, avg=125086.99, stdev=2894812.01
     lat (usec): min=17, max=1630.1k, avg=131.50, stdev=2895.61
    clat percentiles (usec):
     |  1.00th=[   21],  5.00th=[   25], 10.00th=[   29], 20.00th=[   49],
     | 30.00th=[   94], 40.00th=[   98], 50.00th=[  101], 60.00th=[  105],
     | 70.00th=[  111], 80.00th=[  119], 90.00th=[  149], 95.00th=[  221],
     | 99.00th=[  498], 99.50th=[  758], 99.90th=[ 3163], 99.95th=[ 6063],
     | 99.99th=[23725]
   bw (  KiB/s): min=10431, max=171952, per=100.00%, avg=122835.52, stdev=47622.27, samples=112
   iops        : min= 2607, max=42988, avg=30708.83, stdev=11905.58, samples=112
  lat (nsec)   : 500=0.01%, 750=0.01%, 1000=0.01%
  lat (usec)   : 2=0.01%, 4=0.01%, 10=0.01%, 20=0.73%, 50=19.45%
  lat (usec)   : 100=25.98%, 250=49.77%, 500=3.06%, 750=0.49%, 1000=0.19%
  lat (msec)   : 2=0.17%, 4=0.07%, 10=0.05%, 20=0.02%, 50=0.01%
  lat (msec)   : 100=0.01%, 250=0.01%, 750=0.01%, 2000=0.01%
  cpu          : usr=4.53%, sys=20.36%, ctx=1376235, majf=0, minf=16
  IO depths    : 1=0.1%, 2=0.1%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     issued rwts: total=0,1812637,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=4

Run status group 0 (all jobs):
   READ: bw=1841MiB/s (1930MB/s), 1841MiB/s-1841MiB/s (1930MB/s-1930MB/s), io=10.0GiB (10.7GB), run=5563-5563msec

Run status group 1 (all jobs):
  WRITE: bw=940MiB/s (986MB/s), 940MiB/s-940MiB/s (986MB/s-986MB/s), io=10.0GiB (10.7GB), run=10890-10890msec

Run status group 2 (all jobs):
   READ: bw=167MiB/s (175MB/s), 167MiB/s-167MiB/s (175MB/s-175MB/s), io=9.79GiB (10.5GB), run=60001-60001msec

Run status group 3 (all jobs):
  WRITE: bw=118MiB/s (124MB/s), 118MiB/s-118MiB/s (124MB/s-124MB/s), io=7081MiB (7425MB), run=60001-60001msec

Disk stats (read/write):
  sda: ios=2588374/1830074, merge=92/389, ticks=1241127/2284278, in_queue=3529480, util=95.33%
```

#### n5105 é“ ä¾ rc20 500GB
```
root@n5105-pve âœ  fio fio --filename=test.bin ssd-win-likely.fio
seq-read-4m: (g=0): rw=read, bs=(R) 4096KiB-4096KiB, (W) 4096KiB-4096KiB, (T) 4096KiB-4096KiB, ioengine=libaio, iodepth=32
seq-write-4m: (g=1): rw=write, bs=(R) 4096KiB-4096KiB, (W) 4096KiB-4096KiB, (T) 4096KiB-4096KiB, ioengine=libaio, iodepth=32
rand-read-4k: (g=2): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=4
rand-write-4k: (g=3): rw=randwrite, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=4
fio-3.33
Starting 4 processes
Jobs: 1 (f=1): [_(3),w(1)][59.0%][w=3081KiB/s][w=770 IOPS][eta 02m:19s]
seq-read-4m: (groupid=0, jobs=1): err= 0: pid=422690: Sat Sep 30 00:46:36 2023
  read: IOPS=140, BW=560MiB/s (588MB/s)(10.0GiB/18274msec)
    slat (usec): min=5966, max=22258, avg=7123.69, stdev=945.70
    clat (usec): min=13, max=331888, avg=219709.66, stdev=21151.42
     lat (msec): min=6, max=338, avg=226.83, stdev=21.36
    clat percentiles (msec):
     |  1.00th=[  180],  5.00th=[  209], 10.00th=[  211], 20.00th=[  213],
     | 30.00th=[  218], 40.00th=[  218], 50.00th=[  220], 60.00th=[  222],
     | 70.00th=[  222], 80.00th=[  222], 90.00th=[  226], 95.00th=[  232],
     | 99.00th=[  296], 99.50th=[  330], 99.90th=[  330], 99.95th=[  330],
     | 99.99th=[  334]
   bw (  KiB/s): min=357840, max=614400, per=99.09%, avg=568612.03, stdev=44133.11, samples=36
   iops        : min=   87, max=  150, avg=138.75, stdev=10.82, samples=36
  lat (usec)   : 20=0.04%
  lat (msec)   : 10=0.04%, 20=0.04%, 50=0.20%, 100=0.23%, 250=95.62%
  lat (msec)   : 500=3.83%
  cpu          : usr=0.33%, sys=26.03%, ctx=10676, majf=0, minf=32779
  IO depths    : 1=0.1%, 2=0.1%, 4=0.2%, 8=0.3%, 16=0.6%, 32=98.8%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.1%, 64=0.0%, >=64=0.0%
     issued rwts: total=2560,0,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=32
seq-write-4m: (groupid=1, jobs=1): err= 0: pid=447378: Sat Sep 30 00:46:36 2023
  write: IOPS=29, BW=118MiB/s (123MB/s)(7168MiB/60944msec); 0 zone resets
    slat (usec): min=1337, max=3922.2k, avg=33986.69, stdev=277349.50
    clat (usec): min=13, max=4661.5k, avg=1053752.98, stdev=1375122.08
     lat (msec): min=54, max=4680, avg=1087.74, stdev=1395.81
    clat percentiles (msec):
     |  1.00th=[   63],  5.00th=[   88], 10.00th=[  105], 20.00th=[  109],
     | 30.00th=[  144], 40.00th=[  205], 50.00th=[  262], 60.00th=[  531],
     | 70.00th=[ 1028], 80.00th=[ 2970], 90.00th=[ 3574], 95.00th=[ 3809],
     | 99.00th=[ 4530], 99.50th=[ 4597], 99.90th=[ 4665], 99.95th=[ 4665],
     | 99.99th=[ 4665]
   bw (  KiB/s): min= 8208, max=787386, per=100.00%, avg=306489.37, stdev=235225.24, samples=46
   iops        : min=    2, max=  192, avg=74.54, stdev=57.29, samples=46
  lat (usec)   : 20=0.06%
  lat (msec)   : 100=8.37%, 250=37.67%, 500=13.06%, 750=3.18%, 1000=6.19%
  lat (msec)   : 2000=10.71%, >=2000=20.76%
  cpu          : usr=0.86%, sys=5.95%, ctx=26464, majf=0, minf=12
  IO depths    : 1=0.1%, 2=0.1%, 4=0.2%, 8=0.4%, 16=0.9%, 32=98.3%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=99.9%, 8=0.0%, 16=0.0%, 32=0.1%, 64=0.0%, >=64=0.0%
     issued rwts: total=0,1792,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=32
rand-read-4k: (groupid=2, jobs=1): err= 0: pid=449479: Sat Sep 30 00:46:36 2023
  read: IOPS=2352, BW=9409KiB/s (9634kB/s)(551MiB/60001msec)
    slat (usec): min=6, max=24639, avg=421.40, stdev=272.49
    clat (usec): min=2, max=36072, avg=1277.22, stdev=607.71
     lat (usec): min=374, max=42067, avg=1698.61, stdev=744.53
    clat percentiles (usec):
     |  1.00th=[  996],  5.00th=[ 1037], 10.00th=[ 1074], 20.00th=[ 1106],
     | 30.00th=[ 1139], 40.00th=[ 1156], 50.00th=[ 1188], 60.00th=[ 1237],
     | 70.00th=[ 1287], 80.00th=[ 1352], 90.00th=[ 1483], 95.00th=[ 1614],
     | 99.00th=[ 2507], 99.50th=[ 3032], 99.90th=[12518], 99.95th=[15401],
     | 99.99th=[17695]
   bw (  KiB/s): min= 1744, max=10080, per=99.99%, avg=9408.22, stdev=1395.59, samples=119
   iops        : min=  436, max= 2520, avg=2351.96, stdev=348.88, samples=119
  lat (usec)   : 4=0.01%, 500=0.01%, 750=0.03%, 1000=1.37%
  lat (msec)   : 2=96.73%, 4=1.58%, 10=0.15%, 20=0.14%, 50=0.01%
  cpu          : usr=0.87%, sys=9.69%, ctx=141627, majf=0, minf=13
  IO depths    : 1=0.1%, 2=0.1%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     issued rwts: total=141132,0,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=4
rand-write-4k: (groupid=3, jobs=1): err= 0: pid=505899: Sat Sep 30 00:46:36 2023
  write: IOPS=776, BW=3105KiB/s (3179kB/s)(182MiB/60001msec); 0 zone resets
    slat (usec): min=8, max=64884, avg=1276.50, stdev=1138.90
    clat (usec): min=4, max=125427, avg=3870.75, stdev=2918.05
     lat (usec): min=760, max=168093, avg=5147.25, stdev=3727.98
    clat percentiles (usec):
     |  1.00th=[  1680],  5.00th=[  2147], 10.00th=[  2245], 20.00th=[  2376],
     | 30.00th=[  2507], 40.00th=[  2704], 50.00th=[  3032], 60.00th=[  3982],
     | 70.00th=[  4817], 80.00th=[  5407], 90.00th=[  5997], 95.00th=[  6521],
     | 99.00th=[  8848], 99.50th=[ 11338], 99.90th=[ 31065], 99.95th=[ 66323],
     | 99.99th=[110625]
   bw (  KiB/s): min= 1405, max= 5016, per=99.72%, avg=3096.45, stdev=976.25, samples=119
   iops        : min=  351, max= 1254, avg=774.01, stdev=244.12, samples=119
  lat (usec)   : 10=0.01%, 750=0.01%, 1000=0.01%
  lat (msec)   : 2=1.54%, 4=58.60%, 10=39.19%, 20=0.46%, 50=0.12%
  lat (msec)   : 100=0.03%, 250=0.03%
  cpu          : usr=0.77%, sys=8.83%, ctx=99364, majf=0, minf=10
  IO depths    : 1=0.1%, 2=0.1%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     issued rwts: total=0,46570,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=4

Run status group 0 (all jobs):
   READ: bw=560MiB/s (588MB/s), 560MiB/s-560MiB/s (588MB/s-588MB/s), io=10.0GiB (10.7GB), run=18274-18274msec

Run status group 1 (all jobs):
  WRITE: bw=118MiB/s (123MB/s), 118MiB/s-118MiB/s (123MB/s-123MB/s), io=7168MiB (7516MB), run=60944-60944msec

Run status group 2 (all jobs):
   READ: bw=9409KiB/s (9634kB/s), 9409KiB/s-9409KiB/s (9634kB/s-9634kB/s), io=551MiB (578MB), run=60001-60001msec

Run status group 3 (all jobs):
  WRITE: bw=3105KiB/s (3179kB/s), 3105KiB/s-3105KiB/s (3179kB/s-3179kB/s), io=182MiB (191MB), run=60001-60001msec
```

#### pci subvendor id

```
cat /sys/bus/pci/devices/*/uevent
```