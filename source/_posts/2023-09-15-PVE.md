---
title: 2023-09-15-PVE
date: 2023-09-15 20:31
tags:
  - pve
categories:
  - homelab
  - 虚拟化
---
PVE用法、配置个人记录

<!-- more -->

## 安装

安装注意事项
- 之后修改hostname很麻烦，因此一开始就确定好
- zfs是我比较推荐的系统盘格式，后面创建虚拟机，lxc容器，磁盘镜像都会直接使用zfs的zvol功能，因此可以使用zfs自己管理这些磁盘镜像，非常方便。

换源：[Proxmox 源使用帮助 — USTC Mirror Help 文档](http://mirrors.ustc.edu.cn/help/proxmox.html)

常用命令工具：[Command Line Tools - Proxmox VE](https://pve.proxmox.com/wiki/Command_Line_Tools)

## PVE配置
### 网络配置

网络采用ifupdown
```
/etc/network/interfaces

ifreload -a  # 应用更改
```

- 创建两个br，居然不支持设置两个default route。解决办法是在interface配置文件中通过post-up自己添加
```
auto vmbr0
iface vmbr0 inet static
        address 210.45.76.204/24
        bridge-ports enp7s0
        bridge-stp off
        bridge-fd 0
        post-up ip ru add from 210.45.76.204 lookup vmbr0 prior 3
        post-up ip ro add table vmbr0 default via 210.45.76.254 dev vmbr0
        post-up ip ro add default via 210.45.76.254 dev vmbr0 metric 200

auto vmbr1
iface vmbr1 inet static
        address 192.168.35.254/24
        bridge-ports enxf8e43b0a274a
        bridge-stp off
        bridge-fd 0
        post-up ip ro add default via 192.168.35.1 dev vmbr1 metric 100
        pre-down ip ro del default dev vmbr1
```

### 存储配置

[Proxmox VE Storage](https://pve.proxmox.com/pve-docs/chapter-pvesm.html)
#### 基础概念

storage（池）类型
- file level：可以存储任何类型内容
- block：存储大的raw images
> 1: Disk images for VMs are stored in ZFS volume (zvol) datasets, which provide block device functionality.
> 2: On file based storages, snapshots are possible with the _qcow2_ format.

存储的数据类型

A storage can support several content types, for example virtual disk images, cdrom iso images, container templates or container root directories. Not all storage types support all content types. One can set this property to select what this storage is used for.
- images: QEMU/KVM VM images.
- rootdir: Allow to store container data.
- vztmpl: Container templates.
- backup: Backup files (vzdump).
- iso: ISO images
- snippets: Snippet files, for example guest hook scripts

#### 配置文件

/etc/pve/storage.cfg
```
dir: local
        path /var/lib/vz
        content iso,vztmpl,backup
        
# default image store on ZFS based installation
zfspool: local-zfs
        pool rpool/data
        sparse
        content images,rootdir
```

**local更像是存储只读的数据**
**local-zfs则存放读写的数据**
- 虚拟机的disk为zvol
- lxc容器的rootdir为dataset

Volume id格式（许多命令都需要该格式参数）
```
local:230/example-image.raw

local:iso/debian-501-amd64-netinst.iso

local:vztmpl/debian-5.0-joomla_1.5.9-1_i386.tar.gz

iscsi-storage:0.0.2.scsi-14f504e46494c4500494b5042546d2d646744372d31616d61
```
#### 命令行工具

```
pvesm add <TYPE> <STORAGE_ID> <OPTIONS>
pvesm add dir <STORAGE_ID> --path <PATH>
pvesm add nfs <STORAGE_ID> --path <PATH> --server <SERVER> --export <EXPORT>
pvesm add lvm <STORAGE_ID> --vgname <VGNAME>
pvesm add iscsi <STORAGE_ID> --portal <HOST[:PORT]> --target <TARGET>

pvesm set <STORAGE_ID> <OPTIONS>
pvesm set <STORAGE_ID> --shared 1
pvesm set local --format qcow2
pvesm set <STORAGE_ID> --content iso

pvesm alloc <STORAGE_ID> <VMID> <name> <size> [--format <raw|qcow2>]
pvesm alloc local <VMID> '' 4G  # name为空则自动生成

pvesm free <VOLUME_ID>

pvesm status
pvesm list <STORAGE_ID> [--vmid <VMID>]

pvesm path <VOLUME_ID> #查看实际路径
```

#### 不同backend

##### dir

可以存储任何类型数据（virtual disk images, containers, templates, ISO images or backup files.）


> You can mount additional storages via standard linux /etc/fstab, and then define a directory storage for that mount point. This way you can use any file system supported by Linux.

默认layout

|Content type|Subdir|
|---|---|
|VM images|`images/<VMID>/`|
|ISO images|template/iso/|
|Container templates|template/cache/|
|Backup files|dump/|
|Snippets|snippets/|

例子
```
dir: backup
        path /mnt/backup
        content backup
        prune-backups keep-last=7
        max-protected-backups 3
        content-dirs backup=custom/backup/dir
```
##### zfs

##### lvm
[Proxmox VE Storage](https://pve.proxmox.com/pve-docs/chapter-pvesm.html#storage_lvm)
[Proxmox Storage Guide | Programster's Blog](https://blog.programster.org/proxmox-storage-guide)

|Content types|Image formats|Shared|Snapshots|Clones|
|---|---|---|---|---|
|images rootdir|raw|possible|no|no|

##### lvm-thin

支持thin provisioning（稀疏分配）

LVM normally allocates blocks when you create a volume. LVM thin pools instead allocates blocks when they are written. This behaviour is called thin-provisioning
## 虚拟机

### 命令行

[qm(1) (proxmox.com)](https://pve.proxmox.com/pve-docs/qm.1.html)

不必填所有参数，创建后在web中再添加
```
qm create 120 --cores 2 --cpu host --memory 1024 --name u22-test --scsihw virtio-scsi-single --scsi0 local-zfs:vm-120-disk-root 
```
### 直通磁盘

[Passthrough Physical Disk to Virtual Machine (VM) - Proxmox VE](https://pve.proxmox.com/wiki/Passthrough_Physical_Disk_to_Virtual_Machine_(VM))

很简单，不需要pci直通之类的。本质上和kvm添加一个磁盘是一样的
- 磁盘只看做一个块文件，内部会重新创建分区表？

- Hot-Plug/Add physical device as new virtual SCSI disk
```
qm set 592 -scsi2 /dev/disk/by-id/ata-ST3000DM001-1CH166_Z1F41BLC
```

- Hot-Unplug/Remove virtual disk
```
qm unlink 592 --idlist scsi2
```
#### 直通分区

只需要把上面by-id路径指定具体分区即可

[Is it possible to passthrough a partition of a drive to a VM? and not the entire disk? | Proxmox Support Forum](https://forum.proxmox.com/threads/is-it-possible-to-passthrough-a-partition-of-a-drive-to-a-vm-and-not-the-entire-disk.109974/)

> I think "qm set" disk passthrough should work with partitions too:  
[https://pve.proxmox.com/wiki/Passthrough_Physical_Disk_to_Virtual_Machine_(VM)](https://pve.proxmox.com/wiki/Passthrough_Physical_Disk_to_Virtual_Machine_(VM))  
Then its just for example `qm set 592 -scsi2 /dev/disk/by-id/ata-ST3000DM001-1CH166_Z1F41BLC-part3` instead of `qm set 592 -scsi2 /dev/disk/by-id/ata-ST3000DM001-1CH166_Z1F41BLC`


### 显示设备

#### 介绍

[VGA and other display devices in qemu | 🇺🇦 kraxel’s news](https://www.kraxel.org/blog/2019/09/display-devices-in-qemu/)

qxl
- 支持2d加速，但是该功能现在已经变得不再有用了。软件通常使用OpenGL或Vulkan，3d渲染。
> This device has support for 2D acceleration. This becomes more and more useless though as modern display devices don't have dedicated 2D acceleration support any more and use the 3D engine for everything. The same happens on the software side, modern desktops are rendering with opengl or vulkan instead of using 2D acceleration.

virtio vga
- 支持硬件辅组的opengl加速
- 目前只有linux下有驱动，因此只在linux工作
> This device has (optional) hardware-assisted opengl acceleration support. This can be enabled using the `virgl=on` property, which in turn needs opengl support enabled (`gl=on`) in the qemu display.

#### virgl

[(7) VirGL vs GPU passthrough vs VirtIO or QXL : VFIO (reddit.com)](https://www.reddit.com/r/VFIO/comments/ufseh1/virgl_vs_gpu_passthrough_vs_virtio_or_qxl/)

> 为了显示 3D 图形，游戏需要为 GPU 打开一个“上下文”。（无论是Direct3D，OpenGL，Vulkan等）。打开此上下文后，他们可以向 GPU 发送命令以上传纹理、运行着色器、渲染内容等。
> VirGL允许访客在主机的GPU上打开这些上下文。为此，它需要在 VM 中拥有自己的特殊驱动程序，这些驱动程序独立于底层 GPU 类型。
> 未来很可能是 GPU-P (or GPU partitioning).。此功能允许物理 GPU 提供多个虚拟分区，允许主机和来宾使用相同的物理 GPU。有几种方法可以做到这一点，但目前它不受官方支持（在消费者卡中）。


适合轻量的3d加速（桌面compositor）
> if you need 3D accel (eg even for desktop compositor effects, no heavy gaming) this is what you want. Otherwise you go with Intel GVT-g or full GPU passthrough.

目前还不支持HW Video编解码加速
> One feature I would like is being able to use HW video decode too, but presently that requires passing in full GPU or vGPU.

设置后，在win10中样子
![image.png](https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20231002160224.png)

![image.png](https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20231002161058.png)

可以玩简单OpenGL游戏：测试了东方
不能玩yuzu模拟器，选择OpenGL时，可以选择GLSL，但是不能运行游戏。选vulkan没有设备。
### 隐藏KVM

著名二字游戏无法在虚拟机中运行
![原神无法虚拟机启动.jpg](https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/%E5%8E%9F%E7%A5%9E%E6%97%A0%E6%B3%95%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%90%AF%E5%8A%A8.jpg)


https://forum.proxmox.com/threads/hide-vm-from-guest.34905/post-176978
```
args: -cpu 'host,-hypervisor,+kvm_pv_unhalt,+kvm_pv_eoi,hv_spinlocks=0x1fff,hv_vapic,hv_time,hv_reset,hv_vpindex,hv_runtime,hv_relaxed,kvm=off,hv_vendor_id=intel'
```
> Guest operating systems can test bit 31 of ECX of CPUID leaf 0x1, so **-hypervisor** flag prevent this.  
I can't add links ![:(](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 "Frown    :("). You can read more about virtual machine detection mechanism in vmware knowledge base. Article is called "Mechanisms to determine if software is running in a VMware virtual machine"

更新一点的2022
[Can't hide 'VM' status in Windows guest | Proxmox Support Forum](https://forum.proxmox.com/threads/cant-hide-vm-status-in-windows-guest.96779/)
> In VM config:  
args: -cpu host,hv_vapic,hv_stimer,+invtsc,[more-flags],-hypervisor

经尝试上面的命令启动时会报错，需要添加更多flag
```
root@ryzen-pve ➜  ~ qm start 200
kvm: Hyper-V synthetic timers (hv-stimer) requires Hyper-V clocksources (hv-time)
start failed: QEMU exited with code 1
root@ryzen-pve ➜  ~ vim /etc/pve/qemu-server/200.conf
root@ryzen-pve ➜  ~ qm start 200
kvm: Hyper-V synthetic timers (hv-stimer) requires Hyper-V synthetic interrupt controller (hv-synic)
start failed: QEMU exited with code 1
root@ryzen-pve ➜  ~ vim /etc/pve/qemu-server/200.conf
root@ryzen-pve ➜  ~ qm start 200
kvm: Hyper-V synthetic interrupt controller (hv-synic) requires Hyper-V VP_INDEX MSR (hv-vpindex)
start failed: QEMU exited with code 1
```

最后需要补充完整到
```
args: -cpu host,hv_vapic,hv_stimer,hv_time,hv_synic,hv_vpindex,+invtsc,-hypervisor
```
注意，不要再加cpu: x86-64-v3这样的参数了。我刚开始加了，导致进入vm，N卡驱动报43错误

其它
- virt-manger中类似方法：[求助！win11 wm 打开原神 显示虚拟机下无法运行 - Chinese / 简体中文 - Unraid](https://forums.unraid.net/topic/126098-%E6%B1%82%E5%8A%A9%EF%BC%81win11-wm-%E6%89%93%E5%BC%80%E5%8E%9F%E7%A5%9E-%E6%98%BE%E7%A4%BA%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%8B%E6%97%A0%E6%B3%95%E8%BF%90%E8%A1%8C/)
- [Proxmox VE(PVE)虚拟机绕过软件的虚拟机检查来玩原神 - 某咸鱼的笔记 (wunote.cn)](https://www.wunote.cn/article/4801/)
## LXC容器

https://pve.proxmox.com/wiki/Linux_Container

### 容器镜像

```
 pveam update
 pveam available
pveam available --section system

pveam download local debian-10.0-standard_10.0-1_amd64.tar.gz
```

导入容器镜像
只能通过webui upload?

### PCT命令行

[Linux Container - Proxmox VE](https://pve.proxmox.com/wiki/Linux_Container#_managing_containers_with_tt_span_class_monospaced_pct_span_tt)

```
pct list
pct console <vmid> [OPTIONS]
pct enter <vmid>

pct start

pct destroy 100 --purge # --purge_, if you want to additionally remove the container from replication jobs, backup jobs and HA resource configurations.
```

```
# pct set 100 -net0 name=eth0,bridge=vmbr0,ip=192.168.15.147/24,gw=192.168.15.1
```

[pct(1) (proxmox.com)](https://pve.proxmox.com/pve-docs/pct.1.html)
TASK ERROR: unable to create CT 100 - unable to detect OS distribution
```
pct create 100 /mnt/ryzen-pve-storage/template/cache/openwrt-23.05.0-x86-64-rootfs.tar.gz \
--storage local-lvm \
--ostype unmanaged \
--unprivileged 1 \
--hostname op1 \
--rootfs local-lvm:8 \
--cores 4 \
--memory 1024 \
--swap 1024 \
--features keyctl=1,nesting=1

--password xxxx

```

```
pct create 700 local:vztmpl/openwrt-23.05.0-x86-64-generic-rootfs.tar.gz \
--storage local-zfs \
--ostype unmanaged \
--unprivileged 1 \
--hostname op1 \
--rootfs local-zfs:1 \
--cores 4 \
--memory 1024 \
--swap 0 \
--features keyctl=1,nesting=1
```

_unmanaged_ can be used to skip and OS specific setup
### 配置文件

```
/etc/pve/lxc/<CTID>.conf
```

Currently there are three types of mount points: storage backed mount points, bind mounts, and device mounts.
- Storage Backed Mount Points
    - Image based
    - ZFS subvolumes
    - Directories
```
pct set 100 -mp0 thin1:10,mp=/path/in/container
```

- Bind Mount Points：Bind mounts allow you to access arbitrary directories from your Proxmox VE host inside a container
```
pct set 100 -mp0 /mnt/bindmounts/shared,mp=/shared
```

### 特权容器

#### 特权容器转非特权容器

[Convert privileged to unprivileged container | Proxmox Support Forum](https://forum.proxmox.com/threads/convert-privileged-to-unprivileged-container.31066/)
```
pct restore 1234 var/lib/vz/dump/vzdump-lxc-1234-2016_03_02-02_31_03.tar.gz -ignore-unpack-errors 1 -unprivileged
```

转个特权级结果这么麻烦。[community](https://forum.proxmox.com/threads/convert-privileged-to-unprivileged-container.31066/post-261883)有通过挂载镜像，然后修改其内容的方法，但是看上去貌似有点野，因此还是不使用了。

尝试了
- 编辑配置文件直接添加unprivileged: yes。但是打开容器后，所有文件都变成了nobody。（也许手动chown以下就可以了？）
- 尝试按照官方通过backup恢复。
  - 但是恢复后，jellyfin docker启动不起来，貌似是权限的问题。jellyfin配置文件不知为何就是无法chown，root用户chown结果报没有权限。
```
pct restore 111 /var/lib/vz/dump/vzdump-lxc-110-2023_09_29-23_05_38.tar.zst -ignore-unpack-errors 1 -unprivileged --features keyctl=1,nesting=1  --storage local-zfs
```

算了，还是用原来特权容器。
### 路径映射（挂载）

参考
  - [Proxmox: bind mountpoint from host to unprivileged LXC container :: It's Embedded! (itsembedded.com)](https://itsembedded.com/sysadmin/proxmox_bind_unprivileged_lxc/)
  - [Unprivileged LXC containers - Proxmox VE](https://pve.proxmox.com/wiki/Unprivileged_LXC_containers)

Bind mounting：类似于目录的硬链接（linux目录不能硬链接）

直接映射（基本上只读）
- 需要重启容器生效
- host创建的文件在guest中为nobody（只要文件权限不严格，应该是可读的）
- guest创建的文件在host上为high-mapped(100000+)  uid
```
# pct命令
pct set 300 -mp0 /mnt/Disk2/BT/downloads/links,mp=/media

# 配置文件
mp0: /mnt/bindmounts/shared,mp=/shared
```
#### 用户映射

编辑容器配置文件
- 0 100000 1005表示0开始的1005长度段映射到host 10000开始1005长度段
- 以下配置将1005单独映射到host 1005
```
# uid map: from uid 0 map 1005 uids (in the ct) to the range starting 100000 (on the host), so 0..1004 (ct) → 100000..101004 (host)
lxc.idmap = u 0 100000 1005
lxc.idmap = g 0 100000 1005
# we map 1 uid starting from uid 1005 onto 1005, so 1005 → 1005
lxc.idmap = u 1005 1005 1
lxc.idmap = g 1005 1005 1
# we map the rest of 65535 from 1006 upto 101006, so 1006..65535 → 101006..165535
lxc.idmap = u 1006 101006 64530
lxc.idmap = g 1006 101006 64530
```

```
lxc.idmap = u 0 100000 1000
lxc.idmap = g 0 100000 1000
lxc.idmap = u 1000 1000 1
lxc.idmap = g 1000 1000 1
lxc.idmap = u 1001 101001 64534
lxc.idmap = g 1001 101001 64534
```

编辑/etc/suuid(subgid)，使得root用户允许使用1000的uid
```
root:100000:65536
root:1000:1
```
否则会报如下错误
```
lxc_map_ids: 3701 newuidmap failed to write mapping "newuidmap: uid range [1000-1001) -> [1000-1001) not allowed": newuidmap 793824 0 100000 1000 1000 1000 1 1001 101001 64534  
lxc_spawn: 1788 Failed to set up id mapping.  
__lxc_start: 2107  
TASK ERROR: startup for container '110' failed
```
### 添加gpu

容器配置文件中添加
```
lxc.cgroup2.devices.allow: c 226:0 rwm
lxc.cgroup2.devices.allow: c 226:128 rwm
lxc.cgroup2.devices.allow: c 29:0 rwm
lxc.mount.entry: /dev/dri dev/dri none bind,optional,create=dir
lxc.mount.entry: /dev/fb0 dev/fb0 none bind,optional,create=file
lxc.apparmor.profile: unconfined
```

lxc.cgroup2.devices.allow设置允许在LXC容器中使用的设备规则
- `c` 表示字符设备。
- `195:*` 是一个设备规则，它指定了一组允许的字符设备。在这里，`195` 是主设备号（major number），而 `*` 表示允许任何次设备号（minor number），这意味着允许使用主设备号为 195 的所有字符设备。
- `rwm` 表示权限设置，`r` 表示允许读取，`w` 表示允许写入，`m` 表示允许创建设备文件。

`lxc.mount.entry: /dev/dri dev/dri none bind,optional,create=dir`
- 这个配置条目将主机上的 `/dev/dri` 目录挂载到 LXC 容器内的 `dev/dri` 目录。
- `none` 表示没有特定的文件系统类型。
- `bind` 表示使用绑定挂载（bind mount），这意味着容器内的 `dev/dri` 目录会映射到主机上的 `/dev/dri` 目录，容器内的操作将影响到主机上的设备。
- `optional` 表示这个挂载是可选的，如果 `/dev/dri` 在主机上不存在，容器仍然会启动。
- `create=dir` 表示如果容器内的目录不存在，它将在容器内创建一个目录。
- `create=file` 表示如果容器内的文件不存在，它将在容器内创建一个文件

AppArmor 是一个 Linux 内核安全模块，用于限制程序的能力，包括容器，以增强安全性。
`lxc.apparmor.profile` 被设置为 "unconfined"，这意味着容器不受 AppArmor 个人资料的限制。它有更多自由，但也有较少的安全限制。

## 备份和恢复

[Backup and Restore - Proxmox VE](https://pve.proxmox.com/wiki/Backup_and_Restore)

LXC
```
 pct restore 100 vzdump-lxc-100-2023_10_03-15_38_23.tar.zst --storage local-zfs
```

qm
```

```

## PVE显卡直通

[PCI(e) Passthrough - Proxmox VE](https://pve.proxmox.com/wiki/PCI(e)_Passthrough)
[PCI Passthrough - Proxmox VE](https://pve.proxmox.com/wiki/PCI_Passthrough)
[(7) The Ultimate Beginner's Guide to GPU Passthrough (Proxmox, Windows 10) : homelab (reddit.com)](https://www.reddit.com/r/homelab/comments/b5xpua/the_ultimate_beginners_guide_to_gpu_passthrough/)
### 非grub修改内核参数方法

我使用zfs，pve8.0 root分区也位于zfs，使用systemd-boot引导。因此内核参数需要在`/etc/kernel/cmdline`修改。

- Grub：The kernel commandline needs to be placed in the variable GRUB_CMDLINE_LINUX_DEFAULT in the file `/etc/default/grub`. Running `update-grub` appends its content to all linux entries in /boot/grub/grub.cfg.
- Systemd-boot
  - The kernel commandline needs to be placed as one line in `/etc/kernel/cmdline`. To apply your changes, run `proxmox-boot-tool refresh`, which sets it as the option line for all config files in `loader/entries/proxmox-*.conf`.

### 步骤

#### 修改内核参数

*p.s grub和systemd-boot修改方法不一样，这里以systemd-boot为说明*

- `intel_iommu=on | amd_iommu=on`：For Intel CPUs, you may also need to enable the IOMMU on the [kernel command line](https://pve.proxmox.com/wiki/Host_Bootloader#sysboot_edit_kernel_cmdline) for older (pre-5.15) kernels. For AMD CPUs it should be enabled automatically.
- `iommu=pt`：If your hardware supports IOMMU passthrough mode, enabling this mode might increase performance.

- (optional)启用acs override

最后的内核参数
```
/etc/kernel/cmdline
root=ZFS=rpool/ROOT/pve-1 boot=zfs amd_iommu=on iommu=pt pcie_acs_override=downstream,multifunction
```

更新引导参数
`proxmox-boot-tool refresh`
#### kernel module

##### 设置尽早加载
保证以下module尽早加载，将其添加到`/etc/modules`
```
vfio
vfio_iommu_type1
vfio_pci
vfio_virqfd
```
##### 设置模块参数
修改一些内核模块的参数，位于`/etc/modprobe.d`

vifo.conf
- disable_vga后，pve启动时显示器会无法使用（vifo接管显卡后，屏幕便会卡住不变了）
```
options vfio-pci ids=10de:1b81,10de:10f0,10de:1c02,10de:10f1 disable_vga=1
```

kvm.conf
```
options kvm ignore_msrs=1 report_ignored_msrs=0
```

blacklist.conf
```
blacklist nouveau
blacklist nvidia*
```
##### 更新initramfs

每当修改内核模块后，需要重新生成initramfs。
`update-initramfs -u`
- u: update
- k: 指定一个内核版本或者all指定所有
### ACS override

[VFIO tips and tricks: VFIO+VGA FAQ](http://vfio.blogspot.com/2014/08/vfiovga-faq.html)
> pcie_acs_override =
>         [PCIE] Override missing PCIe ACS support for:
>     downstream
>         All downstream ports - full ACS capabilties
>     multifunction
>         All multifunction devices - multifunction ACS subset
>     id:nnnn:nnnn
>         Specfic device - full ACS capabilities
>         Specified as vid:did (vendor/device ID) in hex
### 遇到的问题

#### 第一张gpu直通问题

960（第一个槽），需要关闭显示器重启pve，才能正确工作。添加内核参数video=efifb:off后，连接显示器重启没问题？

> `video=efifb:off` and related kernel parameters don't work on Proxmox anymore. Use [this work-around](https://forum.proxmox.com/posts/478351/) when doing [passthrough](https://pve.proxmox.com/pve-docs/pve-admin-guide.html#qm_pci_passthrough) of the boot (or only) GPU.  
Also, `amd_iommu=on` really does nothing and `iommu=pt` does mostly nothing. And [not all](https://pve.proxmox.com/pve-docs/pve-admin-guide.html#sysboot_determine_bootloader_used) Proxmox installations use GRUB.

> What a nice post! I've been looking for a solution to this BAR 3 issues all night. Big Thanks!  
By the way, I also found better solution on a reddit post. It is adding "`initcall_blacklist=sysfb_init`" to kernel parameter. No need "`video=efifb:off`" or "`video=simplefb:off`" in kernel parameter. I also tested, it does solve the problem!  
Reference:  
[https://www.reddit.com/r/VFIO/comme...let_simplefb_stay_away_from_the_gpu/?sort=old](https://www.reddit.com/r/VFIO/comments/uud5sx/possible_to_let_simplefb_stay_away_from_the_gpu/?sort=old)  
[https://www.reddit.com/r/Proxmox/comments/vc9hw3/latest_proxmox_7_the_kernel_breaks_my_gpu/?sort=old](https://www.reddit.com/r/Proxmox/comments/vc9hw3/latest_proxmox_7_the_kernel_breaks_my_gpu/?sort=old)
#### amd 6500xt 43错误

给czw直通6500xt，结果即使安装完amd驱动后仍然报43错误。最后发现是AMD GPU的问题，需要关闭Resizable BAR/Smart Access Memory [https://pve.proxmox.com/wiki/PCI_Passthrough#BIOS_options](https://pve.proxmox.com/wiki/PCI_Passthrough#BIOS_options)  
> "Resizable BAR'/'Smart Access Memory': Some AMD GPUs (Vega and up) experience 'Code 43' in Windows guests if this is enabled on the host. It's not supported in VMs either way (yet), so the recommended setting is 'off'."

https://forum.proxmox.com/threads/gpu-passthrough-radeon-6800xt-and-beyond.86932/post-561971

总结
- 有用
  - 关闭bios csm和smart access memory
  - 添加内核参数`initcall_blacklist=sysfb_init`（`video=efifb:off`仍然保留），重启pve
- 无用
  - 我自己评论的：I firstly tryed another method, since driver 43 error is a common problem when using libvirt to create VM. see [ovmf arch wiki 43](https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF#Video_card_driver_virtualisation_detection).  So I did similar thing: edit guest qemu config file(/etc/pve/qemu-sever/ VM id.conf), modify cpu property to "cpu: host,hidden=1,hv-vender-id=123456789".

#### windows随机蓝屏BOSD

VIDEO_DXGKRNL
- 10来分钟就蓝屏，没有触发条件
- gfe安装最新驱动，安装完成时黑屏，只能在pve console里操作。
    - 可以再次点击快速安装安装驱动
    - 可以看到设备管理器中显卡报13错误
    - 重启后显示安装上了，但是如果重新安装又是以上步骤

尝试
- 关闭vnc, parsec, 小飞机等可能修改显卡的软件
- 勾上primay gpu
- 使用网上下载的msi 公版vbios，设置romfile参数[VGA Bios Collection: MSI GTX 1070 8 GB | TechPowerUp](https://www.techpowerup.com/vgabios/183948/msi-gtx1070-8192-160520)
- 安装studio驱动（仍然会有上面问题）


[Urgent Help, Windows 10 Crash!!! BSOD VIDEO_DXGKRNL_FATAL_ERROR | Proxmox Support Forum](https://forum.proxmox.com/threads/urgent-help-windows-10-crash-bsod-video_dxgkrnl_fatal_error.131828/)

把下面句子翻译成英文：
我遇到了完全一样的问题，我的win10虚拟机最近开始随机蓝屏。它过去3个星期是很正常的。我尝试了很多方法（reinstall win10, try win11, pass vbios rom file），问题仍没解决。直到我看到了你的帖子，我也尝试把CPU从host改为kvm64，问题居然神奇的解决了。

经过我之前非常多的尝试，我发现了一个能够稳定触发BOSD的方法，那就是使用GPU-Z软件导出GPU的vbios，每次确认导出时，win10系统就会蓝屏。

并且我也发现了一个不太正常的现象。GPU-Z只有在第一次打开时UEFI状态是勾上的，关闭GPU-Z软件然后再打开，UEFI就会变为未勾选状态。并打开GPU-Z软件几秒后，bus interface也会从PCIex16 3.0@x16 3.0变为 PCI。

在将CPU从host换成KVM64后，上面的问题就被解决了。GPU-Z UEFI和bus interface显示的都是正确的。


[VIDEO_DXGKRNL_FATAL_ERROR in a Windows VM - workarounds? | Proxmox Support Forum](https://forum.proxmox.com/threads/video_dxgkrnl_fatal_error-in-a-windows-vm-workarounds.94890/)
- 这个帖子认为是MSI这种软件读取了底层的不存在的寄存器导致系统崩溃


#### 43错误

1. 显卡驱动检测虚拟机
最早使用KVM创建虚拟机，遇到的便是这个。安装英伟达最新驱动即可
> Video card drivers by AMD incorporate very basic virtual machine detection targeting Hyper-V extensions. Should this detection mechanism trigger, the drivers will refuse to run, resulting in a black screen.
> Nvidia guest drivers prior to version 465 exhibited a similar behaviour which resulted in a generic error 43 in the card's device manager status. Systems using these older drivers therefore also need the above modification. In addition, they also require hiding the KVM CPU leaf

2. [Resizable Bar is turned on in the bios](https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF#Code_43_while_Resizable_Bar_is_turned_on_in_the_bios)

If you own a GPU that supports Resizable BAR / SAM and have the corresponding BIOS option enabled, you might get code 43 because this feature is disabled in QEMU [[11]](https://github.com/qemu/qemu/commit/3412d8ec9810b819f8b79e8e0c6b87217c876e32). Linux Kernel release 6.1 added option to manipulate PCIe Resizable BARs through [sysfs](https://en.wikipedia.org/wiki/sysfs "wikipedia:sysfs"), so you can try permanently resizing it using a [udev](https://wiki.archlinux.org/title/Udev "Udev") rule:
```
/etc/udev/rules.d/01-amd.rules

ACTION=="add", SUBSYSTEM=="pci", ATTR{vendor}=="0x1002", ATTR{device}=="0x73bf", ATTR{resource0_resize}="14"
ACTION=="add", SUBSYSTEM=="pci", ATTR{vendor}=="0x1002", ATTR{device}=="0x73bf", ATTR{resource2_resize}="8"
```

Alternatively, to temporarily resize the PCIe BAR, you can write the new size to `/sys/bus/pci/devices/_device_address_/resource_number__resize`, where _device_address_ is the address of your GPU, such as `0000:03:00.0` (note that for changing this parameter, no driver can be loaded for the device).

You can confirm values using `lspci -vvvxxxx`.

#### AMD reset bug

[Working around the AMD GPU Reset bug on Proxmox using vendor-reset – Nicholas Sherlock (nicksherlock.com)](https://www.nicksherlock.com/2020/11/working-around-the-amd-gpu-reset-bug-on-proxmox/)
> This is especially a problem if you only have one GPU in your system, because it will be your primary GPU and so be initialised by the host UEFI during boot, rendering it unusable for passthrough even a single time.

#### 6500xt性能很差

巫师三1080p只有几十fps，并且有时候跑benchmark时，vm会自动关机。

发现不能安装amd最新驱动，类似于芯片组不识别

- can't install amd adrenalin software
- [Unable to install AMD GPU Drivers in Windows guest VM - VM Engine (KVM) - Unraid](https://forums.unraid.net/topic/99447-unable-to-install-amd-gpu-drivers-in-windows-guest-vm/)

- BOSD问题
  - reset bug：Symptoms included the display going black and the GPU fans kicking on higher for no reason.[(7) Radeon Adrenaline Software installation kills the VM : VFIO (reddit.com)](https://www.reddit.com/r/VFIO/comments/jicm4c/radeon_adrenaline_software_installation_kills_the/)

仔细研究后发现，amd reset bug是指重启虚拟机后会黑屏，不是所有卡都会遇到该问题。
并且amd vendor reset github仓库并不支持6500xt。因此貌似和这里的问题无关。
### unbind gpu

未测试
[(2) Recover GPU from VM after it shuts down | Proxmox Support Forum](https://forum.proxmox.com/threads/recover-gpu-from-vm-after-it-shuts-down.126457/)
```
echo "0000:01:00.0" > "/sys/bus/pci/devices/0000:01:00.0/driver/unbind" && echo "0000:01:00.0" > "/sys/bus/pci/drivers/amdgpu/bind"
echo "0000:01:00.1" > "/sys/bus/pci/devices/0000:01:00.1/driver/unbind" && echo "0000:01:00.1" > "/sys/bus/pci/drivers/snd_hda_intel/bind"
```
### 资料收集

[Appendix G. Configuring a Host for PCI Passthrough Red Hat Virtualization 4.1 | Red Hat Customer Portal --- 附录 G. 为 PCI 直通配置主机 红帽虚拟化 4.1 |红帽客户门户](https://access.redhat.com/documentation/en-us/red_hat_virtualization/4.1/html/installation_guide/appe-configuring_a_hypervisor_host_for_pci_passthrough)

iommu=pt能够提高性能
If `intel_iommu=on` or `amd_iommu=on` works, you can try replacing them with `iommu=pt` or `amd_iommu=pt`. The `pt` option **only enables IOMMU for devices used in passthrough and will provide better host performance.** However, the option may not be supported on all hardware. Revert to previous option if the `pt` option doesn't work for your host.

allow_unsafe_interrupts选项
If the passthrough fails because the hardware does not support interrupt remapping, you can consider enabling the `allow_unsafe_interrupts` option if the virtual machines are trusted. The `allow_unsafe_interrupts` is not enabled by default because enabling it potentially exposes the host to MSI attacks from virtual machines. To enable the option:

#### redhat

[Product Documentation for Red Hat Virtualization 4.4 | Red Hat Customer Portal](https://access.redhat.com/documentation/en-us/red_hat_virtualization/4.4)
[Red Hat Virtualization 4.4 Setting up an NVIDIA GPU for a virtual machine in Red Hat Virtualization](https://access.redhat.com/documentation/en-us/red_hat_virtualization/4.4/pdf/setting_up_an_nvidia_gpu_for_a_virtual_machine_in_red_hat_virtualization/red_hat_virtualization-4.4-setting_up_an_nvidia_gpu_for_a_virtual_machine_in_red_hat_virtualization-en-us.pdf)

## 其它问题

### 直通AX200没有蓝牙（解决）

[[求助] VM直通AX210蓝牙遇到问题 - Chinese / 简体中文 - Unraid](https://forums.unraid.net/topic/120168-%E6%B1%82%E5%8A%A9-vm%E7%9B%B4%E9%80%9Aax210%E8%93%9D%E7%89%99%E9%81%87%E5%88%B0%E9%97%AE%E9%A2%98/)
- 看到别人都是lsusb能看到集成的蓝牙，但是我的没有。

[[SOLVED] No bluetooth adaptater on AX200 / Kernel & Hardware / Arch Linux Forums](https://bbs.archlinux.org/viewtopic.php?id=272643)
我的输出没有任何firware load的信息

```
root@ryzen-pve ➜  ~ dmesg | grep firm
[    0.512405] Spectre V2 : Enabling Restricted Speculation for firmware calls
[    7.689816] platform regulatory.0: Direct firmware load for regulatory.db failed with error -2

root@ryzen-pve ➜  ~ ls /lib/firmware |grep a0
iwlwifi-cc-a0-66.ucode.xz
iwlwifi-cc-a0-72.ucode.xz
```

我这里没有AX200 Bluetooth，这是别人的输出
```
[(16:36:45)xeph:~]lsusb
Bus 004 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus 003 Device 003: ID 8087:0029 Intel Corp. AX200 Bluetooth
Bus 003 Device 002: ID 046d:c52b Logitech, Inc. Unifying Receiver
Bus 003 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 002 Device 002: ID 05e3:0620 Genesys Logic, Inc. GL3523 Hub
Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus 001 Device 004: ID 048d:c101 Integrated Technology Express, Inc. ITE Device(8910)
Bus 001 Device 003: ID 13d3:56ff IMC Networks Integrated Camera
Bus 001 Device 002: ID 05e3:0610 Genesys Logic, Inc. Hub
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
```

感觉可能是因为绑定了vifo-pci导致的？
[Does anyone know how to pass through the Wi Fi 6 ax200 network card to a virtual machine with Kali Linux OS? - VM Engine (KVM) - Unraid --- 有谁知道如何通过Wi Fi 6 ax200网卡传递到带有Kali Linux操作系统的虚拟机？- 虚拟机引擎 （KVM） - 取消突袭](https://forums.unraid.net/topic/119920-does-anyone-know-how-to-pass-through-the-wi-fi-6-ax200-network-card-to-a-virtual-machine-with-kali-linux-os/)
[[6.10.0-RC1] Onboard Bluetooth no longer able to passthrough to VM - Prereleases - Unraid --- [6.10.0-RC1]板载蓝牙无法再直通到 VM - 售前赛 - 取消突袭](https://forums.unraid.net/bug-reports/prereleases/6100-rc1-onboard-bluetooth-no-longer-able-to-passthrough-to-vm-r1524/)

好像和我一样，蓝牙从usb中消失
[PVE 7.4 + Home Assistant: Intel AX200 Bluetooth issues | Proxmox Support Forum --- PVE 7.4 + 家庭助理： 英特尔 AX200 蓝牙问题 |Proxmox 支持论坛](https://forum.proxmox.com/threads/pve-7-4-home-assistant-intel-ax200-bluetooth-issues.126014/)

旧笔记本上的ax200 lsusb确实能看到设备



update：可能原因确实是绑定了vifo-pci，导致没有看到bluetooth。后面不知道怎么能看到usb蓝牙了。
但在win10虚拟机中，无法识别设备
解决方法为（如果无法移除，显示in use，那么就添加到blacklist中，然后重启host）
```
modprobe -r btusb
modprobe -r bluetooth
```
### 修改hostname寄

[Fix Proxmox Error after hostname/ip change (web-wilke.de)](https://web-wilke.de/fix-proxmox-error-after-hostname-ip-change/)
修改了hostname后，容器虚拟机都看不见了。尝试修改/etc/hosts但是不够，最后没弄好，还是改回原来的hostname了。

### 备份单个disk

zfs自己备份可以吗？
我创建的VM不知为何不支持快照。

[backup single disk in VM | Proxmox Support Forum](https://forum.proxmox.com/threads/backup-single-disk-in-vm.94543/)

### zerotier无法启动

[OpenVPN in LXC - Proxmox VE](https://pve.proxmox.com/wiki/OpenVPN_in_LXC)

特权容器或添加权限

```
vim /etc/pve/lxc/100.conf

...
onboot: 1
ostype: unmanaged
parent: basic
rootfs: local-zfs:subvol-100-disk-0,size=100G
swap: 0
unprivileged: 1
lxc.cgroup2.devices.allow: c 10:200 rwm
lxc.mount.entry: /dev/net dev/net none bind,create=dir

[basic]
#%E5%9F%BA%E6%9C%AC%E9%98%B2%E7%81%AB%E5%A2%99%EF%BC%8Cddns%EF%BC%8Cwg_s2s%E5%8F%AF%E4%BB%A5%E8%BF%9E%E6%8E%A5op1,op3
arch: amd64
cores: 2
hostname: op2
```

```
chown 100000:100000 /dev/net/tun
```

### 磁盘测速

ryzen虚拟机
#### pcie4.0 爱国者2T
```
➜  fio sudo fio --filename=test.bin ssd-win-likely.fio
seq-read-4m: (g=0): rw=read, bs=(R) 4096KiB-4096KiB, (W) 4096KiB-4096KiB, (T) 4096KiB-4096KiB, ioengine=libaio, iodepth=32
seq-write-4m: (g=1): rw=write, bs=(R) 4096KiB-4096KiB, (W) 4096KiB-4096KiB, (T) 4096KiB-4096KiB, ioengine=libaio, iodepth=32
rand-read-4k: (g=2): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=4
rand-write-4k: (g=3): rw=randwrite, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=4
fio-3.28
Starting 4 processes
seq-read-4m: Laying out IO file (1 file / 10240MiB)
Jobs: 1 (f=1): [_(3),w(1)][68.5%][w=80.5MiB/s][w=20.6k IOPS][eta 01m:10s]
seq-read-4m: (groupid=0, jobs=1): err= 0: pid=778450: Fri Sep 29 23:47:57 2023
  read: IOPS=556, BW=2226MiB/s (2334MB/s)(10.0GiB/4600msec)
    slat (usec): min=47, max=7932, avg=478.16, stdev=665.62
    clat (msec): min=8, max=162, avg=56.62, stdev=22.04
     lat (msec): min=8, max=162, avg=57.10, stdev=21.94
    clat percentiles (msec):
     |  1.00th=[   15],  5.00th=[   23], 10.00th=[   28], 20.00th=[   36],
     | 30.00th=[   44], 40.00th=[   51], 50.00th=[   59], 60.00th=[   64],
     | 70.00th=[   69], 80.00th=[   74], 90.00th=[   82], 95.00th=[   91],
     | 99.00th=[  131], 99.50th=[  142], 99.90th=[  159], 99.95th=[  161],
     | 99.99th=[  163]
   bw (  MiB/s): min= 1993, max= 2336, per=99.89%, avg=2223.66, stdev=118.21, samples=8
   iops        : min=  498, max=  584, avg=555.63, stdev=29.56, samples=8
  lat (msec)   : 10=0.08%, 20=3.01%, 50=36.45%, 100=58.32%, 250=2.15%
  cpu          : usr=0.89%, sys=25.74%, ctx=2221, majf=1, minf=32780
  IO depths    : 1=0.1%, 2=0.1%, 4=0.2%, 8=0.3%, 16=0.6%, 32=98.8%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.1%, 64=0.0%, >=64=0.0%
     issued rwts: total=2560,0,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=32
seq-write-4m: (groupid=1, jobs=1): err= 0: pid=778524: Fri Sep 29 23:47:57 2023
  write: IOPS=82, BW=330MiB/s (346MB/s)(10.0GiB/31034msec); 0 zone resets
    slat (usec): min=76, max=221964, avg=1061.67, stdev=5512.31
    clat (msec): min=4, max=7483, avg=385.10, stdev=1126.37
     lat (msec): min=5, max=7484, avg=386.16, stdev=1126.51
    clat percentiles (msec):
     |  1.00th=[   12],  5.00th=[   22], 10.00th=[   27], 20.00th=[   34],
     | 30.00th=[   43], 40.00th=[   52], 50.00th=[   64], 60.00th=[   74],
     | 70.00th=[   96], 80.00th=[  142], 90.00th=[  502], 95.00th=[ 2970],
     | 99.00th=[ 5604], 99.50th=[ 5604], 99.90th=[ 7483], 99.95th=[ 7483],
     | 99.99th=[ 7483]
   bw (  KiB/s): min=65667, max=2682078, per=100.00%, avg=823187.87, stdev=652362.03, samples=24
   iops        : min=   16, max=  654, avg=200.58, stdev=159.18, samples=24
  lat (msec)   : 10=0.82%, 20=2.77%, 50=34.80%, 100=32.73%, 250=15.51%
  lat (msec)   : 500=3.20%, 750=1.64%, 1000=0.55%, 2000=1.41%, >=2000=6.56%
  cpu          : usr=3.45%, sys=5.12%, ctx=1899, majf=0, minf=15
  IO depths    : 1=0.1%, 2=0.1%, 4=0.2%, 8=0.3%, 16=0.6%, 32=98.8%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.1%, 64=0.0%, >=64=0.0%
     issued rwts: total=0,2560,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=32
rand-read-4k: (groupid=2, jobs=1): err= 0: pid=778956: Fri Sep 29 23:47:57 2023
  read: IOPS=50.4k, BW=197MiB/s (207MB/s)(10.0GiB/51982msec)
    slat (nsec): min=1170, max=3868.5k, avg=4517.95, stdev=7664.76
    clat (nsec): min=220, max=1695.1M, avg=74038.40, stdev=2120026.59
     lat (usec): min=12, max=1695.1k, avg=78.64, stdev=2120.05
    clat percentiles (usec):
     |  1.00th=[   18],  5.00th=[   21], 10.00th=[   23], 20.00th=[   26],
     | 30.00th=[   33], 40.00th=[   76], 50.00th=[   81], 60.00th=[   84],
     | 70.00th=[   88], 80.00th=[   93], 90.00th=[  105], 95.00th=[  123],
     | 99.00th=[  210], 99.50th=[  293], 99.90th=[  627], 99.95th=[ 1074],
     | 99.99th=[ 1975]
   bw (  KiB/s): min= 5643, max=270960, per=100.00%, avg=205429.51, stdev=34312.15, samples=101
   iops        : min= 1410, max=67740, avg=51357.30, stdev=8578.07, samples=101
  lat (nsec)   : 250=0.01%, 500=0.01%, 750=0.01%, 1000=0.01%
  lat (usec)   : 2=0.01%, 10=0.01%, 20=4.52%, 50=32.03%, 100=50.56%
  lat (usec)   : 250=12.11%, 500=0.62%, 750=0.08%, 1000=0.02%
  lat (msec)   : 2=0.05%, 4=0.01%, 10=0.01%, 20=0.01%, 50=0.01%
  lat (msec)   : 500=0.01%, 2000=0.01%
  cpu          : usr=7.47%, sys=29.84%, ctx=1440214, majf=0, minf=21
  IO depths    : 1=0.1%, 2=0.1%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     issued rwts: total=2621440,0,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=4
rand-write-4k: (groupid=3, jobs=1): err= 0: pid=779798: Fri Sep 29 23:47:57 2023
  write: IOPS=20.3k, BW=79.1MiB/s (83.0MB/s)(4748MiB/60005msec); 0 zone resets
    slat (nsec): min=1270, max=418621k, avg=6166.83, stdev=381021.38
    clat (nsec): min=290, max=1815.5M, avg=190356.30, stdev=6618668.74
     lat (usec): min=16, max=1815.5k, avg=196.62, stdev=6629.88
    clat percentiles (usec):
     |  1.00th=[   21],  5.00th=[   26], 10.00th=[   30], 20.00th=[   52],
     | 30.00th=[   83], 40.00th=[   87], 50.00th=[   91], 60.00th=[   95],
     | 70.00th=[  102], 80.00th=[  120], 90.00th=[  188], 95.00th=[  318],
     | 99.00th=[ 1844], 99.50th=[ 2008], 99.90th=[ 4424], 99.95th=[ 7635],
     | 99.99th=[20579]
   bw (  KiB/s): min= 1920, max=185240, per=100.00%, avg=88600.73, stdev=62711.61, samples=108
   iops        : min=  480, max=46310, avg=22150.14, stdev=15677.91, samples=108
  lat (nsec)   : 500=0.01%, 750=0.01%, 1000=0.01%
  lat (usec)   : 2=0.01%, 4=0.01%, 10=0.01%, 20=0.63%, 50=19.19%
  lat (usec)   : 100=47.74%, 250=25.71%, 500=3.06%, 750=0.44%, 1000=0.25%
  lat (msec)   : 2=2.46%, 4=0.39%, 10=0.08%, 20=0.02%, 50=0.01%
  lat (msec)   : 100=0.01%, 500=0.01%, 750=0.01%, 1000=0.01%, 2000=0.01%
  cpu          : usr=2.85%, sys=12.76%, ctx=889109, majf=0, minf=17
  IO depths    : 1=0.1%, 2=0.1%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     issued rwts: total=0,1215500,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=4

Run status group 0 (all jobs):
   READ: bw=2226MiB/s (2334MB/s), 2226MiB/s-2226MiB/s (2334MB/s-2334MB/s), io=10.0GiB (10.7GB), run=4600-4600msec

Run status group 1 (all jobs):
  WRITE: bw=330MiB/s (346MB/s), 330MiB/s-330MiB/s (346MB/s-346MB/s), io=10.0GiB (10.7GB), run=31034-31034msec

Run status group 2 (all jobs):
   READ: bw=197MiB/s (207MB/s), 197MiB/s-197MiB/s (207MB/s-207MB/s), io=10.0GiB (10.7GB), run=51982-51982msec

Run status group 3 (all jobs):
  WRITE: bw=79.1MiB/s (83.0MB/s), 79.1MiB/s-79.1MiB/s (83.0MB/s-83.0MB/s), io=4748MiB (4979MB), run=60005-60005msec

Disk stats (read/write):
  sdb: ios=2641793/1235910, merge=38/87, ticks=1077282/5674545, in_queue=6778554, util=94.90%
```

#### 三星981at
```
➜  fio sudo fio --directory=/root/ --filename=test.bin ssd-win-likely.fio
seq-read-4m: (g=0): rw=read, bs=(R) 4096KiB-4096KiB, (W) 4096KiB-4096KiB, (T) 4096KiB-4096KiB, ioengine=libaio, iodepth=32
seq-write-4m: (g=1): rw=write, bs=(R) 4096KiB-4096KiB, (W) 4096KiB-4096KiB, (T) 4096KiB-4096KiB, ioengine=libaio, iodepth=32
rand-read-4k: (g=2): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=4
rand-write-4k: (g=3): rw=randwrite, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=4
fio-3.28
Starting 4 processes
seq-read-4m: Laying out IO file (1 file / 10240MiB)
Jobs: 1 (f=0): [_(3),f(1)][100.0%][w=69.1MiB/s][w=17.7k IOPS][eta 00m:00s]
seq-read-4m: (groupid=0, jobs=1): err= 0: pid=787066: Fri Sep 29 23:56:40 2023
  read: IOPS=460, BW=1841MiB/s (1930MB/s)(10.0GiB/5563msec)
    slat (usec): min=53, max=9744, avg=478.53, stdev=703.84
    clat (msec): min=9, max=889, avg=68.36, stdev=87.28
     lat (msec): min=10, max=889, avg=68.84, stdev=87.24
    clat percentiles (msec):
     |  1.00th=[   16],  5.00th=[   23], 10.00th=[   28], 20.00th=[   36],
     | 30.00th=[   43], 40.00th=[   51], 50.00th=[   59], 60.00th=[   67],
     | 70.00th=[   74], 80.00th=[   82], 90.00th=[   91], 95.00th=[  106],
     | 99.00th=[  743], 99.50th=[  885], 99.90th=[  885], 99.95th=[  885],
     | 99.99th=[  894]
   bw (  MiB/s): min=  945, max= 2324, per=100.00%, avg=1988.74, stdev=387.84, samples=10
   iops        : min=  236, max=  581, avg=496.70, stdev=96.92, samples=10
  lat (msec)   : 10=0.04%, 20=2.54%, 50=36.60%, 100=54.69%, 250=4.92%
  lat (msec)   : 750=0.39%, 1000=0.82%
  cpu          : usr=0.58%, sys=21.22%, ctx=2383, majf=0, minf=32780
  IO depths    : 1=0.1%, 2=0.1%, 4=0.2%, 8=0.3%, 16=0.6%, 32=98.8%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.1%, 64=0.0%, >=64=0.0%
     issued rwts: total=2560,0,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=32
seq-write-4m: (groupid=1, jobs=1): err= 0: pid=787186: Fri Sep 29 23:56:40 2023
  write: IOPS=235, BW=940MiB/s (986MB/s)(10.0GiB/10890msec); 0 zone resets
    slat (usec): min=69, max=73786, avg=783.64, stdev=3051.53
    clat (msec): min=2, max=2041, avg=135.28, stdev=287.50
     lat (msec): min=2, max=2042, avg=136.06, stdev=287.42
    clat percentiles (msec):
     |  1.00th=[   14],  5.00th=[   21], 10.00th=[   27], 20.00th=[   36],
     | 30.00th=[   46], 40.00th=[   57], 50.00th=[   68], 60.00th=[   83],
     | 70.00th=[  102], 80.00th=[  126], 90.00th=[  182], 95.00th=[  326],
     | 99.00th=[ 2022], 99.50th=[ 2022], 99.90th=[ 2039], 99.95th=[ 2039],
     | 99.99th=[ 2039]
   bw (  MiB/s): min=  370, max= 2341, per=100.00%, avg=1198.88, stdev=516.41, samples=16
   iops        : min=   92, max=  585, avg=299.31, stdev=129.04, samples=16
  lat (msec)   : 4=0.20%, 10=0.55%, 20=4.14%, 50=29.77%, 100=34.84%
  lat (msec)   : 250=24.14%, 500=2.30%, 750=1.05%, 2000=1.76%, >=2000=1.25%
  cpu          : usr=7.14%, sys=12.19%, ctx=1959, majf=0, minf=14
  IO depths    : 1=0.1%, 2=0.1%, 4=0.2%, 8=0.3%, 16=0.6%, 32=98.8%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.1%, 64=0.0%, >=64=0.0%
     issued rwts: total=0,2560,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=32
rand-read-4k: (groupid=2, jobs=1): err= 0: pid=787189: Fri Sep 29 23:56:40 2023
  read: IOPS=42.8k, BW=167MiB/s (175MB/s)(9.79GiB/60001msec)
    slat (nsec): min=1180, max=378282k, avg=4607.87, stdev=236197.07
    clat (nsec): min=240, max=1725.2M, avg=87451.41, stdev=4192102.00
     lat (usec): min=12, max=1725.2k, avg=92.80, stdev=4327.60
    clat percentiles (usec):
     |  1.00th=[   18],  5.00th=[   21], 10.00th=[   22], 20.00th=[   26],
     | 30.00th=[   30], 40.00th=[   47], 50.00th=[   92], 60.00th=[   96],
     | 70.00th=[   99], 80.00th=[  104], 90.00th=[  115], 95.00th=[  129],
     | 99.00th=[  212], 99.50th=[  306], 99.90th=[  578], 99.95th=[  742],
     | 99.99th=[ 1893]
   bw (  KiB/s): min=13755, max=264232, per=100.00%, avg=183324.63, stdev=52285.27, samples=111
   iops        : min= 3438, max=66058, avg=45831.09, stdev=13071.34, samples=111
  lat (nsec)   : 250=0.01%, 500=0.01%, 750=0.01%, 1000=0.01%
  lat (usec)   : 2=0.01%, 4=0.01%, 10=0.01%, 20=4.54%, 50=35.97%
  lat (usec)   : 100=31.58%, 250=27.11%, 500=0.66%, 750=0.10%, 1000=0.03%
  lat (msec)   : 2=0.01%, 4=0.01%, 10=0.01%, 20=0.01%, 50=0.01%
  lat (msec)   : 500=0.01%, 750=0.01%, 1000=0.01%, 2000=0.01%
  cpu          : usr=7.24%, sys=27.70%, ctx=1476701, majf=0, minf=20
  IO depths    : 1=0.1%, 2=0.1%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     issued rwts: total=2567447,0,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=4
rand-write-4k: (groupid=3, jobs=1): err= 0: pid=788193: Fri Sep 29 23:56:40 2023
  write: IOPS=30.2k, BW=118MiB/s (124MB/s)(7081MiB/60001msec); 0 zone resets
    slat (nsec): min=1260, max=40475k, avg=6308.96, stdev=55626.04
    clat (nsec): min=300, max=1630.1M, avg=125086.99, stdev=2894812.01
     lat (usec): min=17, max=1630.1k, avg=131.50, stdev=2895.61
    clat percentiles (usec):
     |  1.00th=[   21],  5.00th=[   25], 10.00th=[   29], 20.00th=[   49],
     | 30.00th=[   94], 40.00th=[   98], 50.00th=[  101], 60.00th=[  105],
     | 70.00th=[  111], 80.00th=[  119], 90.00th=[  149], 95.00th=[  221],
     | 99.00th=[  498], 99.50th=[  758], 99.90th=[ 3163], 99.95th=[ 6063],
     | 99.99th=[23725]
   bw (  KiB/s): min=10431, max=171952, per=100.00%, avg=122835.52, stdev=47622.27, samples=112
   iops        : min= 2607, max=42988, avg=30708.83, stdev=11905.58, samples=112
  lat (nsec)   : 500=0.01%, 750=0.01%, 1000=0.01%
  lat (usec)   : 2=0.01%, 4=0.01%, 10=0.01%, 20=0.73%, 50=19.45%
  lat (usec)   : 100=25.98%, 250=49.77%, 500=3.06%, 750=0.49%, 1000=0.19%
  lat (msec)   : 2=0.17%, 4=0.07%, 10=0.05%, 20=0.02%, 50=0.01%
  lat (msec)   : 100=0.01%, 250=0.01%, 750=0.01%, 2000=0.01%
  cpu          : usr=4.53%, sys=20.36%, ctx=1376235, majf=0, minf=16
  IO depths    : 1=0.1%, 2=0.1%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     issued rwts: total=0,1812637,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=4

Run status group 0 (all jobs):
   READ: bw=1841MiB/s (1930MB/s), 1841MiB/s-1841MiB/s (1930MB/s-1930MB/s), io=10.0GiB (10.7GB), run=5563-5563msec

Run status group 1 (all jobs):
  WRITE: bw=940MiB/s (986MB/s), 940MiB/s-940MiB/s (986MB/s-986MB/s), io=10.0GiB (10.7GB), run=10890-10890msec

Run status group 2 (all jobs):
   READ: bw=167MiB/s (175MB/s), 167MiB/s-167MiB/s (175MB/s-175MB/s), io=9.79GiB (10.5GB), run=60001-60001msec

Run status group 3 (all jobs):
  WRITE: bw=118MiB/s (124MB/s), 118MiB/s-118MiB/s (124MB/s-124MB/s), io=7081MiB (7425MB), run=60001-60001msec

Disk stats (read/write):
  sda: ios=2588374/1830074, merge=92/389, ticks=1241127/2284278, in_queue=3529480, util=95.33%
```

#### n5105 铠侠rc20 500GB
```
root@n5105-pve ➜  fio fio --filename=test.bin ssd-win-likely.fio
seq-read-4m: (g=0): rw=read, bs=(R) 4096KiB-4096KiB, (W) 4096KiB-4096KiB, (T) 4096KiB-4096KiB, ioengine=libaio, iodepth=32
seq-write-4m: (g=1): rw=write, bs=(R) 4096KiB-4096KiB, (W) 4096KiB-4096KiB, (T) 4096KiB-4096KiB, ioengine=libaio, iodepth=32
rand-read-4k: (g=2): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=4
rand-write-4k: (g=3): rw=randwrite, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=4
fio-3.33
Starting 4 processes
Jobs: 1 (f=1): [_(3),w(1)][59.0%][w=3081KiB/s][w=770 IOPS][eta 02m:19s]
seq-read-4m: (groupid=0, jobs=1): err= 0: pid=422690: Sat Sep 30 00:46:36 2023
  read: IOPS=140, BW=560MiB/s (588MB/s)(10.0GiB/18274msec)
    slat (usec): min=5966, max=22258, avg=7123.69, stdev=945.70
    clat (usec): min=13, max=331888, avg=219709.66, stdev=21151.42
     lat (msec): min=6, max=338, avg=226.83, stdev=21.36
    clat percentiles (msec):
     |  1.00th=[  180],  5.00th=[  209], 10.00th=[  211], 20.00th=[  213],
     | 30.00th=[  218], 40.00th=[  218], 50.00th=[  220], 60.00th=[  222],
     | 70.00th=[  222], 80.00th=[  222], 90.00th=[  226], 95.00th=[  232],
     | 99.00th=[  296], 99.50th=[  330], 99.90th=[  330], 99.95th=[  330],
     | 99.99th=[  334]
   bw (  KiB/s): min=357840, max=614400, per=99.09%, avg=568612.03, stdev=44133.11, samples=36
   iops        : min=   87, max=  150, avg=138.75, stdev=10.82, samples=36
  lat (usec)   : 20=0.04%
  lat (msec)   : 10=0.04%, 20=0.04%, 50=0.20%, 100=0.23%, 250=95.62%
  lat (msec)   : 500=3.83%
  cpu          : usr=0.33%, sys=26.03%, ctx=10676, majf=0, minf=32779
  IO depths    : 1=0.1%, 2=0.1%, 4=0.2%, 8=0.3%, 16=0.6%, 32=98.8%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.1%, 64=0.0%, >=64=0.0%
     issued rwts: total=2560,0,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=32
seq-write-4m: (groupid=1, jobs=1): err= 0: pid=447378: Sat Sep 30 00:46:36 2023
  write: IOPS=29, BW=118MiB/s (123MB/s)(7168MiB/60944msec); 0 zone resets
    slat (usec): min=1337, max=3922.2k, avg=33986.69, stdev=277349.50
    clat (usec): min=13, max=4661.5k, avg=1053752.98, stdev=1375122.08
     lat (msec): min=54, max=4680, avg=1087.74, stdev=1395.81
    clat percentiles (msec):
     |  1.00th=[   63],  5.00th=[   88], 10.00th=[  105], 20.00th=[  109],
     | 30.00th=[  144], 40.00th=[  205], 50.00th=[  262], 60.00th=[  531],
     | 70.00th=[ 1028], 80.00th=[ 2970], 90.00th=[ 3574], 95.00th=[ 3809],
     | 99.00th=[ 4530], 99.50th=[ 4597], 99.90th=[ 4665], 99.95th=[ 4665],
     | 99.99th=[ 4665]
   bw (  KiB/s): min= 8208, max=787386, per=100.00%, avg=306489.37, stdev=235225.24, samples=46
   iops        : min=    2, max=  192, avg=74.54, stdev=57.29, samples=46
  lat (usec)   : 20=0.06%
  lat (msec)   : 100=8.37%, 250=37.67%, 500=13.06%, 750=3.18%, 1000=6.19%
  lat (msec)   : 2000=10.71%, >=2000=20.76%
  cpu          : usr=0.86%, sys=5.95%, ctx=26464, majf=0, minf=12
  IO depths    : 1=0.1%, 2=0.1%, 4=0.2%, 8=0.4%, 16=0.9%, 32=98.3%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=99.9%, 8=0.0%, 16=0.0%, 32=0.1%, 64=0.0%, >=64=0.0%
     issued rwts: total=0,1792,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=32
rand-read-4k: (groupid=2, jobs=1): err= 0: pid=449479: Sat Sep 30 00:46:36 2023
  read: IOPS=2352, BW=9409KiB/s (9634kB/s)(551MiB/60001msec)
    slat (usec): min=6, max=24639, avg=421.40, stdev=272.49
    clat (usec): min=2, max=36072, avg=1277.22, stdev=607.71
     lat (usec): min=374, max=42067, avg=1698.61, stdev=744.53
    clat percentiles (usec):
     |  1.00th=[  996],  5.00th=[ 1037], 10.00th=[ 1074], 20.00th=[ 1106],
     | 30.00th=[ 1139], 40.00th=[ 1156], 50.00th=[ 1188], 60.00th=[ 1237],
     | 70.00th=[ 1287], 80.00th=[ 1352], 90.00th=[ 1483], 95.00th=[ 1614],
     | 99.00th=[ 2507], 99.50th=[ 3032], 99.90th=[12518], 99.95th=[15401],
     | 99.99th=[17695]
   bw (  KiB/s): min= 1744, max=10080, per=99.99%, avg=9408.22, stdev=1395.59, samples=119
   iops        : min=  436, max= 2520, avg=2351.96, stdev=348.88, samples=119
  lat (usec)   : 4=0.01%, 500=0.01%, 750=0.03%, 1000=1.37%
  lat (msec)   : 2=96.73%, 4=1.58%, 10=0.15%, 20=0.14%, 50=0.01%
  cpu          : usr=0.87%, sys=9.69%, ctx=141627, majf=0, minf=13
  IO depths    : 1=0.1%, 2=0.1%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     issued rwts: total=141132,0,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=4
rand-write-4k: (groupid=3, jobs=1): err= 0: pid=505899: Sat Sep 30 00:46:36 2023
  write: IOPS=776, BW=3105KiB/s (3179kB/s)(182MiB/60001msec); 0 zone resets
    slat (usec): min=8, max=64884, avg=1276.50, stdev=1138.90
    clat (usec): min=4, max=125427, avg=3870.75, stdev=2918.05
     lat (usec): min=760, max=168093, avg=5147.25, stdev=3727.98
    clat percentiles (usec):
     |  1.00th=[  1680],  5.00th=[  2147], 10.00th=[  2245], 20.00th=[  2376],
     | 30.00th=[  2507], 40.00th=[  2704], 50.00th=[  3032], 60.00th=[  3982],
     | 70.00th=[  4817], 80.00th=[  5407], 90.00th=[  5997], 95.00th=[  6521],
     | 99.00th=[  8848], 99.50th=[ 11338], 99.90th=[ 31065], 99.95th=[ 66323],
     | 99.99th=[110625]
   bw (  KiB/s): min= 1405, max= 5016, per=99.72%, avg=3096.45, stdev=976.25, samples=119
   iops        : min=  351, max= 1254, avg=774.01, stdev=244.12, samples=119
  lat (usec)   : 10=0.01%, 750=0.01%, 1000=0.01%
  lat (msec)   : 2=1.54%, 4=58.60%, 10=39.19%, 20=0.46%, 50=0.12%
  lat (msec)   : 100=0.03%, 250=0.03%
  cpu          : usr=0.77%, sys=8.83%, ctx=99364, majf=0, minf=10
  IO depths    : 1=0.1%, 2=0.1%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     issued rwts: total=0,46570,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=4

Run status group 0 (all jobs):
   READ: bw=560MiB/s (588MB/s), 560MiB/s-560MiB/s (588MB/s-588MB/s), io=10.0GiB (10.7GB), run=18274-18274msec

Run status group 1 (all jobs):
  WRITE: bw=118MiB/s (123MB/s), 118MiB/s-118MiB/s (123MB/s-123MB/s), io=7168MiB (7516MB), run=60944-60944msec

Run status group 2 (all jobs):
   READ: bw=9409KiB/s (9634kB/s), 9409KiB/s-9409KiB/s (9634kB/s-9634kB/s), io=551MiB (578MB), run=60001-60001msec

Run status group 3 (all jobs):
  WRITE: bw=3105KiB/s (3179kB/s), 3105KiB/s-3105KiB/s (3179kB/s-3179kB/s), io=182MiB (191MB), run=60001-60001msec
```

#### pci subvendor id

```
cat /sys/bus/pci/devices/*/uevent
```